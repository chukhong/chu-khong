"use strict";var TokenIterator=require("../token_iterator").TokenIterator,Range=require("../range").Range;function BracketMatch(){this.findMatchingBracket=function(e,r){return 0!=e.column&&""!=(r=r||this.getLine(e.row).charAt(e.column-1))&&(r=r.match(/([\(\[\{])|([\)\]\}])/))?r[1]?this.$findClosingBracket(r[1],e):this.$findOpeningBracket(r[2],e):null},this.getBracketRange=function(e){var r,n,t=this.getLine(e.row),o=!0,a=t.charAt(e.column-1),c=a&&a.match(/([\(\[\{])|([\)\]\}])/);if(c||(a=t.charAt(e.column),e={row:e.row,column:e.column+1},c=a&&a.match(/([\(\[\{])|([\)\]\}])/),o=!1),!c)return null;if(c[1]){if(!(n=this.$findClosingBracket(c[1],e)))return null;r=Range.fromPoints(e,n),o||(r.end.column++,r.start.column--),r.cursor=r.end}else{if(!(n=this.$findOpeningBracket(c[2],e)))return null;r=Range.fromPoints(n,e),o||(r.start.column++,r.end.column--),r.cursor=r.start}return r},this.getMatchingBracketRanges=function(e){var r=this.getLine(e.row),n=r.charAt(e.column-1),t=n&&n.match(/([\(\[\{])|([\)\]\}])/);return t||(n=r.charAt(e.column),e={row:e.row,column:e.column+1},t=n&&n.match(/([\(\[\{])|([\)\]\}])/)),t?(r=new Range(e.row,e.column-1,e.row,e.column),(n=t[1]?this.$findClosingBracket(t[1],e):this.$findOpeningBracket(t[2],e))?[r,new Range(n.row,n.column,n.row,n.column+1)]:[r]):null},this.$brackets={")":"(","(":")","]":"[","[":"]","{":"}","}":"{","<":">",">":"<"},this.$findOpeningBracket=function(e,r,n){var t=this.$brackets[e],o=1,a=new TokenIterator(this,r.row,r.column),c=a.getCurrentToken();if(c=c||a.stepForward()){n=n||new RegExp("(\\.?"+c.type.replace(".","\\.").replace("rparen",".paren").replace(/\b(?:end)\b/,"(?:start|begin|end)")+")+");for(var u=r.column-a.getCurrentTokenColumn()-2,i=c.value;;){for(;0<=u;){var l=i.charAt(u);if(l==t){if(0==--o)return{row:a.getCurrentTokenRow(),column:u+a.getCurrentTokenColumn()}}else l==e&&(o+=1);--u}for(;(c=a.stepBackward())&&!n.test(c.type););if(null==c)break;u=(i=c.value).length-1}return null}},this.$findClosingBracket=function(e,r,n){var t=this.$brackets[e],o=1,a=new TokenIterator(this,r.row,r.column),c=a.getCurrentToken();if(c=c||a.stepForward()){n=n||new RegExp("(\\.?"+c.type.replace(".","\\.").replace("lparen",".paren").replace(/\b(?:start|begin)\b/,"(?:start|begin|end)")+")+");for(var u=r.column-a.getCurrentTokenColumn();;){for(var i=c.value,l=i.length;u<l;){var s=i.charAt(u);if(s==t){if(0==--o)return{row:a.getCurrentTokenRow(),column:u+a.getCurrentTokenColumn()}}else s==e&&(o+=1);u+=1}for(;(c=a.stepForward())&&!n.test(c.type););if(null==c)break;u=0}return null}}}exports.BracketMatch=BracketMatch;