"use strict";var Range=require("../range").Range;function FoldLine(t,n){this.foldData=t,Array.isArray(n)?this.folds=n:n=this.folds=[n];t=n[n.length-1];this.range=new Range(n[0].start.row,n[0].start.column,t.end.row,t.end.column),this.start=this.range.start,this.end=this.range.end,this.folds.forEach(function(t){t.setFoldLine(this)},this)}!function(){this.shiftRow=function(n){this.start.row+=n,this.end.row+=n,this.folds.forEach(function(t){t.start.row+=n,t.end.row+=n})},this.addFold=function(t){if(t.sameRow){if(t.start.row<this.startRow||t.endRow>this.endRow)throw new Error("Can't add a fold to this FoldLine as it has no connection");this.folds.push(t),this.folds.sort(function(t,n){return-t.range.compareEnd(n.start.row,n.start.column)}),0<this.range.compareEnd(t.start.row,t.start.column)?(this.end.row=t.end.row,this.end.column=t.end.column):this.range.compareStart(t.end.row,t.end.column)<0&&(this.start.row=t.start.row,this.start.column=t.start.column)}else if(t.start.row==this.end.row)this.folds.push(t),this.end.row=t.end.row,this.end.column=t.end.column;else{if(t.end.row!=this.start.row)throw new Error("Trying to add fold to FoldRow that doesn't have a matching row");this.folds.unshift(t),this.start.row=t.start.row,this.start.column=t.start.column}t.foldLine=this},this.containsRow=function(t){return t>=this.start.row&&t<=this.end.row},this.walk=function(t,n,o){var r,s,i=0,e=this.folds,l=!0;null==n&&(n=this.end.row,o=this.end.column);for(var d=0;d<e.length;d++){if(-1==(s=(r=e[d]).range.compareStart(n,o)))return void t(null,n,o,i,l);if(!t(null,r.start.row,r.start.column,i,l)&&t(r.placeholder,r.start.row,r.start.column,i)||0===s)return;l=!r.sameRow,i=r.end.column}t(null,n,o,i,l)},this.getNextFoldTo=function(t,n){for(var o,r,s=0;s<this.folds.length;s++){if(-1==(r=(o=this.folds[s]).range.compareEnd(t,n)))return{fold:o,kind:"after"};if(0===r)return{fold:o,kind:"inside"}}return null},this.addRemoveChars=function(t,n,o){var r,s=this.getNextFoldTo(t,n);if(s)if(r=s.fold,"inside"==s.kind&&r.start.column!=n&&r.start.row!=t)window.console&&window.console.log(t,n,r);else if(r.start.row==t){var i,e=(i=this.folds).indexOf(r);for(0===e&&(this.start.column+=o);e<i.length;e++){if((r=i[e]).start.column+=o,!r.sameRow)return;r.end.column+=o}this.end.column+=o}},this.split=function(t,n){var o,r,t=this.getNextFoldTo(t,n);return t&&"inside"!=t.kind?(n=t.fold,t=this.folds,o=this.foldData,n=t.indexOf(n),r=t[n-1],this.end.row=r.end.row,this.end.column=r.end.column,r=new FoldLine(o,t=t.splice(n,t.length-n)),o.splice(o.indexOf(this)+1,0,r),r):null},this.merge=function(t){for(var n=t.folds,o=0;o<n.length;o++)this.addFold(n[o]);var r=this.foldData;r.splice(r.indexOf(t),1)},this.toString=function(){var n=[this.range.toString()+": ["];return this.folds.forEach(function(t){n.push("  "+t.toString())}),n.push("]"),n.join("\n")},this.idxToPosition=function(t){for(var n=0,o=0;o<this.folds.length;o++){var r=this.folds[o];if((t-=r.start.column-n)<0)return{row:r.start.row,column:r.start.column+t};if((t-=r.placeholder.length)<0)return r.start;n=r.end.column}return{row:this.end.row,column:this.end.column+t}}}.call(FoldLine.prototype),exports.FoldLine=FoldLine;