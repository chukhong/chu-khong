"use strict";var Range=require("../range").Range,FoldLine=require("./fold_line").FoldLine,Fold=require("./fold").Fold,TokenIterator=require("../token_iterator").TokenIterator;function Folding(){this.getFoldAt=function(t,e,n){var i=this.getFoldLine(t);if(!i)return null;for(var o=i.folds,r=0;r<o.length;r++){var s=o[r].range;if(s.contains(t,e)&&(1!=n||!s.isEnd(t,e)||s.isEmpty())&&(-1!=n||!s.isStart(t,e)||s.isEmpty()))return o[r]}},this.getFoldsInRange=function(t){var e=t.start,n=t.end,i=this.$foldData,o=[];e.column+=1,--n.column;for(var r=0;r<i.length;r++){var s=i[r].range.compareRange(t);if(2!=s){if(-2==s)break;for(var l=i[r].folds,d=0;d<l.length;d++){var a=l[d];if(-2==(s=a.range.compareRange(t)))break;if(2!=s){if(42==s)break;o.push(a)}}}}return--e.column,n.column+=1,o},this.getFoldsInRangeList=function(t){var e;return Array.isArray(t)?(e=[],t.forEach(function(t){e=e.concat(this.getFoldsInRange(t))},this)):e=this.getFoldsInRange(t),e},this.getAllFolds=function(){for(var t=[],e=this.$foldData,n=0;n<e.length;n++)for(var i=0;i<e[n].folds.length;i++)t.push(e[n].folds[i]);return t},this.getFoldStringAt=function(t,e,n,i){if(!(i=i||this.getFoldLine(t)))return null;for(var o,r={end:{column:0}},s=0;s<i.folds.length;s++){var l,d=(l=i.folds[s]).range.compareEnd(t,e);if(-1==d){o=this.getLine(l.start.row).substring(r.end.column,l.start.column);break}if(0===d)return null;r=l}return o=o||this.getLine(l.start.row).substring(r.end.column),-1==n?o.substring(0,e-r.end.column):1==n?o.substring(e-r.end.column):o},this.getFoldLine=function(t,e){var n=this.$foldData,i=0;for(-1==(i=e?n.indexOf(e):i)&&(i=0);i<n.length;i++){var o=n[i];if(o.start.row<=t&&o.end.row>=t)return o;if(o.end.row>t)return null}return null},this.getNextFoldLine=function(t,e){var n=this.$foldData,i=0;for(-1==(i=e?n.indexOf(e):i)&&(i=0);i<n.length;i++){var o=n[i];if(o.end.row>=t)return o}return null},this.getFoldedRowCount=function(t,e){for(var n=this.$foldData,i=e-t+1,o=0;o<n.length;o++){var r=n[o],s=r.end.row,r=r.start.row;if(e<=s){r<e&&(t<=r?i-=e-r:i=0);break}t<=s&&(i-=t<=r?s-r:s-t+1)}return i},this.$addFoldLine=function(t){return this.$foldData.push(t),this.$foldData.sort(function(t,e){return t.start.row-e.start.row}),t},this.addFold=function(t,e){var n,i=this.$foldData,o=!1,r=(t instanceof Fold?n=t:(n=new Fold(e,t)).collapseChildren=e.collapseChildren,this.$clipRangeToDocument(n.range),n.start.row),t=n.start.column,s=n.end.row,e=n.end.column,l=this.getFoldAt(r,t,1),d=this.getFoldAt(s,e,-1);if(l&&d==l)return l.addSubFold(n);l&&!l.range.isStart(r,t)&&this.removeFold(l),d&&!d.range.isEnd(s,e)&&this.removeFold(d);t=this.getFoldsInRange(n.range);0<t.length&&(this.removeFolds(t),n.collapseChildren||t.forEach(function(t){n.addSubFold(t)}));for(var a=0;a<i.length;a++){var h=i[a];if(s==h.start.row){h.addFold(n),o=!0;break}if(r==h.end.row){if(h.addFold(n),o=!0,!n.sameRow){var g=i[a+1];if(g&&g.start.row==s){h.merge(g);break}}break}if(s<=h.start.row)break}return o||(h=this.$addFoldLine(new FoldLine(this.$foldData,n))),this.$useWrapMode?this.$updateWrapData(h.start.row,h.start.row):this.$updateRowLengthCache(h.start.row,h.start.row),this.$modified=!0,this._signal("changeFold",{data:n,action:"add"}),n},this.addFolds=function(t){t.forEach(function(t){this.addFold(t)},this)},this.removeFold=function(t){var e=t.foldLine,n=e.start.row,i=e.end.row,o=this.$foldData,r=e.folds;1==r.length?o.splice(o.indexOf(e),1):e.range.isEnd(t.end.row,t.end.column)?(r.pop(),e.end.row=r[r.length-1].end.row,e.end.column=r[r.length-1].end.column):e.range.isStart(t.start.row,t.start.column)?(r.shift(),e.start.row=r[0].start.row,e.start.column=r[0].start.column):t.sameRow?r.splice(r.indexOf(t),1):((r=(o=e.split(t.start.row,t.start.column)).folds).shift(),o.start.row=r[0].start.row,o.start.column=r[0].start.column),this.$updating||(this.$useWrapMode?this.$updateWrapData(n,i):this.$updateRowLengthCache(n,i)),this.$modified=!0,this._signal("changeFold",{data:t,action:"remove"})},this.removeFolds=function(t){for(var e=[],n=0;n<t.length;n++)e.push(t[n]);e.forEach(function(t){this.removeFold(t)},this),this.$modified=!0},this.expandFold=function(e){this.removeFold(e),e.subFolds.forEach(function(t){e.restoreRange(t),this.addFold(t)},this),0<e.collapseChildren&&this.foldAll(e.start.row+1,e.end.row,e.collapseChildren-1),e.subFolds=[]},this.expandFolds=function(t){t.forEach(function(t){this.expandFold(t)},this)},this.unfold=function(t,e){var n;if(null==t)n=new Range(0,0,this.getLength(),0),null==e&&(e=!0);else if("number"==typeof t)n=new Range(t,0,t,this.getLine(t).length);else if("row"in t)n=Range.fromPoints(t,t);else{if(Array.isArray(t))return i=[],t.forEach(function(t){i=i.concat(this.unfold(t))},this),i;n=t}for(var i,t=i=this.getFoldsInRangeList(n);1==i.length&&Range.comparePoints(i[0].start,n.start)<0&&0<Range.comparePoints(i[0].end,n.end);)this.expandFolds(i),i=this.getFoldsInRangeList(n);if(0!=e?this.removeFolds(i):this.expandFolds(i),t.length)return t},this.isRowFolded=function(t,e){return!!this.getFoldLine(t,e)},this.getRowFoldEnd=function(t,e){e=this.getFoldLine(t,e);return e?e.end.row:t},this.getRowFoldStart=function(t,e){e=this.getFoldLine(t,e);return e?e.start.row:t},this.getFoldDisplayLine=function(t,e,n,o,r){null==o&&(o=t.start.row),null==r&&(r=0),null==e&&(e=t.end.row),null==n&&(n=this.getLine(e).length);var s=this.doc,l="";return t.walk(function(t,e,n,i){if(!(e<o)){if(e==o){if(n<r)return;i=Math.max(r,i)}l+=null!=t?t:s.getLine(e).substring(i,n)}},e,n),l},this.getDisplayLine=function(t,e,n,i){var o=this.getFoldLine(t);return o?this.getFoldDisplayLine(o,t,e,n,i):(o=this.doc.getLine(t)).substring(i||0,e||o.length)},this.$cloneFoldData=function(){var e=[];return e=this.$foldData.map(function(t){t=t.folds.map(function(t){return t.clone()});return new FoldLine(e,t)})},this.toggleFold=function(t){var e=this.selection.getRange();if(e.isEmpty()){var n,i=e.start;if(n=this.getFoldAt(i.row,i.column))return void this.expandFold(n);(o=this.findMatchingBracket(i))?1==e.comparePoint(o)?e.end=o:(e.start=o,e.start.column++,e.end.column--):(o=this.findMatchingBracket({row:i.row,column:i.column+1}))?(1==e.comparePoint(o)?e.end=o:e.start=o,e.start.column++):e=this.getCommentFoldRange(i.row,i.column)||e}else{var o=this.getFoldsInRange(e);if(t&&o.length)return void this.expandFolds(o);1==o.length&&(n=o[0])}if((n=n||this.getFoldAt(e.start.row,e.start.column))&&n.range.toString()==e.toString())this.expandFold(n);else{i="...";if(!e.isMultiLine()){if((i=this.getTextRange(e)).length<4)return;i=i.trim().substring(0,2)+".."}this.addFold(i,e)}},this.getCommentFoldRange=function(t,e,n){var i=new TokenIterator(this,t,e),o=i.getCurrentToken(),r=o&&o.type;if(o&&/^comment|string/.test(r)){"comment"==(r=r.match(/comment|string/)[0])&&(r+="|doc-start");var s=new RegExp(r),r=new Range;if(1!=n){for(;(o=i.stepBackward())&&s.test(o.type););i.stepForward()}if(r.start.row=i.getCurrentTokenRow(),r.start.column=i.getCurrentTokenColumn()+2,i=new TokenIterator(this,t,e),-1!=n){var l=-1;do{if(o=i.stepForward(),-1==l){var d=this.getState(i.$row);s.test(d)||(l=i.$row)}else if(i.$row>l)break}while(o&&s.test(o.type));o=i.stepBackward()}else o=i.getCurrentToken();return r.end.row=i.getCurrentTokenRow(),r.end.column=i.getCurrentTokenColumn()+o.value.length-2,r}},this.foldAll=function(t,e,n,i){null==n&&(n=1e5);var o=this.foldWidgets;if(o){e=e||this.getLength();for(var r,s=t=t||0;s<e;s++)null==o[s]&&(o[s]=this.getFoldWidget(s)),"start"!=o[s]||i&&!i(s)||(r=this.getFoldWidgetRange(s))&&r.isMultiLine()&&r.end.row<=e&&r.start.row>=t&&(s=r.end.row,r.collapseChildren=n,this.addFold("...",r))}},this.foldToLevel=function(t){for(this.foldAll();0<t--;)this.unfold(null,!1)},this.foldAllComments=function(){var o=this;this.foldAll(null,null,null,function(t){for(var e=o.getTokens(t),n=0;n<e.length;n++){var i=e[n];if("text"!=i.type||!/^\s+$/.test(i.value))return!!/comment/.test(i.type)}})},this.$foldStyles={manual:1,markbegin:1,markbeginend:1},this.$foldStyle="markbegin",this.setFoldStyle=function(t){if(!this.$foldStyles[t])throw new Error("invalid fold style: "+t+"["+Object.keys(this.$foldStyles).join(", ")+"]");this.$foldStyle!=t&&("manual"==(this.$foldStyle=t)&&this.unfold(),t=this.$foldMode,this.$setFolding(null),this.$setFolding(t))},this.$setFolding=function(t){this.$foldMode!=t&&(this.$foldMode=t,this.off("change",this.$updateFoldWidgets),this.off("tokenizerUpdate",this.$tokenizerUpdateFoldWidgets),this._signal("changeAnnotation"),t&&"manual"!=this.$foldStyle?(this.foldWidgets=[],this.getFoldWidget=t.getFoldWidget.bind(t,this,this.$foldStyle),this.getFoldWidgetRange=t.getFoldWidgetRange.bind(t,this,this.$foldStyle),this.$updateFoldWidgets=this.updateFoldWidgets.bind(this),this.$tokenizerUpdateFoldWidgets=this.tokenizerUpdateFoldWidgets.bind(this),this.on("change",this.$updateFoldWidgets),this.on("tokenizerUpdate",this.$tokenizerUpdateFoldWidgets)):this.foldWidgets=null)},this.getParentFoldRangeData=function(t,e){var n=this.foldWidgets;if(!n||e&&n[t])return{};for(var i=t-1;0<=i;){var o=n[i];if("start"==(o=null==o?n[i]=this.getFoldWidget(i):o)){var r=this.getFoldWidgetRange(i),s=s||r;if(r&&r.end.row>=t)break}i--}return{range:-1!==i&&r,firstRange:s}},this.onFoldWidgetClick=function(t,e){var n={children:(e=e.domEvent).shiftKey,all:e.ctrlKey||e.metaKey,siblings:e.altKey};this.$toggleFoldWidget(t,n)||(t=e.target||e.srcElement)&&/ace_fold-widget/.test(t.className)&&(t.className+=" ace_invalid")},this.$toggleFoldWidget=function(t,e){var n,i,o,r;if(this.getFoldWidget)return n=this.getFoldWidget(t),i=this.getLine(t),(i=this.getFoldAt(t,-1==(n="end"===n?-1:1)?0:i.length,n))?(e.children||e.all?this.removeFold(i):this.expandFold(i),i):(n=this.getFoldWidgetRange(t,!0))&&!n.isMultiLine()&&(i=this.getFoldAt(n.start.row,n.start.column,1))&&n.isEqual(i.range)?(this.removeFold(i),i):(e.siblings?((i=this.getParentFoldRangeData(t)).range&&(o=i.range.start.row+1,r=i.range.end.row),this.foldAll(o,r,e.all?1e4:0)):e.children?(r=n?n.end.row:this.getLength(),this.foldAll(t+1,r,e.all?1e4:0)):n&&(e.all&&(n.collapseChildren=1e4),this.addFold("...",n)),n)},this.toggleFoldWidget=function(t){var e,n=this.selection.getCursor().row;n=this.getRowFoldStart(n),!this.$toggleFoldWidget(n,{})&&(e=(e=this.getParentFoldRangeData(n,!0)).range||e.firstRange)&&(n=e.start.row,(n=this.getFoldAt(n,this.getLine(n).length,1))?this.removeFold(n):this.addFold("...",e))},this.updateFoldWidgets=function(t){var e=t.start.row,n=t.end.row-e;0==n?this.foldWidgets[e]=null:"remove"==t.action?this.foldWidgets.splice(e,1+n,null):((t=Array(1+n)).unshift(e,1),this.foldWidgets.splice.apply(this.foldWidgets,t))},this.tokenizerUpdateFoldWidgets=function(t){t=t.data;t.first!=t.last&&this.foldWidgets.length>t.first&&this.foldWidgets.splice(t.first,this.foldWidgets.length)}}exports.Folding=Folding;