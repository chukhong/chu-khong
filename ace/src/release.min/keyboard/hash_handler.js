"use strict";var keyUtil=require("../lib/keys"),useragent=require("../lib/useragent"),KEY_MODS=keyUtil.KEY_MODS;function HashHandler(n,e){this.platform=e||(useragent.isMac?"mac":"win"),this.commands={},this.commandKeyBinding={},this.addCommands(n),this.$singleCommand=!0}function MultiHashHandler(n,e){HashHandler.call(this,n,e),this.$singleCommand=!1}MultiHashHandler.prototype=HashHandler.prototype,function(){function o(n){return"object"==typeof n&&n.bindKey&&n.bindKey.position||(n.isDefault?-100:0)}this.addCommand=function(n){this.commands[n.name]&&this.removeCommand(n),(this.commands[n.name]=n).bindKey&&this._buildKeyHash(n)},this.removeCommand=function(n,e){var i,t=n&&("string"==typeof n?n:n.name),a=(n=this.commands[t],e||delete this.commands[t],this.commandKeyBinding);for(i in a){var s,o=a[i];o==n?delete a[i]:Array.isArray(o)&&-1!=(s=o.indexOf(n))&&(o.splice(s,1),1==o.length)&&(a[i]=o[0])}},this.bindKey=function(n,t,a){if("object"==typeof n&&n&&(null==a&&(a=n.position),n=n[this.platform]),n)return"function"==typeof t?this.addCommand({exec:t,bindKey:n,name:t.name||n}):void n.split("|").forEach(function(n){var e="",i=(-1!=n.indexOf(" ")&&(n=(i=n.split(/\s+/)).pop(),i.forEach(function(n){n=this.parseKeys(n),n=KEY_MODS[n.hashId]+n.key;e+=(e?" ":"")+n,this._addCommandToBinding(e,"chainKeys")},this),e+=" "),this.parseKeys(n)),n=KEY_MODS[i.hashId]+i.key;this._addCommandToBinding(e+n,t,a)},this)},this._addCommandToBinding=function(n,e,i){var t=this.commandKeyBinding;if(e)if(!t[n]||this.$singleCommand)t[n]=e;else{Array.isArray(t[n])?-1!=(s=t[n].indexOf(e))&&t[n].splice(s,1):t[n]=[t[n]],"number"!=typeof i&&(i=o(e));for(var a=t[n],s=0;s<a.length;s++)if(i<o(a[s]))break;a.splice(s,0,e)}else delete t[n]},this.addCommands=function(i){i&&Object.keys(i).forEach(function(n){var e=i[n];if(e){if("string"==typeof e)return this.bindKey(e,n);"object"==typeof(e="function"==typeof e?{exec:e}:e)&&(e.name||(e.name=n),this.addCommand(e))}},this)},this.removeCommands=function(e){Object.keys(e).forEach(function(n){this.removeCommand(e[n])},this)},this.bindKeys=function(e){Object.keys(e).forEach(function(n){this.bindKey(n,e[n])},this)},this._buildKeyHash=function(n){this.bindKey(n.bindKey,n)},this.parseKeys=function(n){var e=n.toLowerCase().split(/[\-\+]([\-\+])?/).filter(function(n){return n}),i=e.pop(),t=keyUtil[i];if(keyUtil.FUNCTION_KEYS[t])i=keyUtil.FUNCTION_KEYS[t].toLowerCase();else{if(!e.length)return{key:i,hashId:-1};if(1==e.length&&"shift"==e[0])return{key:i.toUpperCase(),hashId:-1}}for(var a=0,s=e.length;s--;){var o=keyUtil.KEY_MODS[e[s]];if(null==o)return"undefined"!=typeof console&&console.error("invalid modifier "+e[s]+" in "+n),!1;a|=o}return{key:i,hashId:a}},this.findKeyCommand=function(n,e){n=KEY_MODS[n]+e;return this.commandKeyBinding[n]},this.handleKeyboard=function(n,e,i,t){var a,s;if(!(t<0))return a=KEY_MODS[e]+i,s=this.commandKeyBinding[a],n.$keyChain&&(n.$keyChain+=" "+a,s=this.commandKeyBinding[n.$keyChain]||s),!s||"chainKeys"!=s&&"chainKeys"!=s[s.length-1]?(n.$keyChain&&(e&&4!=e||1!=i.length?(-1==e||0<t)&&(n.$keyChain=""):n.$keyChain=n.$keyChain.slice(0,-a.length-1)),{command:s}):(n.$keyChain=n.$keyChain||a,{command:"null"})},this.getStatusText=function(n,e){return e.$keyChain||""}}.call(HashHandler.prototype),exports.HashHandler=HashHandler,exports.MultiHashHandler=MultiHashHandler;