"use strict";var $formerLongWords,$formerLineStart,dom=require("../lib/dom"),iSearchCommandModule=(require("../incremental_search"),require("../commands/incremental_search_commands")),HashHandler=require("./hash_handler").HashHandler,$kbSessionChange=(exports.handler=new HashHandler,exports.handler.isEmacs=!0,exports.handler.$id="ace/keyboard/emacs",dom.importCssString(`
.emacs-mode .ace_cursor{
    border: 1px rgba(50,250,50,0.8) solid!important;
    box-sizing: border-box!important;
    background-color: rgba(0,250,0,0.9);
    opacity: 0.5;
}
.emacs-mode .ace_hidden-cursors .ace_cursor{
    opacity: 1;
    background-color: transparent;
}
.emacs-mode .ace_overwrite-cursors .ace_cursor {
    opacity: 1;
    background-color: transparent;
    border-width: 0 0 2px 2px !important;
}
.emacs-mode .ace_text-layer {
    z-index: 4
}
.emacs-mode .ace_cursor-layer {
    z-index: 2
}`,"emacsMode"),exports.handler.attach=function(e){$formerLongWords=e.session.$selectLongWords,e.session.$selectLongWords=!0,$formerLineStart=e.session.$useEmacsStyleLineStart,e.session.$useEmacsStyleLineStart=!0,e.session.$emacsMark=null,e.session.$emacsMarkRing=e.session.$emacsMarkRing||[],e.emacsMark=function(){return this.session.$emacsMark},e.setEmacsMark=function(e){this.session.$emacsMark=e},e.pushEmacsMark=function(e,n){var o=this.session.$emacsMark;o&&this.session.$emacsMarkRing.push(o),!e||n?this.setEmacsMark(e):this.session.$emacsMarkRing.push(e)},e.popEmacsMark=function(){var e=this.emacsMark();return e?(this.setEmacsMark(null),e):this.session.$emacsMarkRing.pop()},e.getLastEmacsMark=function(e){return this.session.$emacsMark||this.session.$emacsMarkRing.slice(-1)[0]},e.emacsMarkForSelection=function(e){var n=this.selection,o=this.multiSelect?this.multiSelect.getAllRanges().length:1,t=n.index||0,s=this.session.$emacsMarkRing,o=s.length-(o-t),t=s[o]||n.anchor;return e&&s.splice(o,1,"row"in e&&"column"in e?e:void 0),t},e.on("click",$resetMarkMode),e.on("changeSession",$kbSessionChange),e.renderer.$blockCursor=!0,e.setStyle("emacs-mode"),e.commands.addCommands(commands),exports.handler.platform=e.commands.platform,e.$emacsModeHandler=this,e.on("copy",this.onCopy),e.on("paste",this.onPaste)},exports.handler.detach=function(e){e.renderer.$blockCursor=!1,e.session.$selectLongWords=$formerLongWords,e.session.$useEmacsStyleLineStart=$formerLineStart,e.off("click",$resetMarkMode),e.off("changeSession",$kbSessionChange),e.unsetStyle("emacs-mode"),e.commands.removeCommands(commands),e.off("copy",this.onCopy),e.off("paste",this.onPaste),e.$emacsModeHandler=null},function(e){e.oldSession&&(e.oldSession.$selectLongWords=$formerLongWords,e.oldSession.$useEmacsStyleLineStart=$formerLineStart),$formerLongWords=e.session.$selectLongWords,e.session.$selectLongWords=!0,$formerLineStart=e.session.$useEmacsStyleLineStart,e.session.$useEmacsStyleLineStart=!0,e.session.hasOwnProperty("$emacsMark")||(e.session.$emacsMark=null),e.session.hasOwnProperty("$emacsMarkRing")||(e.session.$emacsMarkRing=[])}),$resetMarkMode=function(e){e.editor.session.$emacsMark=null},keys=require("../lib/keys").KEY_MODS,eMods={C:"ctrl",S:"shift",M:"alt",CMD:"command"},combinations=["C-S-M-CMD","S-M-CMD","C-M-CMD","C-S-CMD","C-S-M","M-CMD","S-CMD","S-M","C-CMD","C-M","C-S","CMD","M","S","C"],commands=(combinations.forEach(function(e){var n=0;e.split("-").forEach(function(e){n|=keys[eMods[e]]}),eMods[n]=e.toLowerCase()+"-"}),exports.handler.onCopy=function(e,n){n.$handlesEmacsOnCopy||(n.$handlesEmacsOnCopy=!0,exports.handler.commands.killRingSave.exec(n),n.$handlesEmacsOnCopy=!1)},exports.handler.onPaste=function(e,n){n.pushEmacsMark(n.getCursorPosition())},exports.handler.bindKey=function(e,n){var o;(e="object"==typeof e?e[this.platform]:e)&&(o=this.commandKeyBinding,e.split("|").forEach(function(e){e=e.toLowerCase(),o[e]=n,e.split(" ").slice(0,-1).reduce(function(e,n,o){o=e[o-1]?e[o-1]+" ":"";return e.concat([o+n])},[]).forEach(function(e){o[e]||(o[e]="null")})},this))},exports.handler.getStatusText=function(e,n){var o="";return n.count&&(o+=n.count),n.keyChain&&(o+=" "+n.keyChain),o},exports.handler.handleKeyboard=function(e,n,o,t){if(-1!==t){t=e.editor;if(t._signal("changeStatus"),-1==n)if(t.pushEmacsMark(),e.count)return s=new Array(e.count+1).join(o),e.count=null,{command:"insertstring",args:s};var s=eMods[n];if("c-"==s||e.count)if("number"==typeof(c=parseInt(o[o.length-1]))&&!isNaN(c))return e.count=Math.max(e.count,0)||0,e.count=10*e.count+c,{command:"null"};s&&(o=s+o),e.keyChain&&(o=e.keyChain+=" "+o);var a,r=this.commandKeyBinding[o];if(e.keyChain="null"==r?o:"",r){if("null"===r)return{command:"null"};if("universalArgument"===r)return e.count=-4,{command:"null"};if("string"!=typeof r&&(a=r.args,"goorselect"===(r=r.command?r.command:r))&&(r=t.emacsMark()?a[1]:a[0],a=null),"string"!=typeof r||("insertstring"!==r&&"splitline"!==r&&"togglecomment"!==r||t.pushEmacsMark(),r=this.commands[r]||t.commands.commands[r])){if(r.readOnly||r.isYank||(e.lastCommand=null),!r.readOnly&&t.emacsMark()&&t.setEmacsMark(null),e.count){var c=e.count;if(e.count=0,!r||!r.handlesCount)return{args:a,command:{exec:function(e,n){for(var o=0;o<c;o++)r.exec(e,n)},multiSelectAction:r.multiSelectAction}};"object"==typeof(a=a||{})&&(a.count=c)}return{command:r,args:a}}}}},exports.emacsKeys={"Up|C-p":{command:"goorselect",args:["golineup","selectup"]},"Down|C-n":{command:"goorselect",args:["golinedown","selectdown"]},"Left|C-b":{command:"goorselect",args:["gotoleft","selectleft"]},"Right|C-f":{command:"goorselect",args:["gotoright","selectright"]},"C-Left|M-b":{command:"goorselect",args:["gotowordleft","selectwordleft"]},"C-Right|M-f":{command:"goorselect",args:["gotowordright","selectwordright"]},"Home|C-a":{command:"goorselect",args:["gotolinestart","selecttolinestart"]},"End|C-e":{command:"goorselect",args:["gotolineend","selecttolineend"]},"C-Home|S-M-,":{command:"goorselect",args:["gotostart","selecttostart"]},"C-End|S-M-.":{command:"goorselect",args:["gotoend","selecttoend"]},"S-Up|S-C-p":"selectup","S-Down|S-C-n":"selectdown","S-Left|S-C-b":"selectleft","S-Right|S-C-f":"selectright","S-C-Left|S-M-b":"selectwordleft","S-C-Right|S-M-f":"selectwordright","S-Home|S-C-a":"selecttolinestart","S-End|S-C-e":"selecttolineend","S-C-Home":"selecttostart","S-C-End":"selecttoend","C-l":"recenterTopBottom","M-s":"centerselection","M-g":"gotoline","C-x C-p":"selectall","C-Down":{command:"goorselect",args:["gotopagedown","selectpagedown"]},"C-Up":{command:"goorselect",args:["gotopageup","selectpageup"]},"PageDown|C-v":{command:"goorselect",args:["gotopagedown","selectpagedown"]},"PageUp|M-v":{command:"goorselect",args:["gotopageup","selectpageup"]},"S-C-Down":"selectpagedown","S-C-Up":"selectpageup","C-s":"iSearch","C-r":"iSearchBackwards","M-C-s":"findnext","M-C-r":"findprevious","S-M-5":"replace",Backspace:"backspace","Delete|C-d":"del","Return|C-m":{command:"insertstring",args:"\n"},"C-o":"splitline","M-d|C-Delete":{command:"killWord",args:"right"},"C-Backspace|M-Backspace|M-Delete":{command:"killWord",args:"left"},"C-k":"killLine","C-y|S-Delete":"yank","M-y":"yankRotate","C-g":"keyboardQuit","C-w|C-S-W":"killRegion","M-w":"killRingSave","C-Space":"setMark","C-x C-x":"exchangePointAndMark","C-t":"transposeletters","M-u":"touppercase","M-l":"tolowercase","M-/":"autocomplete","C-u":"universalArgument","M-;":"togglecomment","C-/|C-x u|S-C--|C-z":"undo","S-C-/|S-C-x u|C--|S-C-z":"redo","C-x r":"selectRectangularRegion","M-x":{command:"focusCommandLine",args:"M-x "}},exports.handler.bindKeys(exports.emacsKeys),exports.handler.addCommands({recenterTopBottom:function(e){var n=e.renderer,o=n.$cursorLayer.getPixelPosition(),t=n.$size.scrollerHeight-n.lineHeight,n=n.scrollTop,n=Math.abs(o.top-n)<2?o.top-t:Math.abs(o.top-n-.5*t)<2?o.top:o.top-.5*t;e.session.setScrollTop(n)},selectRectangularRegion:function(e){e.multiSelect.toggleBlockSelection()},setMark:{exec:function(n,e){var o,t;function s(){var e=n.popEmacsMark();e&&n.moveCursorToPosition(e)}e&&e.count?(n.inMultiSelectMode?n.forEachSelection(s):s(),s()):(e=n.emacsMark(),o=(t=n.selection.getAllRanges()).map(function(e){return{row:e.start.row,column:e.start.column}}),t=t.every(function(e){return e.isEmpty()}),e||!t?(n.inMultiSelectMode?n.forEachSelection({exec:n.clearSelection.bind(n)}):n.clearSelection(),e&&n.pushEmacsMark(null)):e||(o.forEach(function(e){n.pushEmacsMark(e)}),n.setEmacsMark(o[o.length-1])))},readOnly:!0,handlesCount:!0},exchangePointAndMark:{exec:function(e,n){var o=e.selection;n.count||o.isEmpty()?n.count?(n={row:o.lead.row,column:o.lead.column},o.clearSelection(),o.moveCursorToPosition(e.emacsMarkForSelection(n))):o.selectToPosition(e.emacsMarkForSelection()):o.setSelectionRange(o.getRange(),!o.isBackwards())},readOnly:!0,handlesCount:!0,multiSelectAction:"forEach"},killWord:{exec:function(e,n){e.clearSelection(),"left"==n?e.selection.selectWordLeft():e.selection.selectWordRight();var n=e.getSelectionRange(),o=e.session.getTextRange(n);exports.killRing.add(o),e.session.remove(n),e.clearSelection()},multiSelectAction:"forEach"},killLine:function(e){e.pushEmacsMark(null),e.clearSelection();var n=e.getSelectionRange(),o=e.session.getLine(n.start.row),t=(n.end.column=o.length,o=o.substr(n.start.column),e.session.getFoldLine(n.start.row)),t=(t&&n.end.row!=t.end.row&&(n.end.row=t.end.row,o="x"),/^\s*$/.test(o)&&(n.end.row++,o=e.session.getLine(n.end.row),n.end.column=/^\s*$/.test(o)?o.length:0),e.session.getTextRange(n));e.prevOp.command==this?exports.killRing.append(t):exports.killRing.add(t),e.session.remove(n),e.clearSelection()},yank:function(e){e.onPaste(exports.killRing.get()||""),e.keyBinding.$data.lastCommand="yank"},yankRotate:function(e){"yank"==e.keyBinding.$data.lastCommand&&(e.undo(),e.session.$emacsMarkRing.pop(),e.onPaste(exports.killRing.rotate()),e.keyBinding.$data.lastCommand="yank")},killRegion:{exec:function(e){exports.killRing.add(e.getCopyText()),e.commands.byName.cut.exec(e),e.setEmacsMark(null)},readOnly:!0,multiSelectAction:"forEach"},killRingSave:{exec:function(o){o.$handlesEmacsOnCopy=!0;var n=o.session.$emacsMarkRing.slice(),t=[];exports.killRing.add(o.getCopyText()),setTimeout(function(){function e(){var e=o.selection,n=e.getRange(),n=e.isBackwards()?n.end:n.start;t.push({row:n.row,column:n.column}),e.clearSelection()}o.$handlesEmacsOnCopy=!1,o.inMultiSelectMode?o.forEachSelection({exec:e}):e(),o.setEmacsMark(null),o.session.$emacsMarkRing=n.concat(t.reverse())},0)},readOnly:!0},keyboardQuit:function(e){e.selection.clearSelection(),e.setEmacsMark(null),e.keyBinding.$data.count=null},focusCommandLine:function(e,n){e.showCommandLine&&e.showCommandLine(n)}}),exports.handler.addCommands(iSearchCommandModule.iSearchStartCommands),exports.handler.commands);commands.yank.isYank=!0,commands.yankRotate.isYank=!0,exports.killRing={$data:[],add:function(e){e&&this.$data.push(e),30<this.$data.length&&this.$data.shift()},append:function(e){var n=this.$data.length-1,o=this.$data[n]||"";e&&(o+=e),o&&(this.$data[n]=o)},get:function(e){return this.$data.slice(this.$data.length-(e=e||1),this.$data.length).reverse().join("\n")},pop:function(){return 1<this.$data.length&&this.$data.pop(),this.get()},rotate:function(){return this.$data.unshift(this.$data.pop()),this.get()}};