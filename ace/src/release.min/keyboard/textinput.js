"use strict";var event=require("../lib/event"),useragent=require("../lib/useragent"),dom=require("../lib/dom"),lang=require("../lib/lang"),clipboard=require("../clipboard"),BROKEN_SETDATA=useragent.isChrome<18,USE_IE_MIME_TYPE=useragent.isIE,HAS_FOCUS_ARGS=63<useragent.isChrome,MAX_LINE_LENGTH=400,KEYS=require("../lib/keys"),MODS=KEYS.KEY_MODS,isIOS=useragent.isIOS,valueResetRegex=isIOS?/\s/:/\n/,isMobile=useragent.isMobile,TextInput=function(e,d){var m=dom.createElement("textarea"),r=(m.className="ace_text-input",m.setAttribute("wrap","off"),m.setAttribute("autocorrect","off"),m.setAttribute("autocapitalize","off"),m.setAttribute("spellcheck",!1),m.style.opacity="0",e.insertBefore(m,e.firstChild),!1),f=!1,s=!1,p=!1,a="",v=(isMobile||(m.style.fontSize="1px"),!1),t=!1,g="",E=0,h=0,y=0;try{var u=document.activeElement===m}catch(e){}event.addListener(m,"blur",function(e){t||(d.onBlur(e),u=!1)},d),event.addListener(m,"focus",function(e){if(!t){if(u=!0,useragent.isEdge)try{if(!document.hasFocus())return}catch(e){}d.onFocus(e),useragent.isEdge?setTimeout(S):S()}},d),this.$focusScroll=!1,this.focus=function(){if(a||HAS_FOCUS_ARGS||"browser"==this.$focusScroll)return m.focus({preventScroll:!0});var e=m.style.top;m.style.position="fixed",m.style.top="0px";try{var t=0!=m.getBoundingClientRect().top}catch(e){return}var n=[];if(t)for(var o=m.parentElement;o&&1==o.nodeType;)n.push(o),o.setAttribute("ace_nocontext",!0),o=!o.parentElement&&o.getRootNode?o.getRootNode().host:o.parentElement;m.focus({preventScroll:!0}),t&&n.forEach(function(e){e.removeAttribute("ace_nocontext")}),setTimeout(function(){m.style.position="","0px"==m.style.top&&(m.style.top=e)},0)},this.blur=function(){m.blur()},this.isFocused=function(){return u},d.on("beforeEndOperation",function(){var e=d.curOp,t=e&&e.command&&e.command.name;"insertstring"!=t&&(t=t&&(e.docChanged||e.selectionChanged),s&&t&&(g=m.value="",I()),S())});function n(e){L(e,!0)}function o(e){L(e,!1)}function i(e){var t=C(e);clipboard.pasteCancelled()||("string"==typeof t?(t&&d.onPaste(t,e),useragent.isIE&&setTimeout(S),event.preventDefault(e)):(m.value="",f=!0))}var S=isIOS?function(e){var t;!u||r&&!e||p||((t="\n ab"+(e=e||"")+"cde fg\n")!=m.value&&(m.value=g=t),t=4+(e.length||(d.selection.isEmpty()?0:1)),4==E&&h==t||m.setSelectionRange(4,t),E=4,h=t)}:function(){if(!s&&!p&&(u||x)){s=!0;var e,t,n=0,o=0,i="",r=(d.session&&(r=(e=d.selection).getRange(),e=e.cursor.row,n=r.start.column,o=r.end.column,i=d.session.getLine(e),r.start.row!=e?(t=d.session.getLine(e-1),n=r.start.row<e-1?0:n,o+=t.length+1,i=t+"\n"+i):r.end.row!=e?(t=d.session.getLine(e+1),o=r.end.row>e+1?t.length:o,o+=i.length+1,i=i+"\n"+t):isMobile&&0<e&&(i="\n"+i,o+=1,n+=1),i.length>MAX_LINE_LENGTH)&&(n<MAX_LINE_LENGTH&&o<MAX_LINE_LENGTH?i=i.slice(0,MAX_LINE_LENGTH):(i="\n",n==o?n=o=0:(n=0,o=1))),i+"\n\n");if(r!=g&&(m.value=g=r,E=h=r.length),x&&(E=m.selectionStart,h=m.selectionEnd),h!=o||E!=n||m.selectionEnd!=h)try{m.setSelectionRange(n,o),E=n,h=o}catch(e){}s=!1}},D=(this.resetSelection=S,u&&d.onFocus(),function(e){return 0===e.selectionStart&&e.selectionEnd>=g.length&&e.value===g&&g&&e.selectionEnd!==h}),c=null,x=(this.setInputHandler=function(e){c=e},!(this.getInputHandler=function(){return c})),l=function(e,t){if(x=x&&!1,f)return S(),e&&d.onPaste(e),f=!1,"";for(var n=m.selectionStart,o=m.selectionEnd,i=E,r=g.length-h,s=e,a=e.length-n,u=e.length-o,c=0;0<i&&g[c]==e[c];)c++,i--;for(s=s.slice(c),c=1;0<r&&g.length-c>E-1&&g[g.length-c]==e[e.length-c];)c++,r--;a-=c-1,u-=c-1;var l=s.length-c+1;return l<0&&(i=-l,l=0),s=s.slice(0,l),t||s||a||i||r||u?(l=!(p=!0),useragent.isAndroid&&". "==s&&(s="  ",l=!0),s&&!i&&!r&&!a&&!u||v?d.onTextInput(s):d.onTextInput(s,{extendLeft:i,extendRight:r,restoreStart:a,restoreEnd:u}),p=!1,g=e,E=n,h=o,y=u,l?"\n":s):""},T=function(e){if(s)return b();if(e&&e.inputType){if("historyUndo"==e.inputType)return d.execCommand("undo");if("historyRedo"==e.inputType)return d.execCommand("redo")}var e=m.value,t=l(e,!0);(e.length>MAX_LINE_LENGTH+100||valueResetRegex.test(t)||isMobile&&E<1&&E==h)&&S()},C=function(e,t,n){var o=e.clipboardData||window.clipboardData;if(o&&!BROKEN_SETDATA){var i=USE_IE_MIME_TYPE||n?"Text":"text/plain";try{return t?!1!==o.setData(i,t):o.getData(i)}catch(e){if(!n)return C(e,t,!0)}}},L=function(e,t){var n=d.getCopyText();if(!n)return event.preventDefault(e);C(e,n)?(isIOS&&(S(n),r=n,setTimeout(function(){r=!1},10)),t?d.onCut():d.onCopy(),event.preventDefault(e)):(r=!0,m.value=n,m.select(),setTimeout(function(){r=!1,S(),t?d.onCut():d.onCopy()}))},b=(event.addCommandKeyListener(m,d.onCommandKey.bind(d),d),event.addListener(m,"select",function(e){s||(r?r=!1:D(m)?(d.selectAll(),S()):isMobile&&m.selectionStart!=E&&S())},d),event.addListener(m,"input",T,d),event.addListener(m,"cut",n,d),event.addListener(m,"copy",o,d),event.addListener(m,"paste",i,d),"oncut"in m&&"oncopy"in m&&"onpaste"in m||event.addListener(e,"keydown",function(e){if((!useragent.isMac||e.metaKey)&&e.ctrlKey)switch(e.keyCode){case 67:o(e);break;case 86:i(e);break;case 88:n(e)}},d),function(){var e;if(s&&d.onCompositionUpdate&&!d.$readOnly)return v?M():void(s.useTextareaForIME?d.onCompositionUpdate(m.value):(e=m.value,l(e),s.markerRange&&(s.context&&(s.markerRange.start.column=s.selectionStart=s.context.compositionStartOffset),s.markerRange.end.column=s.markerRange.start.column+h-s.selectionStart+y)))}),I=function(e){d.onCompositionEnd&&!d.$readOnly&&(s=!1,d.onCompositionEnd(),d.off("mousedown",M),e)&&T()};function M(){t=!0,m.blur(),m.focus(),t=!1}var _,A=lang.delayedCall(b,50).schedule.bind(null,null);function O(){clearTimeout(_),_=setTimeout(function(){a&&(m.style.cssText=a,a=""),d.renderer.$isMousePressed=!1,d.renderer.$keepTextAreaAtCursor&&d.renderer.$moveTextAreaToCursor()},0)}event.addListener(m,"compositionstart",function(e){s||!d.onCompositionStart||d.$readOnly||(s={},v)||(e.data&&(s.useTextareaForIME=!1),setTimeout(b,0),d._signal("compositionStart"),d.on("mousedown",M),(e=d.getSelectionRange()).end.row=e.start.row,e.end.column=e.start.column,s.markerRange=e,s.selectionStart=E,d.onCompositionStart(s),s.useTextareaForIME?(g=m.value="",h=E=0):(m.msGetInputContext&&(s.context=m.msGetInputContext()),m.getInputContext&&(s.context=m.getInputContext())))},d),event.addListener(m,"compositionupdate",b,d),event.addListener(m,"keyup",function(e){27==e.keyCode&&m.value.length<m.selectionStart&&(s||(g=m.value),E=h=-1,S()),A()},d),event.addListener(m,"keydown",A,d),event.addListener(m,"compositionend",I,d),this.getElement=function(){return m},this.setCommandMode=function(e){v=e,m.readOnly=!1},this.setReadOnly=function(e){v||(m.readOnly=e)},this.setCopyWithEmptySelection=function(e){},this.onContextMenu=function(e){x=!0,S(),d._emit("nativecontextmenu",{target:d,domEvent:e}),this.moveToMouse(e,!0)},this.moveToMouse=function(e,t){a=a||m.style.cssText,m.style.cssText=(t?"z-index:100000;":"")+(useragent.isIE?"opacity:0.1;":"")+"text-indent: -"+(E+h)*d.renderer.characterWidth*.5+"px;";function n(e){dom.translate(m,e.clientX-r-2,Math.min(e.clientY-i-2,s))}var t=d.container.getBoundingClientRect(),o=dom.computedStyle(d.container),i=t.top+(parseInt(o.borderTopWidth)||0),r=t.left+(parseInt(t.borderLeftWidth)||0),s=t.bottom-i-m.clientHeight-2;n(e),"mousedown"==e.type&&(d.renderer.$isMousePressed=!0,clearTimeout(_),useragent.isWin)&&event.capture(d.container,n,O)},this.onContextMenuClose=O;function R(e){d.textInput.onContextMenu(e),O()}if(event.addListener(m,"mouseup",R,d),event.addListener(m,"mousedown",function(e){e.preventDefault(),O()},d),event.addListener(d.renderer.scroller,"contextmenu",R,d),event.addListener(m,"contextmenu",R,d),isIOS){var w=d,K=m;function Y(e){var t,n,o,i;document.activeElement!==K||N||s||w.$mouseHandler.isMousePressed||r||(t=K.selectionStart,n=K.selectionEnd,o=null,(i=0)==t?o=KEYS.up:1==t?o=KEYS.home:h<n&&"\n"==g[n]?o=KEYS.end:t<E&&" "==g[t-1]?(o=KEYS.left,i=MODS.option):t<E||t==E&&h!=E&&t==n?o=KEYS.left:h<n&&2<g.slice(0,n).split("\n").length?o=KEYS.down:h<n&&" "==g[n-1]?(o=KEYS.right,i=MODS.option):(h<n||n==h&&h!=E&&t==n)&&(o=KEYS.right),t!==n&&(i|=MODS.shift),o&&(!w.onCommandKey({},i,o)&&w.commands&&(o=KEYS.keyCodeToString(o),i=w.commands.findKeyCommand(i,o))&&w.execCommand(i),E=t,h=n,S("")))}var k=null,N=!1;K.addEventListener("keydown",function(e){k&&clearTimeout(k),N=!0},!0),K.addEventListener("keyup",function(e){k=setTimeout(function(){N=!1},100)},!0),document.addEventListener("selectionchange",Y),w.on("destroy",function(){document.removeEventListener("selectionchange",Y)})}this.destroy=function(){m.parentElement&&m.parentElement.removeChild(m)}};exports.TextInput=TextInput,exports.$setUserAgentForTests=function(e,t){isMobile=e,isIOS=t};