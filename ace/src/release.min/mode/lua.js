"use strict";var oop=require("../lib/oop"),TextMode=require("./text").Mode,LuaHighlightRules=require("./lua_highlight_rules").LuaHighlightRules,LuaFoldMode=require("./folding/lua").FoldMode,Range=require("../range").Range,WorkerClient=require("../worker/worker_client").WorkerClient,Mode=function(){this.HighlightRules=LuaHighlightRules,this.foldingRules=new LuaFoldMode,this.$behaviour=this.$defaultBehaviour};oop.inherits(Mode,TextMode),function(){this.lineCommentStart="--",this.blockComment={start:"--[[",end:"--]]"};var a={function:1,then:1,do:1,else:1,elseif:1,repeat:1,end:-1,until:-1},i=["else","elseif","end","until"];this.getNextLineIndent=function(e,t,n){var i=this.$getIndent(t),o=0,r=this.getTokenizer().getLineTokens(t,e).tokens;return 0<(o="start"==e?function(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];"keyword"==i.type?i.value in a&&(t+=a[i.value]):"paren.lparen"==i.type?t+=i.value.length:"paren.rparen"==i.type&&(t-=i.value.length)}return t<0?-1:0<t?1:0}(r):o)?i+n:o<0&&i.substr(i.length-n.length)==n&&!this.checkOutdent(e,t,"\n")?i.substr(0,i.length-n.length):i},this.checkOutdent=function(e,t,n){return!("\n"!=n&&"\r"!=n&&"\r\n"!=n||!t.match(/^\s*[\)\}\]]$/)&&(!(n=this.getTokenizer().getLineTokens(t.trim(),e).tokens)||!n.length||"keyword"!=n[0].type||-1==i.indexOf(n[0].value)))},this.getMatching=function(e,t,n){null==t&&(n=(i=e.selection.lead).column,t=i.row);var i=e.getTokenAt(t,n);if(i&&i.value in a)return this.foldingRules.luaBlock(e,t,n,!0)},this.autoOutdent=function(e,t,n){var i,o=t.getLine(n).match(/^\s*/)[0].length;o&&n&&(i=this.getMatching(t,n,o+1))&&i.start.row!=n&&(i=this.$getIndent(t.getLine(i.start.row))).length!=o&&(t.replace(new Range(n,0,n,o),i),t.outdentRows(new Range(n+1,0,n+1,0)))},this.createWorker=function(t){var e=new WorkerClient(["ace"],"ace/mode/lua_worker","Worker");return e.attachToDocument(t.getDocument()),e.on("annotate",function(e){t.setAnnotations(e.data)}),e.on("terminate",function(){t.clearAnnotations()}),e},this.$id="ace/mode/lua",this.snippetFileId="ace/snippets/lua"}.call(Mode.prototype),exports.Mode=Mode;