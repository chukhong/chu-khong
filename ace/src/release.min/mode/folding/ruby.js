"use strict";var oop=require("../../lib/oop"),BaseFoldMode=require("./fold_mode").FoldMode,Range=require("../../range").Range,TokenIterator=require("../../token_iterator").TokenIterator,FoldMode=exports.FoldMode=function(){};oop.inherits(FoldMode,BaseFoldMode),function(){this.indentKeywords={class:1,def:1,module:1,do:1,unless:1,if:1,while:1,for:1,until:1,begin:1,else:0,elsif:0,rescue:0,ensure:0,when:0,end:-1,case:1,"=begin":1,"=end":-1},this.foldingStartMarker=/(?:\s|^)(def|do|while|class|unless|module|if|for|until|begin|else|elsif|case|rescue|ensure|when)\b|({\s*$)|(=begin)/,this.foldingStopMarker=/(=end(?=$|\s.*$))|(^\s*})|\b(end)\b/,this.getFoldWidget=function(e,t,n){var i,r=e.getLine(n),s=this.foldingStartMarker.test(r),o=this.foldingStopMarker.test(r);if(s&&!o)if((i=r.match(this.foldingStartMarker))[1]){if("if"==i[1]||"else"==i[1]||"while"==i[1]||"until"==i[1]||"unless"==i[1]){if("else"==i[1]&&!1===/^\s*else\s*$/.test(r))return;if(!1===/^\s*(?:if|else|while|until|unless)\s*/.test(r))return}if("when"==i[1]&&!0===/\sthen\s/.test(r))return;if("keyword"===e.getTokenAt(n,i.index+2).type)return"start"}else{if(!i[3])return"start";if("comment.multiline"===e.getTokenAt(n,i.index+1).type)return"start"}return"markbeginend"!=t||!o||s&&o?"":"end"===(i=r.match(this.foldingStopMarker))[3]?"keyword"===e.getTokenAt(n,i.index+1).type?"end":void 0:!i[1]||"comment.multiline"===e.getTokenAt(n,i.index+1).type?"end":void 0},this.getFoldWidgetRange=function(e,t,n){var i=e.doc.getLine(n),r=this.foldingStartMarker.exec(i);return r?r[1]||r[3]?this.rubyBlock(e,n,r.index+2):this.openingBracketBlock(e,"{",n,r.index):(r=this.foldingStopMarker.exec(i))?"end"===r[3]&&"keyword"===e.getTokenAt(n,r.index+1).type||"=end"===r[1]&&"comment.multiline"===e.getTokenAt(n,r.index+1).type?this.rubyBlock(e,n,r.index+1):this.closingBracketBlock(e,"}",n,r.index+r[0].length):void 0},this.rubyBlock=function(e,t,n,i){var r=new TokenIterator(e,t,n),s=r.getCurrentToken();if(s&&("keyword"==s.type||"comment.multiline"==s.type)){var o=s.value,l=e.getLine(t);switch(s.value){case"if":case"unless":case"while":case"until":if(new RegExp("^\\s*"+s.value).test(l)){var a=this.indentKeywords[o];break}return;case"when":if(/\sthen\s/.test(l))return;case"elsif":case"rescue":case"ensure":a=1;break;case"else":if(new RegExp("^\\s*"+s.value+"\\s*$").test(l)){a=1;break}return;default:a=this.indentKeywords[o]}var u=[o];if(a){var d=(-1===a?e.getLine(t-1):e.getLine(t)).length,n=t,f=[];if(f.push(r.getCurrentTokenRange()),r.step=-1===a?r.stepBackward:r.stepForward,"comment.multiline"==s.type){for(;s=r.step();)if("comment.multiline"===s.type)if(1==a){if(d=6,"=end"==s.value)break}else if("=begin"==s.value)break}else for(;s=r.step();){var g=!1;if("keyword"===s.type){var c=a*this.indentKeywords[s.value],l=e.getLine(r.getCurrentTokenRow());switch(s.value){case"do":for(var k=r.$tokenIndex-1;0<=k;k--){var h=r.$rowTokens[k];if(h&&("while"==h.value||"until"==h.value||"for"==h.value)){c=0;break}}break;case"else":new RegExp("^\\s*"+s.value+"\\s*$").test(l)&&"case"!=o||(g=!(c=0));break;case"if":case"unless":case"while":case"until":new RegExp("^\\s*"+s.value).test(l)||(g=!(c=0));break;case"when":!/\sthen\s/.test(l)&&"case"!=o||(g=!(c=0))}if(0<c)u.unshift(s.value);else if(c<=0&&!1===g){if(u.shift(),!u.length){if(("while"==o||"until"==o||"for"==o)&&"do"!=s.value)break;if("do"==s.value&&-1==a&&0!=c)break;if("do"!=s.value)break}0===c&&u.unshift(s.value)}}}return s?i?(f.push(r.getCurrentTokenRange()),f):(t=r.getCurrentTokenRow(),-1===a?(i="comment.multiline"===s.type?6:e.getLine(t).length,new Range(t,i,n-1,d)):new Range(n,d,t-1,e.getLine(t-1).length)):null}}}}.call(FoldMode.prototype);