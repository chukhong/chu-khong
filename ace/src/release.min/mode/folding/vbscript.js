"use strict";var oop=require("../../lib/oop"),BaseFoldMode=require("./fold_mode").FoldMode,Range=require("../../range").Range,TokenIterator=require("../../token_iterator").TokenIterator,FoldMode=exports.FoldMode=function(){};oop.inherits(FoldMode,BaseFoldMode),function(){this.indentKeywords={class:1,function:1,sub:1,if:1,select:1,do:1,for:1,while:1,with:1,property:1,else:1,elseif:1,end:-1,loop:-1,next:-1,wend:-1},this.foldingStartMarker=/(?:\s|^)(class|function|sub|if|select|do|for|while|with|property|else|elseif)\b/i,this.foldingStopMarker=/\b(end|loop|next|wend)\b/i,this.getFoldWidgetRange=function(e,t,s){var r=e.getLine(s),o=this.foldingStartMarker.test(r),n=this.foldingStopMarker.test(r);if(o||n){o=(n?this.foldingStopMarker:this.foldingStartMarker).exec(r);if(o&&o[1].toLowerCase()){n=e.getTokenAt(s,o.index+2).type;if("keyword.control.asp"===n||"storage.type.function.asp"===n)return this.vbsBlock(e,s,o.index+2)}}},this.getFoldWidget=function(e,t,s){var r=e.getLine(s),o=this.foldingStartMarker.test(r),n=this.foldingStopMarker.test(r);if(o&&!n){o=this.foldingStartMarker.exec(r),n=o&&o[1].toLowerCase();if(n){e=e.getTokenAt(s,o.index+2).type;if("keyword.control.asp"==e||"storage.type.function.asp"==e)return"if"!=n||/then\s*('|$)/i.test(r)?"start":""}}return""},this.vbsBlock=function(e,t,s,r){var o=new TokenIterator(e,t,s),n={class:1,function:1,sub:1,if:1,select:1,with:1,property:1,else:1,elseif:1},a=o.getCurrentToken();if(a&&("keyword.control.asp"==a.type||"storage.type.function.asp"==a.type)){var i=a.value.toLowerCase(),c=[d=a.value.toLowerCase()],l=this.indentKeywords[d];if(l){var f=o.getCurrentTokenRange();switch(d){case"property":case"sub":case"function":case"if":case"select":case"do":case"for":case"class":case"while":case"with":var p=e.getLine(t);if(/^\s*If\s+.*\s+Then(?!')\s+(?!')\S/i.test(p))return;var u=new RegExp("(?:^|\\s)"+d,"i"),g=/^\s*End\s(If|Sub|Select|Function|Class|With|Property)\s*/i.test(p);if(!u.test(p)&&!g)return;g&&(r=o.getCurrentTokenRange(),o.step=o.stepBackward,o.step(),o.step(),(a=o.getCurrentToken())&&"end"==(d=a.value.toLowerCase())&&(f=o.getCurrentTokenRange(),f=new Range(f.start.row,f.start.column,r.start.row,r.end.column)),l=-1);break;case"end":var d,h=o.getCurrentTokenPosition();f=o.getCurrentTokenRange(),o.step=o.stepForward,o.step(),o.step(),(a=o.getCurrentToken())&&(d=a.value.toLowerCase())in n&&(i=d,v=(b=o.getCurrentTokenPosition()).column+d.length,f=new Range(h.row,h.column,b.row,v)),o.step=o.stepBackward,o.step(),o.step()}var s=(-1===l?e.getLine(t-1):e.getLine(t)).length,w=t,k=[];for(k.push(f),o.step=-1===l?o.stepBackward:o.stepForward;a=o.step();){var C=null,y=!1;if("keyword.control.asp"==a.type||"storage.type.function.asp"==a.type){d=a.value.toLowerCase();var T=l*this.indentKeywords[d];switch(d){case"property":case"sub":case"function":case"if":case"select":case"do":case"for":case"class":case"while":case"with":p=e.getLine(o.getCurrentTokenRow());/^\s*If\s+.*\s+Then(?!')\s+(?!')\S/i.test(p)&&(y=!(T=0)),(u=new RegExp("^\\s* end\\s+"+d,"i")).test(p)&&(y=!(T=0));break;case"elseif":case"else":T=0,"elseif"!=i&&(y=!0)}if(0<T)c.unshift(d);else if(T<=0&&!1===y){if(c.shift(),!c.length){switch(d){case"end":var b,v,h=o.getCurrentTokenPosition();C=o.getCurrentTokenRange(),o.step(),o.step(),(a=o.getCurrentToken())&&(d=a.value.toLowerCase())in n?("else"==i||"elseif"==i?"if"!==d&&k.shift():d!=i&&k.shift(),v=(b=o.getCurrentTokenPosition()).column+d.length,C=new Range(h.row,h.column,b.row,v)):k.shift(),o.step=o.stepBackward,o.step(),o.step(),d=(a=o.getCurrentToken()).value.toLowerCase();break;case"select":case"sub":case"if":case"function":case"class":case"with":case"property":d!=i&&k.shift();break;case"do":"loop"!=i&&k.shift();break;case"loop":"do"!=i&&k.shift();break;case"for":"next"!=i&&k.shift();break;case"next":"for"!=i&&k.shift();break;case"while":"wend"!=i&&k.shift();break;case"wend":"while"!=i&&k.shift()}break}0===T&&c.unshift(d)}}}return a?r?(k.push(C||o.getCurrentTokenRange()),k):(t=o.getCurrentTokenRow(),-1===l?(v=e.getLine(t).length,new Range(t,v,w-1,s)):new Range(w,s,t-1,e.getLine(t-1).length)):null}}}}.call(FoldMode.prototype);