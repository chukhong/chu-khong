"use strict";var oop=require("../../lib/oop"),BaseFoldMode=require("./fold_mode").FoldMode,Range=require("../../range").Range,TokenIterator=require("../../token_iterator").TokenIterator,FoldMode=exports.FoldMode=function(){};oop.inherits(FoldMode,BaseFoldMode),function(){this.foldingStartMarker=/\b(function|then|do|repeat)\b|{\s*$|(\[=*\[)/,this.foldingStopMarker=/\bend\b|^\s*}|\]=*\]/,this.getFoldWidget=function(e,t,n){var r,o,i=e.getLine(n),a=this.foldingStartMarker.test(i),d=this.foldingStopMarker.test(i);if(a&&!d){if("then"==(r=i.match(this.foldingStartMarker))[1]&&/\belseif\b/.test(i))return;if(r[1]){if("keyword"===e.getTokenAt(n,r.index+1).type)return"start"}else{if(!r[2])return"start";if("bracketedComment"==(o=e.bgTokenizer.getState(n)||"")[0]||"bracketedString"==o[0])return"start"}}return"markbeginend"!=t||!d||a&&d?"":"end"!==(r=i.match(this.foldingStopMarker))[0]?"]"!==r[0][0]||"bracketedComment"==(o=e.bgTokenizer.getState(n-1)||"")[0]||"bracketedString"==o[0]?"end":void 0:"keyword"===e.getTokenAt(n,r.index+1).type?"end":void 0},this.getFoldWidgetRange=function(e,t,n){var r=e.doc.getLine(n),o=this.foldingStartMarker.exec(r);return o?o[1]?this.luaBlock(e,n,o.index+1):o[2]?e.getCommentFoldRange(n,o.index+1):this.openingBracketBlock(e,"{",n,o.index):(o=this.foldingStopMarker.exec(r))?"end"===o[0]&&"keyword"===e.getTokenAt(n,o.index+1).type?this.luaBlock(e,n,o.index+1):"]"===o[0][0]?e.getCommentFoldRange(n,o.index+1):this.closingBracketBlock(e,"}",n,o.index+o[0].length):void 0},this.luaBlock=function(e,t,n,r){var o=new TokenIterator(e,t,n),i={function:1,do:1,then:1,elseif:-1,end:-1,repeat:1,until:-1},a=o.getCurrentToken();if(a&&"keyword"==a.type){var n=a.value,d=[n],l=i[n];if(l){var n=-1===l?o.getCurrentTokenColumn():e.getLine(t).length,g=t;for(o.step=-1===l?o.stepBackward:o.stepForward;a=o.step();)if("keyword"===a.type){var s=l*i[a.value];if(0<s)d.unshift(a.value);else if(s<=0){if(d.shift(),!d.length&&"elseif"!=a.value)break;0==s&&d.unshift(a.value)}}return a?r?o.getCurrentTokenRange():(t=o.getCurrentTokenRow(),-1===l?new Range(t,e.getLine(t).length,g,n):new Range(g,n,t,o.getCurrentTokenColumn())):null}}}}.call(FoldMode.prototype);