"use strict";var lang=require("../lib/lang"),TextHighlightRules=function(){this.$rules={start:[{token:"empty_line",regex:"^$"},{defaultToken:"text"}]}};!function(){this.addRules=function(e,t){if(t)for(var n in e){for(var r=e[n],s=0;s<r.length;s++){var i=r[s];(i.next||i.onMatch)&&("string"==typeof i.next&&0!==i.next.indexOf(t)&&(i.next=t+i.next),i.nextState)&&0!==i.nextState.indexOf(t)&&(i.nextState=t+i.nextState)}this.$rules[t+n]=r}else for(var n in e)this.$rules[n]=e[n]},this.getRules=function(){return this.$rules},this.embedRules=function(e,t,n,r,s){e="function"==typeof e?(new e).getRules():e;if(r)for(var i=0;i<r.length;i++)r[i]=t+r[i];else for(var u in r=[],e)r.push(t+u);if(this.addRules(e,t),n)for(var a=Array.prototype[s?"push":"unshift"],i=0;i<r.length;i++)a.apply(this.$rules[r[i]],lang.deepCopy(n));this.$embeds||(this.$embeds=[]),this.$embeds.push(t)},this.getEmbeds=function(){return this.$embeds};function f(e,t){return"start"==e&&!t.length||t.unshift(this.nextState,e),this.nextState}function p(e,t){return t.shift(),t.shift()||"start"}this.normalizeRules=function(){var h=0,l=this.$rules;Object.keys(l).forEach(function e(t){var n=l[t];n.processed=!0;for(var r=0;r<n.length;r++){var s=n[r],i=null,u=(Array.isArray(s)&&(i=s,s={}),!s.regex&&s.start&&(s.regex=s.start,s.next||(s.next=[]),s.next.push({defaultToken:s.token},{token:s.token+".end",regex:s.end||s.start,next:"pop"}),s.token=s.token+".start",s.push=!0),s.next||s.push);if(u&&Array.isArray(u)?((o=s.stateName)||("string"!=typeof(o=s.token)&&(o=o[0]||""),l[o]&&(o+=h++)),l[o]=u,e(s.next=o)):"pop"==u&&(s.next=p),s.push&&(s.nextState=s.next||s.push,s.next=f,delete s.push),s.rules)for(var a in s.rules)l[a]?l[a].push&&l[a].push.apply(l[a],s.rules[a]):l[a]=s.rules[a];var o="string"==typeof s?s:s.include;(i=o?Array.isArray(o)?o.map(function(e){return l[e]}):l[o]:i)&&(u=[r,1].concat(i),s.noEscape&&(u=u.filter(function(e){return!e.next})),n.splice.apply(n,u),r--),s.keywordMap&&(s.token=this.createKeywordMapper(s.keywordMap,s.defaultToken||"text",s.caseInsensitive),delete s.defaultToken)}},this)},this.createKeywordMapper=function(s,t,i,u){var a=Object.create(null);return this.$keywordList=[],Object.keys(s).forEach(function(e){for(var t=s[e].split(u||"|"),n=t.length;n--;){var r=t[n];this.$keywordList.push(r),i&&(r=r.toLowerCase()),a[r]=e}},this),s=null,i?function(e){return a[e.toLowerCase()]||t}:function(e){return a[e]||t}},this.getKeywords=function(){return this.$keywords}}.call(TextHighlightRules.prototype),exports.TextHighlightRules=TextHighlightRules;