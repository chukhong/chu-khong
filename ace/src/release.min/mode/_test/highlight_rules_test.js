var fs=require("fs"),path=require("path"),regexpTokenizer=require("../../../tool/regexp_tokenizer"),EditSession=require("../../edit_session").EditSession,Editor=require("../../editor").Editor,MockRenderer=require("../../test/mockrenderer").MockRenderer,editor=(require("../../multi_select").MultiSelect,new Editor(new MockRenderer)),cwd=(fs.existsSync||(fs.existsSync=path.existsSync),require("amd-loader"),__dirname+"/"),root=path.normalize(cwd+Array(5).join("../"));function jsFileList(e,t){return t=t||/_test/,fs.readdirSync(e).map(function(e){if(".js"==e.slice(-3)&&!t.test(e)&&!/\s/.test(e))return e.slice(0,-3)}).filter(Boolean)}function modeList(){return jsFileList(cwd+"../",/_highlight_rules|_test|_worker|xml_util|_outdent|behaviour|completions/)}function checkModes(){var r={};if(modeList().forEach(function(t,e){console.log(padNumber(e+1,3)+") check: [33m"+t+"[0m");try{var n=require("../"+t).Mode}catch(e){return void console.warn("Can't load mode :"+t,e)}e=new n,e.lineCommentStart||e.blockComment||console.error("missing comment in "+t),e.$id||console.warn("missing id in "+t),e.$behaviour||console.warn("missing behavior in "+t),n=e.getTokenizer();o(e.lineCommentStart,s,n,t),o(e.blockComment,i,n,t),function(e,t){if(!/^(forth|mask)$/.test(t)){var n=new EditSession("{ foo[ bar(baz) ] }",e),r=n.getTokens(0).some(function(e){return/invalid|illegal|string/.test(e.type)});if(!r){r=n.findMatchingBracket({row:0,column:1});if(r&&18==r.column||a("Matching bracket not found in "+t),(r=n.findMatchingBracket({row:0,column:6}))&&16==r.column||a("Matching bracket not found in "+t),(r=n.findMatchingBracket({row:0,column:11}))&&14==r.column||a("Matching bracket not found in "+t),e.$behaviour){if(n.setValue(""),editor.setSession(n),editor.execCommand("insertstring","("),"()"!=editor.getValue())return console.log("() not paired in "+t);editor.execCommand("insertstring","("),"(())"!=editor.getValue()&&a("(()) not paired in "+t)}}}}(e,t),e.snippetFileId&&(r[e.snippetFileId]=t)}),jsFileList(cwd+"../../snippets").forEach(function(e){if(!/\.snippets$/.test(e)){if(!r["ace/snippets/"+e])throw new Error("Snippet file "+e+" is not used");delete r["ace/snippets/"+e]}}),Object.keys(r).length)throw console.error("Snippet files missing",r),new Error("Snippet files missing");function o(e,t,n,r){e&&(Array.isArray(e)?e.forEach(function(e){t(n,e,r)}):t(n,e,r))}function i(e,t,n){var r;t.lineStartOnly||(r=t.start+" "+t.end,r=t.start+r,t.nestable&&(r+=t.end),(t=e.getLineTokens(r,"start")).tokens.some(function(e){return!/comment/.test(e.type)})&&a("broken blockComment in "+n,t),/start/.test(t.state))||a("broken state after blockComment in "+n,t)}function s(e,t,n){e=e.getLineTokens(t+" ","start").tokens;/comment/.test(e[0].type)||a("broken lineCommentStart in "+n,e)}function a(){console.warn.apply(console,arguments),process.exit(1)}}function generateTestData(l,f){var d=root+"/demo/kitchen-sink/docs",e=fs.readdirSync(d),p=fs.readdirSync(cwd),g=modeList();e.forEach(function(e){var t=e.toLowerCase().split(".");if(t[1]){var n=-1!=g.indexOf(t[0])?t[0]:-1!=g.indexOf(t[1])?t[1]:{txt:"text",cpp:"c_cpp"}[t[1]];if(!l||!l.length||-1!=l.indexOf(n)){var r=cwd+"tokens_"+n+".json";try{var o=require(r)}catch(e){}o&&!f&&(u=o.map(function(e){return 1<e.length&&"string"==typeof e[e.length-1]?e[e.length-1]:e.slice(1).map(function(e){return e[1]}).join("")}).join("\n"));var i="text_"+n+".txt",i=-1!==p.indexOf(i)?cwd+i:d+"/"+e,e=u||fs.readFileSync(i,"utf8");try{var s=require("../"+n).Mode}catch(e){return void console.warn("Can't load mode :"+n,t,e)}console.log(n);var a=(new s).getTokenizer(),c="start",u="[[\n   "+e.split(/\r\n|\r|\n/).map(function(e){var t=a.getLineTokens(e,c),n=[],r=(n.push(JSON.stringify(t.state)),"");return t.tokens.forEach(function(e){r+=e.value,n.push(JSON.stringify([e.type,e.value]))}),r!=e&&n.push(JSON.stringify(e)),c=t.state,n.join(",\n  ")}).join("\n],[\n   ")+"\n]]";o&&JSON.stringify(JSON.parse(u))==JSON.stringify(o)||fs.writeFileSync(r,u,"utf8")}}})}function test(e){for(var t=fs.readdirSync(cwd).map(function(e){return(e.match(/tokens_(.*).json/)||{})[1]}).filter(function(e){return!!e}),n=Math.max(0,e||0);n<t.length;n++)testMode(t[n],n);console.log("[32mall ok[0m")}function testMode(e,t){console.log(padNumber(t+1,3)+") testing: [33m"+e+"[0m");var t=fs.readFileSync(cwd+"tokens_"+e+".json","utf8"),t=JSON.parse(t),i=(new(require("../"+e).Mode)).getTokenizer(),s=(checkBacktracking(i),"start");t.forEach(function(t){t.values=[],t.types=[],t.state=t.shift();var e=null,n=("string"==typeof t[t.length-1]&&(e=t.pop()),t.forEach(function(e){t.types.push(e[0]),t.values.push(e[1])}),"string"!=typeof e&&(e=t.values.join("")),i.getLineTokens(e,s)),r=n.tokens.map(function(e){return e.value}),o=n.tokens.map(function(e){return e.type});if(testEqual([JSON.stringify(t.state),JSON.stringify(n.state),t.types,o,t.values,r]))throw console.log(e),"error";s=n.state})}function testEqual(e){var t;return e[0]+""!=e[1]+""&&(console.log(e[0],e[1]),t=1),e[2]+""==e[3]+""&&e[4]+""==e[5]+""||(arrayDiff(e[2],e[3]),arrayDiff(e[4],e[5]),t=1),t}function arrayDiff(e,t){for(var n=Math.max(e.length,t.length),r=[],o=0;o<n;o++)r.push("\n",padNumber(o+1,3),") "),e[o]!==t[o]?r.push("[31m",e[o],"[0m != [32m",t[o],"[0m"):r.push(e[o]);console.log(r.join(""))}function padNumber(e,t){return("      "+e).slice(-t)}function maybeCatastrophicBacktracking(e){for(var t=regexpTokenizer.tokenize(e.source),n=[],r=[],o=0,i=0;i<t.length;i++){var s,a=t[i];if("group.start"==a.type&&(s=t.indexOf(a.end,i),(s=t[s+1])&&"quantifier"==s.type&&"?"!=s.value&&n.push(a.end),r.push(a.end)),"group.end"==a.type&&(n[n.length-1]==a&&n.pop(),r[r.length-1]==a&&r.pop(),0==r.length)&&o++,"quantifier"==a.type&&1<=n.length&&"?"!=a.value)return o}return null}function checkBacktracking(r){var o=r.regExps;Object.keys(o||{}).forEach(function(e){var t,n=maybeCatastrophicBacktracking(o[e]);null!=n&&(n=r.matchMappings[e][n],t=r.states[e][n],console.log("\tPossible error in",e,t&&t.token,n))})}var arg=process.argv[2];arg?/--?g(en)?/.test(arg)?generateTestData(process.argv.splice(3)):/--?c(heck)?/.test(arg)?checkModes():/\d+/.test(arg)?test(parseInt(process.argv[2],10)||0):testMode(arg,-1):(test(),checkModes());