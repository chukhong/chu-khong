"use strict";var context,oop=require("../../lib/oop"),Behaviour=require("../behaviour").Behaviour,TokenIterator=require("../../token_iterator").TokenIterator,lang=require("../../lib/lang"),SAFE_INSERT_IN_TOKENS=["text","paren.rparen","rparen","paren","punctuation.operator"],SAFE_INSERT_BEFORE_TOKENS=["text","paren.rparen","rparen","paren","punctuation.operator","comment"],contextCache={},defaultQuotes={'"':'"',"'":"'"},initContext=function(e){var t=-1;if((contextCache=e.multiSelect&&(t=e.selection.index,contextCache.rangeCount!=e.multiSelect.rangeCount)?{rangeCount:e.multiSelect.rangeCount}:contextCache)[t])return context=contextCache[t];context=contextCache[t]={autoInsertedBrackets:0,autoInsertedRow:-1,autoInsertedLineEnd:"",maybeInsertedBrackets:0,maybeInsertedRow:-1,maybeInsertedLineStart:"",maybeInsertedLineEnd:""}},getWrapped=function(e,t,n,o){var r=e.end.row-e.start.row;return{text:n+t+o,selection:[0,e.start.column+1,r,e.end.column+(r?0:1)]}},CstyleBehaviour=function(d){this.add("braces","insertion",function(e,t,n,o,r){var i=n.getCursorPosition(),s=o.doc.getLine(i.row);if("{"==r)return initContext(n),a=n.getSelectionRange(),""!==(c=o.doc.getTextRange(a))&&"{"!==c&&n.getWrapBehavioursEnabled()?getWrapped(a,c,"{","}"):CstyleBehaviour.isSaneInsertion(n,o)?/[\]\}\)]/.test(s[i.column])||n.inMultiSelectMode||d&&d.braces?(CstyleBehaviour.recordAutoInsert(n,o,"}"),{text:"{}",selection:[1,1]}):(CstyleBehaviour.recordMaybeInsert(n,o,"{"),{text:"{",selection:[1,1]}):void 0;if("}"==r){initContext(n);var u=s.substring(i.column,i.column+1);if("}"==u)if(null!==o.$findOpeningBracket("}",{column:i.column+1,row:i.row})&&CstyleBehaviour.isAutoInsertedClosing(i,s,r))return CstyleBehaviour.popAutoInsertedClosing(),{text:"",selection:[1,1]}}else{if("\n"==r||"\r\n"==r){initContext(n);var a="";if(CstyleBehaviour.isMaybeInsertedClosing(i,s)&&(a=lang.stringRepeat("}",context.maybeInsertedBrackets),CstyleBehaviour.clearMaybeInsertedClosing()),"}"===(u=s.substring(i.column,i.column+1))){var c=o.findMatchingBracket({row:i.row,column:i.column+1},"}");if(!c)return null;var l=this.$getIndent(o.getLine(c.row))}else{if(!a)return void CstyleBehaviour.clearMaybeInsertedClosing();l=this.$getIndent(s)}r=l+o.getTabString();return{text:"\n"+r+"\n"+l+a,selection:[1,r.length,1,r.length]}}CstyleBehaviour.clearMaybeInsertedClosing()}}),this.add("braces","deletion",function(e,t,n,o,r){var i=o.doc.getTextRange(r);if(!r.isMultiLine()&&"{"==i){if(initContext(n),"}"==o.doc.getLine(r.start.row).substring(r.end.column,r.end.column+1))return r.end.column++,r;context.maybeInsertedBrackets--}}),this.add("parens","insertion",function(e,t,n,o,r){if("("==r)return initContext(n),i=n.getSelectionRange(),""!==(s=o.doc.getTextRange(i))&&n.getWrapBehavioursEnabled()?getWrapped(i,s,"(",")"):CstyleBehaviour.isSaneInsertion(n,o)?(CstyleBehaviour.recordAutoInsert(n,o,")"),{text:"()",selection:[1,1]}):void 0;if(")"==r){initContext(n);var i=n.getCursorPosition(),s=o.doc.getLine(i.row),n=s.substring(i.column,i.column+1);if(")"==n)if(null!==o.$findOpeningBracket(")",{column:i.column+1,row:i.row})&&CstyleBehaviour.isAutoInsertedClosing(i,s,r))return CstyleBehaviour.popAutoInsertedClosing(),{text:"",selection:[1,1]}}}),this.add("parens","deletion",function(e,t,n,o,r){var i=o.doc.getTextRange(r);if(!r.isMultiLine()&&"("==i&&(initContext(n),")"==o.doc.getLine(r.start.row).substring(r.start.column+1,r.start.column+2)))return r.end.column++,r}),this.add("brackets","insertion",function(e,t,n,o,r){if("["==r)return initContext(n),i=n.getSelectionRange(),""!==(s=o.doc.getTextRange(i))&&n.getWrapBehavioursEnabled()?getWrapped(i,s,"[","]"):CstyleBehaviour.isSaneInsertion(n,o)?(CstyleBehaviour.recordAutoInsert(n,o,"]"),{text:"[]",selection:[1,1]}):void 0;if("]"==r){initContext(n);var i=n.getCursorPosition(),s=o.doc.getLine(i.row),n=s.substring(i.column,i.column+1);if("]"==n)if(null!==o.$findOpeningBracket("]",{column:i.column+1,row:i.row})&&CstyleBehaviour.isAutoInsertedClosing(i,s,r))return CstyleBehaviour.popAutoInsertedClosing(),{text:"",selection:[1,1]}}}),this.add("brackets","deletion",function(e,t,n,o,r){var i=o.doc.getTextRange(r);if(!r.isMultiLine()&&"["==i&&(initContext(n),"]"==o.doc.getLine(r.start.row).substring(r.start.column+1,r.start.column+2)))return r.end.column++,r}),this.add("string_dquotes","insertion",function(e,t,n,o,r){var i=o.$mode.$quotes||defaultQuotes;if(1==r.length&&i[r]&&(!this.lineCommentStart||-1==this.lineCommentStart.indexOf(r))){initContext(n);var s=n.getSelectionRange(),u=o.doc.getTextRange(s);if(!(""===u||1==u.length&&i[u])&&n.getWrapBehavioursEnabled())return getWrapped(s,u,r,r);if(!u){var i=n.getCursorPosition(),s=o.doc.getLine(i.row),u=s.substring(i.column-1,i.column),n=s.substring(i.column,i.column+1),a=o.getTokenAt(i.row,i.column),c=o.getTokenAt(i.row,i.column+1);if("\\"==u&&a&&/escape/.test(a.type))return null;var l,a=a&&/string|escape/.test(a.type),d=!c||/string|escape/.test(c.type);if(n==r)(l=a!==d)&&/string\.end/.test(c.type)&&(l=!1);else{if(a&&!d)return null;if(a&&d)return null;c=o.$mode.tokenRe,a=(c.lastIndex=0,c.test(u)),d=(c.lastIndex=0,c.test(u));if(a||d)return null;if(n&&!/[\s;,.})\]\\]/.test(n))return null;o=s[i.column-2];if(u==r&&(o==r||c.test(o)))return null;l=!0}return{text:l?r+r:"",selection:[1,1]}}}}),this.add("string_dquotes","deletion",function(e,t,n,o,r){var i=o.$mode.$quotes||defaultQuotes,s=o.doc.getTextRange(r);if(!r.isMultiLine()&&i.hasOwnProperty(s)&&(initContext(n),o.doc.getLine(r.start.row).substring(r.start.column+1,r.start.column+2)==s))return r.end.column++,r})};CstyleBehaviour.isSaneInsertion=function(e,t){var n=e.getCursorPosition(),o=new TokenIterator(t,n.row,n.column);if(!this.$matchTokenType(o.getCurrentToken()||"text",SAFE_INSERT_IN_TOKENS)){if(/[)}\]]/.test(e.session.getLine(n.row)[n.column]))return!0;e=new TokenIterator(t,n.row,n.column+1);if(!this.$matchTokenType(e.getCurrentToken()||"text",SAFE_INSERT_IN_TOKENS))return!1}return o.stepForward(),o.getCurrentTokenRow()!==n.row||this.$matchTokenType(o.getCurrentToken()||"text",SAFE_INSERT_BEFORE_TOKENS)},CstyleBehaviour.$matchTokenType=function(e,t){return-1<t.indexOf(e.type||e)},CstyleBehaviour.recordAutoInsert=function(e,t,n){e=e.getCursorPosition(),t=t.doc.getLine(e.row);this.isAutoInsertedClosing(e,t,context.autoInsertedLineEnd[0])||(context.autoInsertedBrackets=0),context.autoInsertedRow=e.row,context.autoInsertedLineEnd=n+t.substr(e.column),context.autoInsertedBrackets++},CstyleBehaviour.recordMaybeInsert=function(e,t,n){e=e.getCursorPosition(),t=t.doc.getLine(e.row);this.isMaybeInsertedClosing(e,t)||(context.maybeInsertedBrackets=0),context.maybeInsertedRow=e.row,context.maybeInsertedLineStart=t.substr(0,e.column)+n,context.maybeInsertedLineEnd=t.substr(e.column),context.maybeInsertedBrackets++},CstyleBehaviour.isAutoInsertedClosing=function(e,t,n){return 0<context.autoInsertedBrackets&&e.row===context.autoInsertedRow&&n===context.autoInsertedLineEnd[0]&&t.substr(e.column)===context.autoInsertedLineEnd},CstyleBehaviour.isMaybeInsertedClosing=function(e,t){return 0<context.maybeInsertedBrackets&&e.row===context.maybeInsertedRow&&t.substr(e.column)===context.maybeInsertedLineEnd&&t.substr(0,e.column)==context.maybeInsertedLineStart},CstyleBehaviour.popAutoInsertedClosing=function(){context.autoInsertedLineEnd=context.autoInsertedLineEnd.substr(1),context.autoInsertedBrackets--},CstyleBehaviour.clearMaybeInsertedClosing=function(){context&&(context.maybeInsertedBrackets=0,context.maybeInsertedRow=-1)},oop.inherits(CstyleBehaviour,Behaviour),exports.CstyleBehaviour=CstyleBehaviour;