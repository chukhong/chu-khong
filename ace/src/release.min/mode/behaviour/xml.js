"use strict";var oop=require("../../lib/oop"),Behaviour=require("../behaviour").Behaviour,TokenIterator=require("../../token_iterator").TokenIterator,lang=require("../../lib/lang");function is(e,t){return e&&-1<e.type.lastIndexOf(t+".xml")}var XmlBehaviour=function(){this.add("string_dquotes","insertion",function(e,t,r,n,i){if('"'==i||"'"==i){var o=n.doc.getTextRange(r.getSelectionRange());if(""!==o&&"'"!==o&&'"'!=o&&r.getWrapBehavioursEnabled())return{text:i+o+i,selection:!1};var o=r.getCursorPosition(),r=n.doc.getLine(o.row).substring(o.column,o.column+1),a=new TokenIterator(n,o.row,o.column),s=a.getCurrentToken();if(r==i&&(is(s,"attribute-value")||is(s,"string")))return{text:"",selection:[1,1]};if(s=s||a.stepBackward()){for(;is(s,"tag-whitespace")||is(s,"whitespace");)s=a.stepBackward();n=!r||r.match(/\s/);return is(s,"attribute-equals")&&(n||">"==r)||is(s,"decl-attribute-equals")&&(n||"?"==r)?{text:i+i,selection:[1,1]}:void 0}}}),this.add("string_dquotes","deletion",function(e,t,r,n,i){var o=n.doc.getTextRange(i);if(!i.isMultiLine()&&('"'==o||"'"==o)&&n.doc.getLine(i.start.row).substring(i.start.column+1,i.start.column+2)==o)return i.end.column++,i}),this.add("autoclosing","insertion",function(e,t,r,n,i){if(">"==i){var i=r.getSelectionRange().start,o=new TokenIterator(n,i.row,i.column),a=o.getCurrentToken()||o.stepBackward();if(a&&(is(a,"tag-name")||is(a,"tag-whitespace")||is(a,"attribute-name")||is(a,"attribute-equals")||is(a,"attribute-value"))&&!is(a,"reference.attribute-value")){if(is(a,"attribute-value")){r=o.getCurrentTokenColumn()+a.value.length;if(i.column<r)return;if(i.column==r){r=o.stepForward();if(r&&is(r,"attribute-value"))return;o.stepBackward()}}if(!/^\s*>/.test(n.getLine(i.row).slice(i.column))){for(;!is(a,"tag-name");)if("<"==(a=o.stepBackward()).value){a=o.stepForward();break}r=o.getCurrentTokenRow(),n=o.getCurrentTokenColumn();if(!is(o.stepBackward(),"end-tag-open")){var s=a.value;if(r==i.row&&(s=s.substring(0,i.column-n)),!this.voidElements.hasOwnProperty(s.toLowerCase()))return{text:"></"+s+">",selection:[1,1]}}}}}}),this.add("autoindent","insertion",function(e,t,r,n,i){if("\n"==i){var o,a,i=r.getCursorPosition(),r=n.getLine(i.row),s=new TokenIterator(n,i.row,i.column),u=s.getCurrentToken();if(u&&-1!==u.type.indexOf("tag-close")&&"/>"!=u.value){for(;u&&-1===u.type.indexOf("tag-name");)u=s.stepBackward();if(u)return o=u.value,a=s.getCurrentTokenRow(),(u=s.stepBackward())&&-1===u.type.indexOf("end-tag")&&this.voidElements&&!this.voidElements[o]?(o=n.getTokenAt(i.row,i.column+1),r=n.getLine(a),a=(i=this.$getIndent(r))+n.getTabString(),o&&"</"===o.value?{text:"\n"+a+"\n"+i,selection:[1,a.length,1,a.length]}:{text:"\n"+a}):void 0}}})};oop.inherits(XmlBehaviour,Behaviour),exports.XmlBehaviour=XmlBehaviour;