"use strict";var Range=require("./range").Range,EventEmitter=require("./lib/event_emitter").EventEmitter,oop=require("./lib/oop"),PlaceHolder=function(t,s,e,o,i,n){var r=this,s=(this.length=s,this.session=t,this.doc=t.getDocument(),this.mainClass=i,this.othersClass=n,this.$onUpdate=this.onUpdate.bind(this),this.doc.on("change",this.$onUpdate,!0),this.$others=o,this.$onCursorChange=function(){setTimeout(function(){r.onCursorChange()})},this.$pos=e,t.getUndoManager().$undoStack||t.getUndoManager().$undostack||{length:-1});this.$undoStackDepth=s.length,this.setup(),t.selection.on("changeCursor",this.$onCursorChange)};!function(){oop.implement(this,EventEmitter),this.setup=function(){var s=this,e=this.doc,t=this.session,o=(this.selectionBefore=t.selection.toJSON(),t.selection.inMultiSelectMode&&t.selection.toSingleRange(),this.pos=e.createAnchor(this.$pos.row,this.$pos.column),this.pos);o.$insertRight=!0,o.detach(),o.markerId=t.addMarker(new Range(o.row,o.column,o.row,o.column+this.length),this.mainClass,null,!1),this.others=[],this.$others.forEach(function(t){t=e.createAnchor(t.row,t.column);t.$insertRight=!0,t.detach(),s.others.push(t)}),t.setUndoSelect(!1)},this.showOtherMarkers=function(){var s,e;this.othersActive||(s=this.session,(e=this).othersActive=!0,this.others.forEach(function(t){t.markerId=s.addMarker(new Range(t.row,t.column,t.row,t.column+e.length),e.othersClass,null,!1)}))},this.hideOtherMarkers=function(){if(this.othersActive){this.othersActive=!1;for(var t=0;t<this.others.length;t++)this.session.removeMarker(this.others[t].markerId)}},this.onUpdate=function(t){if(this.$updating)return this.updateAnchors(t);var s=t;if(s.start.row===s.end.row&&s.start.row===this.pos.row){this.$updating=!0;var e="insert"===t.action?s.end.column-s.start.column:s.start.column-s.end.column,o=s.start.column>=this.pos.column&&s.start.column<=this.pos.column+this.length+1,i=s.start.column-this.pos.column;if(this.updateAnchors(t),o&&(this.length+=e),o&&!this.session.$fromUndo)if("insert"===t.action)for(var n=this.others.length-1;0<=n;n--){var r={row:(h=this.others[n]).row,column:h.column+i};this.doc.insertMergedLines(r,t.lines)}else if("remove"===t.action)for(n=this.others.length-1;0<=n;n--){var h,r={row:(h=this.others[n]).row,column:h.column+i};this.doc.remove(new Range(r.row,r.column,r.row,r.column-e))}this.$updating=!1,this.updateMarkers()}},this.updateAnchors=function(t){this.pos.onChange(t);for(var s=this.others.length;s--;)this.others[s].onChange(t);this.updateMarkers()},this.updateMarkers=function(){if(!this.$updating){var e=this,o=this.session,t=function(t,s){o.removeMarker(t.markerId),t.markerId=o.addMarker(new Range(t.row,t.column,t.row,t.column+e.length),s,null,!1)};t(this.pos,this.mainClass);for(var s=this.others.length;s--;)t(this.others[s],this.othersClass)}},this.onCursorChange=function(t){var s;!this.$updating&&this.session&&((s=this.session.selection.getCursor()).row===this.pos.row&&s.column>=this.pos.column&&s.column<=this.pos.column+this.length?(this.showOtherMarkers(),this._emit("cursorEnter",t)):(this.hideOtherMarkers(),this._emit("cursorLeave",t)))},this.detach=function(){this.session.removeMarker(this.pos&&this.pos.markerId),this.hideOtherMarkers(),this.doc.off("change",this.$onUpdate),this.session.selection.off("changeCursor",this.$onCursorChange),this.session.setUndoSelect(!0),this.session=null},this.cancel=function(){if(-1!==this.$undoStackDepth){for(var t=this.session.getUndoManager(),s=(t.$undoStack||t.$undostack).length-this.$undoStackDepth,e=0;e<s;e++)t.undo(this.session,!0);this.selectionBefore&&this.session.selection.fromJSON(this.selectionBefore)}}}.call(PlaceHolder.prototype),exports.PlaceHolder=PlaceHolder;