"use strict";var HashHandler=require("./keyboard/hash_handler").HashHandler,AcePopup=require("./autocomplete/popup").AcePopup,util=require("./autocomplete/util"),lang=require("./lib/lang"),dom=require("./lib/dom"),snippetManager=require("./snippets").snippetManager,config=require("./config"),Autocomplete=function(){this.autoInsert=!1,this.autoSelect=!0,this.exactMatch=!1,this.gatherCompletionsId=0,this.keyboardHandler=new HashHandler,this.keyboardHandler.bindKeys(this.commands),this.blurListener=this.blurListener.bind(this),this.changeListener=this.changeListener.bind(this),this.mousedownListener=this.mousedownListener.bind(this),this.mousewheelListener=this.mousewheelListener.bind(this),this.changeTimer=lang.delayedCall(function(){this.updateCompletions(!0)}.bind(this)),this.tooltipTimer=lang.delayedCall(this.updateDocTooltip.bind(this),50)},FilteredList=(!function(){this.$init=function(){return this.popup=new AcePopup(document.body||document.documentElement),this.popup.on("click",function(t){this.insertMatch(),t.stop()}.bind(this)),this.popup.focus=this.editor.focus.bind(this.editor),this.popup.on("show",this.tooltipTimer.bind(null,null)),this.popup.on("select",this.tooltipTimer.bind(null,null)),this.popup.on("changeHoverMarker",this.tooltipTimer.bind(null,null)),this.popup},this.getPopup=function(){return this.popup||this.$init()},this.openPopup=function(t,e,i){this.popup||this.$init(),this.popup.autoSelect=this.autoSelect,this.popup.setData(this.completions.filtered,this.completions.filterText),t.keyBinding.addKeyboardHandler(this.keyboardHandler);var o,s=t.renderer;this.popup.setRow(this.autoSelect?0:-1),i?e||this.detach():(this.popup.setTheme(t.getTheme()),this.popup.setFontSize(t.getFontSize()),i=s.layerConfig.lineHeight,(e=s.$cursorLayer.getPixelPosition(this.base,!0)).left-=this.popup.getTextLeftOffset(),o=t.container.getBoundingClientRect(),e.top+=o.top-s.layerConfig.offset,e.left+=o.left-t.renderer.scrollLeft,e.left+=s.gutterWidth,this.popup.show(e,i)),this.changeTimer.cancel()},this.detach=function(){this.editor.keyBinding.removeKeyboardHandler(this.keyboardHandler),this.editor.off("changeSelection",this.changeListener),this.editor.off("blur",this.blurListener),this.editor.off("mousedown",this.mousedownListener),this.editor.off("mousewheel",this.mousewheelListener),this.changeTimer.cancel(),this.hideDocTooltip(),this.gatherCompletionsId+=1,this.popup&&this.popup.isOpen&&this.popup.hide(),this.base&&this.base.detach(),this.activated=!1,this.completions=this.base=null},this.changeListener=function(t){var e=this.editor.selection.lead;(e.row!=this.base.row||e.column<this.base.column)&&this.detach(),this.activated?this.changeTimer.schedule():this.detach()},this.blurListener=function(t){var e=document.activeElement,i=this.editor.textInput.getElement(),o=t.relatedTarget&&this.tooltipNode&&this.tooltipNode.contains(t.relatedTarget),s=this.popup&&this.popup.container;e==i||e.parentNode==s||o||e==this.tooltipNode||t.relatedTarget==i||this.detach()},this.mousedownListener=function(t){this.detach()},this.mousewheelListener=function(t){this.detach()},this.goTo=function(t){this.popup.goTo(t)},this.insertMatch=function(t,e){if(!(t=t||this.popup.getData(this.popup.getRow())))return!1;var i=this.completions;if(this.editor.startOperation({command:{name:"insertMatch"}}),t.completer&&t.completer.insertMatch)t.completer.insertMatch(this.editor,t);else{if(!i)return!1;if(i.filterText)for(var o,s=this.editor.selection.getAllRanges(),n=0;o=s[n];n++)o.start.column-=i.filterText.length,this.editor.session.remove(o);t.snippet?snippetManager.insertSnippet(this.editor,t.snippet):this.editor.execCommand("insertstring",t.value||t)}this.completions==i&&this.detach(),this.editor.endOperation()},this.commands={Up:function(t){t.completer.goTo("up")},Down:function(t){t.completer.goTo("down")},"Ctrl-Up|Ctrl-Home":function(t){t.completer.goTo("start")},"Ctrl-Down|Ctrl-End":function(t){t.completer.goTo("end")},Esc:function(t){t.completer.detach()},Return:function(t){return t.completer.insertMatch()},"Shift-Return":function(t){t.completer.insertMatch(null,{deleteSuffix:!0})},Tab:function(t){var e=t.completer.insertMatch();if(e||t.tabstopManager)return e;t.completer.goTo("down")},PageUp:function(t){t.completer.popup.gotoPageUp()},PageDown:function(t){t.completer.popup.gotoPageDown()}},this.gatherCompletions=function(i,o){var s=i.getSession(),n=i.getCursorPosition(),r=util.getCompletionPrefix(i),h=(this.base=s.doc.createAnchor(n.row,n.column-r.length),this.base.$insertRight=!0,[]),l=i.completers.length;return i.completers.forEach(function(t,e){t.getCompletions(i,s,n,r,function(t,e){!t&&e&&(h=h.concat(e)),o(null,{prefix:util.getCompletionPrefix(i),matches:h,finished:0==--l})})}),!0},this.showPopup=function(t,e){this.editor&&this.detach(),this.activated=!0,(this.editor=t).completer!=this&&(t.completer&&t.completer.detach(),t.completer=this),t.on("changeSelection",this.changeListener),t.on("blur",this.blurListener),t.on("mousedown",this.mousedownListener),t.on("mousewheel",this.mousewheelListener),this.updateCompletions(!1,e)},this.updateCompletions=function(o,t){var e,s,n,r,h,i,l;return o&&this.base&&this.completions?(e=this.editor.getCursorPosition(),(i=this.editor.session.getTextRange({start:this.base,end:e}))==this.completions.filterText?void 0:(this.completions.setFilter(i),this.completions.filtered.length&&(1!=this.completions.filtered.length||this.completions.filtered[0].value!=i||this.completions.filtered[0].snippet)?void this.openPopup(this.editor,i,o):this.detach())):t&&t.matches?(e=this.editor.getSelectionRange().start,this.base=this.editor.session.doc.createAnchor(e.row,e.column),this.base.$insertRight=!0,this.completions=new FilteredList(t.matches),this.openPopup(this.editor,"",o)):(s=this.gatherCompletionsId,n=function(t){if(t.finished)return this.detach()}.bind(this),r=function(t){var e=t.prefix,i=t.matches,i=(this.completions=new FilteredList(i),this.exactMatch&&(this.completions.exactMatch=!0),this.completions.setFilter(e),this.completions.filtered);return i.length&&(1!=i.length||i[0].value!=e||i[0].snippet)?this.autoInsert&&1==i.length&&t.finished?this.insertMatch(i[0]):void this.openPopup(this.editor,e,o):n(t)}.bind(this),h=!0,l=null,this.gatherCompletions(this.editor,function(t,e){var i=e.prefix,o=e&&e.matches;if(!o||!o.length)return n(e);0===i.indexOf(e.prefix)&&s==this.gatherCompletionsId&&(h?l=e:r(e))}.bind(this)),h=!1,void(l&&(i=l,l=null,r(i))))},this.cancelContextMenu=function(){this.editor.$mouseHandler.cancelContextMenu()},this.updateDocTooltip=function(){var t=this.popup,e=t.data,i=e&&(e[t.getHoveredRow()]||e[t.getRow()]),o=null;return i&&this.editor&&this.popup.isOpen&&(this.editor.completers.some(function(t){return o=t.getDocTooltip?t.getDocTooltip(i):o}),o="string"==typeof(o=o||"string"==typeof i?o:i)?{docText:o}:o)&&(o.docHTML||o.docText)?void this.showDocTooltip(o):this.hideDocTooltip()},this.showDocTooltip=function(t){this.tooltipNode||(this.tooltipNode=dom.createElement("div"),this.tooltipNode.className="ace_tooltip ace_doc-tooltip",this.tooltipNode.style.margin=0,this.tooltipNode.style.pointerEvents="auto",this.tooltipNode.tabIndex=-1,this.tooltipNode.onblur=this.blurListener.bind(this),this.tooltipNode.onclick=this.onTooltipClick.bind(this));var e=this.tooltipNode,t=(t.docHTML?e.innerHTML=t.docHTML:t.docText&&(e.textContent=t.docText),e.parentNode||document.body.appendChild(e),this.popup),i=t.container.getBoundingClientRect();e.style.top=t.container.style.top,e.style.bottom=t.container.style.bottom,e.style.display="block",window.innerWidth-i.right<320?i.left<320?(t.isTopdown?e.style.top=i.bottom+"px":e.style.top=t.container.offsetTop-e.offsetHeight+"px",e.style.left=i.left+"px",e.style.right="",e.style.bottom=""):(e.style.right=window.innerWidth-i.left+"px",e.style.left=""):(e.style.left=i.right+1+"px",e.style.right="")},this.hideDocTooltip=function(){var t;this.tooltipTimer.cancel(),this.tooltipNode&&(t=this.tooltipNode,this.editor.isFocused()||document.activeElement!=t||this.editor.focus(),this.tooltipNode=null,t.parentNode)&&t.parentNode.removeChild(t)},this.onTooltipClick=function(t){for(var e=t.target;e&&e!=this.tooltipNode;){if("A"==e.nodeName&&e.href){e.rel="noreferrer",e.target="_blank";break}e=e.parentNode}},this.destroy=function(){var t;this.detach(),this.popup&&(this.popup.destroy(),t=this.popup.container)&&t.parentNode&&t.parentNode.removeChild(t),this.editor&&this.editor.completer==this&&this.editor.completer,this.popup=null}}.call(Autocomplete.prototype),Autocomplete.for=function(t){return t.completer||(config.get("sharedPopups")?(Autocomplete.$shared||(Autocomplete.$sharedInstance=new Autocomplete),t.completer=Autocomplete.$sharedInstance):(t.completer=new Autocomplete,t.once("destroy",function(t,e){e.completer.destroy()}))),t.completer},Autocomplete.startCommand={name:"startAutocomplete",exec:function(t,e){var i=Autocomplete.for(t);i.autoInsert=!1,i.autoSelect=!0,i.showPopup(t,e),i.cancelContextMenu()},bindKey:"Ctrl-Space|Ctrl-Shift-Space|Alt-Space"},function(t,e){this.all=t,this.filtered=t,this.filterText=e||"",this.exactMatch=!1});!function(){this.setFilter=function(t){e=t.length>this.filterText&&0===t.lastIndexOf(this.filterText,0)?this.filtered:this.all,this.filterText=t,e=(e=this.filterCompletions(e,this.filterText)).sort(function(t,e){return e.exactMatch-t.exactMatch||e.$score-t.$score||(t.caption||t.value).localeCompare(e.caption||e.value)});var e,i=null;e=e.filter(function(t){t=t.snippet||t.caption||t.value;return t!==i&&(i=t,!0)}),this.filtered=e},this.filterCompletions=function(t,e){var i=[],o=e.toUpperCase(),s=e.toLowerCase();t:for(var n,r=0;n=t[r];r++){var h=n.caption||n.value||n.snippet;if(h){var l=-1,p=0,c=0;if(this.exactMatch){if(e!==h.substr(0,e.length))continue}else{var a=h.toLowerCase().indexOf(s);if(-1<a)c=a;else for(var d=0;d<e.length;d++){var u=h.indexOf(s[d],l+1),m=h.indexOf(o[d],l+1);if((u=0<=u&&(m<0||u<m)?u:m)<0)continue t;0<(m=u-l-1)&&(-1===l&&(c+=10),c+=m,p|=1<<d),l=u}}n.matchMask=p,n.exactMatch=c?0:1,n.$score=(n.score||0)-c,i.push(n)}}return i}}.call(FilteredList.prototype),exports.Autocomplete=Autocomplete,exports.FilteredList=FilteredList;