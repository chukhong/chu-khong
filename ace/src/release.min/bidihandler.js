"use strict";var bidiUtil=require("./lib/bidiutil"),lang=require("./lib/lang"),bidiRE=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac\u202B]/,BidiHandler=function(i){this.session=i,this.bidiMap={},this.currentRow=null,this.bidiUtil=bidiUtil,this.charWidths=[],this.EOL="¬",this.showInvisibles=!0,this.isRtlDir=!1,this.$isRtl=!1,this.line="",this.wrapIndent=0,this.EOF="¶",this.RLE="‫",this.contentWidth=0,this.fontMetrics=null,this.rtlLineOffset=0,this.wrapOffset=0,this.isMoveLeftOperation=!1,this.seenBidi=bidiRE.test(i.getValue())};!function(){this.isBidiRow=function(i,t,s){return!!this.seenBidi&&(i!==this.currentRow&&(this.currentRow=i,this.updateRowLine(t,s),this.updateBidiMap()),this.bidiMap.bidiLevels)},this.onChange=function(i){this.seenBidi?this.currentRow=null:"insert"==i.action&&bidiRE.test(i.lines.join("\n"))&&(this.seenBidi=!0,this.currentRow=null)},this.getDocumentRow=function(){var i=0,t=this.session.$screenRowCache;return i=t.length&&0<=(t=this.session.$getRowCacheIndex(t,this.currentRow))?this.session.$docRowCache[t]:i},this.getSplitIndex=function(){var i=0,t=this.session.$screenRowCache;if(t.length)for(var s,e=this.session.$getRowCacheIndex(t,this.currentRow);0<this.currentRow-i&&(s=this.session.$getRowCacheIndex(t,this.currentRow-i-1))===e;)e=s,i++;else i=this.currentRow;return i},this.updateRowLine=function(i,t){var s,e=(i=void 0===i?this.getDocumentRow():i)===this.session.getLength()-1?this.EOF:this.EOL,h=(this.wrapIndent=0,this.line=this.session.getLine(i),this.isRtlDir=this.$isRtl||this.line.charAt(0)===this.RLE,(!this.session.$useWrapMode||(i=this.session.$wrapData[i])&&(0<(t=void 0===t?this.getSplitIndex():t)&&i.length?(this.wrapIndent=i.indent,this.wrapOffset=this.wrapIndent*this.charWidths[bidiUtil.L],this.line=t<i.length?this.line.substring(i[t-1],i[t]):this.line.substring(i[i.length-1])):this.line=this.line.substring(0,i[t]),t==i.length))&&(this.line+=this.showInvisibles?e:bidiUtil.DOT),this.session),n=0;this.line=this.line.replace(/\t|[\u1100-\u2029, \u202F-\uFFE6]/g,function(i,t){return"\t"===i||h.isFullWidth(i.charCodeAt(0))?(s="\t"===i?h.getScreenTabSize(t+n):2,n+=s-1,lang.stringRepeat(bidiUtil.DOT,s)):i}),this.isRtlDir&&(this.fontMetrics.$main.textContent=this.line.charAt(this.line.length-1)==bidiUtil.DOT?this.line.substr(0,this.line.length-1):this.line,this.rtlLineOffset=this.contentWidth-this.fontMetrics.$main.getBoundingClientRect().width)},this.updateBidiMap=function(){var i=[];bidiUtil.hasBidiCharacters(this.line,i)||this.isRtlDir?this.bidiMap=bidiUtil.doBidiReorder(this.line,i,this.isRtlDir):this.bidiMap={}},this.markAsDirty=function(){this.currentRow=null},this.updateCharacterWidths=function(i){var t;this.characterWidth!==i.$characterSize.width&&(this.fontMetrics=i,t=this.characterWidth=i.$characterSize.width,i=i.$measureCharWidth("ה"),this.charWidths[bidiUtil.L]=this.charWidths[bidiUtil.EN]=this.charWidths[bidiUtil.ON_R]=t,this.charWidths[bidiUtil.R]=this.charWidths[bidiUtil.AN]=i,this.charWidths[bidiUtil.R_H]=.45*i,this.charWidths[bidiUtil.B]=this.charWidths[bidiUtil.RLE]=0,this.currentRow=null)},this.setShowInvisibles=function(i){this.showInvisibles=i,this.currentRow=null},this.setEolChar=function(i){this.EOL=i},this.setContentWidth=function(i){this.contentWidth=i},this.isRtlLine=function(i){return!!this.$isRtl||(null!=i?this.session.getLine(i).charAt(0)==this.RLE:this.isRtlDir)},this.setRtlDirection=function(i,t){for(var s=i.getCursorPosition(),e=i.selection.getSelectionAnchor().row;e<=s.row;e++)t||i.session.getLine(e).charAt(0)!==i.session.$bidiHandler.RLE?t&&i.session.getLine(e).charAt(0)!==i.session.$bidiHandler.RLE&&i.session.doc.insert({column:0,row:e},i.session.$bidiHandler.RLE):i.session.doc.removeInLine(e,0,1)},this.getPosLeft=function(i){i-=this.wrapIndent;var t=this.line.charAt(0)===this.RLE?1:0,s=t<i?this.session.getOverwrite()?i:i-1:t,e=bidiUtil.getVisualFromLogicalIdx(s,this.bidiMap),h=this.bidiMap.bidiLevels,n=0;!this.session.getOverwrite()&&i<=t&&h[e]%2!=0&&e++;for(var r=0;r<e;r++)n+=this.charWidths[h[r]];return!this.session.getOverwrite()&&t<i&&h[e]%2==0&&(n+=this.charWidths[h[e]]),this.wrapIndent&&(n+=this.isRtlDir?-1*this.wrapOffset:this.wrapOffset),this.isRtlDir&&(n+=this.rtlLineOffset),n},this.getSelections=function(i,t){var s,e=this.bidiMap,h=e.bidiLevels,n=[],r=0,l=Math.min(i,t)-this.wrapIndent,a=Math.max(i,t)-this.wrapIndent,o=!1,d=!1,c=0;this.wrapIndent&&(r+=this.isRtlDir?-1*this.wrapOffset:this.wrapOffset);for(var u,f=0;f<h.length;f++)u=e.logicalFromVisual[f],s=h[f],(o=l<=u&&u<a)&&!d?c=r:!o&&d&&n.push({left:c,width:r-c}),r+=this.charWidths[s],d=o;if(o&&f===h.length&&n.push({left:c,width:r-c}),this.isRtlDir)for(var R=0;R<n.length;R++)n[R].left+=this.rtlLineOffset;return n},this.offsetToCol=function(i){this.isRtlDir&&(i-=this.rtlLineOffset);var t=0,i=Math.max(i,0),s=0,e=0,h=this.bidiMap.bidiLevels,n=this.charWidths[h[e]];for(this.wrapIndent&&(i-=this.isRtlDir?-1*this.wrapOffset:this.wrapOffset);s+n/2<i;){if(s+=n,e===h.length-1){n=0;break}n=this.charWidths[h[++e]]}return 0===(t=0<e&&h[e-1]%2!=0&&h[e]%2==0?(i<s&&e--,this.bidiMap.logicalFromVisual[e]):0<e&&h[e-1]%2==0&&h[e]%2!=0?1+(s<i?this.bidiMap.logicalFromVisual[e]:this.bidiMap.logicalFromVisual[e-1]):this.isRtlDir&&e===h.length-1&&0===n&&h[e-1]%2==0||!this.isRtlDir&&0===e&&h[e]%2!=0?1+this.bidiMap.logicalFromVisual[e]:(0<e&&h[e-1]%2!=0&&0!==n&&e--,this.bidiMap.logicalFromVisual[e]))&&this.isRtlDir&&t++,t+this.wrapIndent}}.call(BidiHandler.prototype),exports.BidiHandler=BidiHandler;