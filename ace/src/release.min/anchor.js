"use strict";var oop=require("./lib/oop"),EventEmitter=require("./lib/event_emitter").EventEmitter,Anchor=exports.Anchor=function(t,o,n){this.$onChange=this.onChange.bind(this),this.attach(t),void 0===n?this.setPosition(o.row,o.column):this.setPosition(o,n)};!function(){function c(t,o,n){n=n?t.column<=o.column:t.column<o.column;return t.row<o.row||t.row==o.row&&n}oop.implement(this,EventEmitter),this.getPosition=function(){return this.$clipPositionToDocument(this.row,this.column)},this.getDocument=function(){return this.document},this.$insertRight=!1,this.onChange=function(t){t.start.row==t.end.row&&t.start.row!=this.row||t.start.row>this.row||(t=function(t,o,n){var i="insert"==t.action,r=(i?1:-1)*(t.end.row-t.start.row),e=(i?1:-1)*(t.end.column-t.start.column),s=t.start,i=i?s:t.end;if(c(o,s,n))return{row:o.row,column:o.column};if(c(i,o,!n))return{row:o.row+r,column:o.column+(o.row==i.row?e:0)};return{row:s.row,column:s.column}}(t,{row:this.row,column:this.column},this.$insertRight),this.setPosition(t.row,t.column,!0))},this.setPosition=function(t,o,n){n=n?{row:t,column:o}:this.$clipPositionToDocument(t,o);this.row==n.row&&this.column==n.column||(t={row:this.row,column:this.column},this.row=n.row,this.column=n.column,this._signal("change",{old:t,value:n}))},this.detach=function(){this.document.off("change",this.$onChange)},this.attach=function(t){this.document=t||this.document,this.document.on("change",this.$onChange)},this.$clipPositionToDocument=function(t,o){var n={};return t>=this.document.getLength()?(n.row=Math.max(0,this.document.getLength()-1),n.column=this.document.getLine(n.row).length):t<0?(n.row=0,n.column=0):(n.row=t,n.column=Math.min(this.document.getLine(n.row).length,Math.max(0,o))),o<0&&(n.column=0),n}}.call(Anchor.prototype);