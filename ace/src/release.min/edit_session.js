"use strict";var oop=require("./lib/oop"),lang=require("./lib/lang"),BidiHandler=require("./bidihandler").BidiHandler,config=require("./config"),EventEmitter=require("./lib/event_emitter").EventEmitter,Selection=require("./selection").Selection,TextMode=require("./mode/text").Mode,Range=require("./range").Range,Document=require("./document").Document,BackgroundTokenizer=require("./background_tokenizer").BackgroundTokenizer,SearchHighlight=require("./search_highlight").SearchHighlight,EditSession=function(t,e){this.$breakpoints=[],this.$decorations=[],this.$frontMarkers={},this.$backMarkers={},this.$markerId=1,this.$undoSelect=!0,this.$foldData=[],this.id="session"+ ++EditSession.$uid,this.$foldData.toString=function(){return this.join("\n")},this.bgTokenizer=new BackgroundTokenizer((new TextMode).getTokenizer(),this);var i=this;this.bgTokenizer.on("update",function(t){i._signal("tokenizerUpdate",t)}),this.on("changeFold",this.onChangeFold.bind(this)),this.$onChange=this.onChange.bind(this),"object"==typeof t&&t.getLine||(t=new Document(t)),this.setDocument(t),this.selection=new Selection(this),this.$bidiHandler=new BidiHandler(this),config.resetOptions(this),this.setMode(e),config._signal("session",this),this.destroyed=!1};EditSession.$uid=0,function(){oop.implement(this,EventEmitter),this.setDocument=function(t){this.doc&&this.doc.off("change",this.$onChange),(this.doc=t).on("change",this.$onChange,!0),this.bgTokenizer.setDocument(this.getDocument()),this.resetCaches()},this.getDocument=function(){return this.doc},this.$resetRowCache=function(t){var e;t?(e=this.$docRowCache.length,(t=this.$getRowCacheIndex(this.$docRowCache,t)+1)<e&&(this.$docRowCache.splice(t,e),this.$screenRowCache.splice(t,e))):(this.$docRowCache=[],this.$screenRowCache=[])},this.$getRowCacheIndex=function(t,e){for(var i=0,n=t.length-1;i<=n;){var s=i+n>>1,o=t[s];if(o<e)i=1+s;else{if(!(e<o))return s;n=s-1}}return i-1},this.resetCaches=function(){this.$modified=!0,this.$wrapData=[],this.$rowLengthCache=[],this.$resetRowCache(0),this.destroyed||this.bgTokenizer.start(0)},this.onChangeFold=function(t){t=t.data;this.$resetRowCache(t.start.row)},this.onChange=function(t){this.$modified=!0,this.$bidiHandler.onChange(t),this.$resetRowCache(t.start.row);var e=this.$updateInternalDataOnChange(t);!this.$fromUndo&&this.$undoManager&&(e&&e.length&&(this.$undoManager.add({action:"removeFolds",folds:e},this.mergeUndoDeltas),this.mergeUndoDeltas=!0),this.$undoManager.add(t,this.mergeUndoDeltas),this.mergeUndoDeltas=!0,this.$informUndoManager.schedule()),this.bgTokenizer.$updateOnChange(t),this._signal("change",t)},this.setValue=function(t){this.doc.setValue(t),this.selection.moveTo(0,0),this.$resetRowCache(0),this.setUndoManager(this.$undoManager),this.getUndoManager().reset()},this.getValue=this.toString=function(){return this.doc.getValue()},this.getSelection=function(){return this.selection},this.getState=function(t){return this.bgTokenizer.getState(t)},this.getTokens=function(t){return this.bgTokenizer.getTokens(t)},this.getTokenAt=function(t,e){var i=this.bgTokenizer.getTokens(t),n=0;if(null==e)var s=i.length-1,n=this.getLine(t).length;else for(s=0;s<i.length&&!(e<=(n+=i[s].value.length));s++);return(t=i[s])?(t.index=s,t.start=n-t.value.length,t):null},this.setUndoManager=function(t){var e;this.$undoManager=t,this.$informUndoManager&&this.$informUndoManager.cancel(),t?(t.addSession(e=this),this.$syncInformUndoManager=function(){e.$informUndoManager.cancel(),e.mergeUndoDeltas=!1},this.$informUndoManager=lang.delayedCall(this.$syncInformUndoManager)):this.$syncInformUndoManager=function(){}},this.markUndoGroup=function(){this.$syncInformUndoManager&&this.$syncInformUndoManager()},this.$defaultUndoManager={undo:function(){},redo:function(){},hasUndo:function(){},hasRedo:function(){},reset:function(){},add:function(){},addSelection:function(){},startNewGroup:function(){},addSession:function(){}},this.getUndoManager=function(){return this.$undoManager||this.$defaultUndoManager},this.getTabString=function(){return this.getUseSoftTabs()?lang.stringRepeat(" ",this.getTabSize()):"\t"},this.setUseSoftTabs=function(t){this.setOption("useSoftTabs",t)},this.getUseSoftTabs=function(){return this.$useSoftTabs&&!this.$mode.$indentWithTabs},this.setTabSize=function(t){this.setOption("tabSize",t)},this.getTabSize=function(){return this.$tabSize},this.isTabStop=function(t){return this.$useSoftTabs&&t.column%this.$tabSize==0},this.setNavigateWithinSoftTabs=function(t){this.setOption("navigateWithinSoftTabs",t)},this.getNavigateWithinSoftTabs=function(){return this.$navigateWithinSoftTabs},this.$overwrite=!1,this.setOverwrite=function(t){this.setOption("overwrite",t)},this.getOverwrite=function(){return this.$overwrite},this.toggleOverwrite=function(){this.setOverwrite(!this.$overwrite)},this.addGutterDecoration=function(t,e){this.$decorations[t]||(this.$decorations[t]=""),this.$decorations[t]+=" "+e,this._signal("changeBreakpoint",{})},this.removeGutterDecoration=function(t,e){this.$decorations[t]=(this.$decorations[t]||"").replace(" "+e,""),this._signal("changeBreakpoint",{})},this.getBreakpoints=function(){return this.$breakpoints},this.setBreakpoints=function(t){this.$breakpoints=[];for(var e=0;e<t.length;e++)this.$breakpoints[t[e]]="ace_breakpoint";this._signal("changeBreakpoint",{})},this.clearBreakpoints=function(){this.$breakpoints=[],this._signal("changeBreakpoint",{})},this.setBreakpoint=function(t,e){(e=void 0===e?"ace_breakpoint":e)?this.$breakpoints[t]=e:delete this.$breakpoints[t],this._signal("changeBreakpoint",{})},this.clearBreakpoint=function(t){delete this.$breakpoints[t],this._signal("changeBreakpoint",{})},this.addMarker=function(t,e,i,n){var s=this.$markerId++,t={range:t,type:i||"line",renderer:"function"==typeof i?i:null,clazz:e,inFront:!!n,id:s};return n?(this.$frontMarkers[s]=t,this._signal("changeFrontMarker")):(this.$backMarkers[s]=t,this._signal("changeBackMarker")),s},this.addDynamicMarker=function(t,e){var i;if(t.update)return i=this.$markerId++,t.id=i,t.inFront=!!e,e?(this.$frontMarkers[i]=t,this._signal("changeFrontMarker")):(this.$backMarkers[i]=t,this._signal("changeBackMarker")),t},this.removeMarker=function(t){var e=this.$frontMarkers[t]||this.$backMarkers[t];e&&(delete(e.inFront?this.$frontMarkers:this.$backMarkers)[t],this._signal(e.inFront?"changeFrontMarker":"changeBackMarker"))},this.getMarkers=function(t){return t?this.$frontMarkers:this.$backMarkers},this.highlight=function(t){var e;this.$searchHighlight||(e=new SearchHighlight(null,"ace_selected-word","text"),this.$searchHighlight=this.addDynamicMarker(e)),this.$searchHighlight.setRegexp(t)},this.highlightLines=function(t,e,i,n){"number"!=typeof e&&(i=e,e=t),i=i||"ace_step";t=new Range(t,0,e,1/0);return t.id=this.addMarker(t,i,"fullLine",n),t},this.setAnnotations=function(t){this.$annotations=t,this._signal("changeAnnotation",{})},this.getAnnotations=function(){return this.$annotations||[]},this.clearAnnotations=function(){this.setAnnotations([])},this.$detectNewLine=function(t){t=t.match(/^.*?(\r?\n)/m);this.$autoNewLine=t?t[1]:"\n"},this.getWordRange=function(t,e){var i,n=this.getLine(t),s=!1,o=(i=(s=(s=0<e?!!n.charAt(e-1).match(this.tokenRe):s)||!!n.charAt(e).match(this.tokenRe))?this.tokenRe:/^\s+$/.test(n.slice(e-1,e+1))?/\s/:this.nonTokenRe,e);if(0<o){for(;0<=--o&&n.charAt(o).match(i););o++}for(var r=e;r<n.length&&n.charAt(r).match(i);)r++;return new Range(t,o,t,r)},this.getAWordRange=function(t,e){for(var i=this.getWordRange(t,e),n=this.getLine(i.end.row);n.charAt(i.end.column).match(/[ \t]/);)i.end.column+=1;return i},this.setNewLineMode=function(t){this.doc.setNewLineMode(t)},this.getNewLineMode=function(){return this.doc.getNewLineMode()},this.setUseWorker=function(t){this.setOption("useWorker",t)},this.getUseWorker=function(){return this.$useWorker},this.onReloadTokenizer=function(t){var e=t.data;this.bgTokenizer.start(e.first),this._signal("tokenizerUpdate",t)},this.$modes=config.$modes,this.$mode=null,this.$modeId=null,this.setMode=function(t,e){if(t&&"object"==typeof t){if(t.getTokenizer)return this.$onChangeMode(t);var i=t,n=i.path}else n=t||"ace/mode/text";this.$modes["ace/mode/text"]||(this.$modes["ace/mode/text"]=new TextMode),this.$modes[n]&&!i?(this.$onChangeMode(this.$modes[n]),e&&e()):(this.$modeId=n,config.loadModule(["mode",n],function(t){if(this.$modeId!==n)return e&&e();this.$modes[n]&&!i?this.$onChangeMode(this.$modes[n]):t&&t.Mode&&(t=new t.Mode(i),i||((this.$modes[n]=t).$id=n),this.$onChangeMode(t)),e&&e()}.bind(this)),this.$mode||this.$onChangeMode(this.$modes["ace/mode/text"],!0))},this.$onChangeMode=function(t,e){var i,n,s;e||(this.$modeId=t.$id),this.$mode===t||(i=this.$mode,this.$mode=t,this.$stopWorker(),this.$useWorker&&this.$startWorker(),void 0!==(n=t.getTokenizer()).on&&(s=this.onReloadTokenizer.bind(this),n.on("update",s)),this.bgTokenizer.setTokenizer(n),this.bgTokenizer.setDocument(this.getDocument()),this.tokenRe=t.tokenRe,this.nonTokenRe=t.nonTokenRe,e)||(t.attachToSession&&t.attachToSession(this),this.$options.wrapMethod.set.call(this,this.$wrapMethod),this.$setFolding(t.foldingRules),this.bgTokenizer.start(0),this._emit("changeMode",{oldMode:i,mode:t}))},this.$stopWorker=function(){this.$worker&&(this.$worker.terminate(),this.$worker=null)},this.$startWorker=function(){try{this.$worker=this.$mode.createWorker(this)}catch(t){config.warn("Could not load worker",t),this.$worker=null}},this.getMode=function(){return this.$mode},this.$scrollTop=0,this.setScrollTop=function(t){this.$scrollTop===t||isNaN(t)||(this.$scrollTop=t,this._signal("changeScrollTop",t))},this.getScrollTop=function(){return this.$scrollTop},this.$scrollLeft=0,this.setScrollLeft=function(t){this.$scrollLeft===t||isNaN(t)||(this.$scrollLeft=t,this._signal("changeScrollLeft",t))},this.getScrollLeft=function(){return this.$scrollLeft},this.getScreenWidth=function(){return this.$computeWidth(),this.lineWidgets?Math.max(this.getLineWidgetMaxWidth(),this.screenWidth):this.screenWidth},this.getLineWidgetMaxWidth=function(){var e;return null!=this.lineWidgetsWidth?this.lineWidgetsWidth:(e=0,this.lineWidgets.forEach(function(t){t&&t.screenWidth>e&&(e=t.screenWidth)}),this.lineWidgetWidth=e)},this.$computeWidth=function(t){if(this.$modified||t){if(this.$modified=!1,this.$useWrapMode)return this.screenWidth=this.$wrapLimit;for(var e=this.doc.getAllLines(),i=this.$rowLengthCache,n=0,s=0,o=this.$foldData[s],r=o?o.start.row:1/0,h=e.length,a=0;a<h;a++){if(r<a){if(h<=(a=o.end.row+1))break;r=(o=this.$foldData[s++])?o.start.row:1/0}null==i[a]&&(i[a]=this.$getStringScreenWidth(e[a])[0]),i[a]>n&&(n=i[a])}this.screenWidth=n}},this.getLine=function(t){return this.doc.getLine(t)},this.getLines=function(t,e){return this.doc.getLines(t,e)},this.getLength=function(){return this.doc.getLength()},this.getTextRange=function(t){return this.doc.getTextRange(t||this.selection.getRange())},this.insert=function(t,e){return this.doc.insert(t,e)},this.remove=function(t){return this.doc.remove(t)},this.removeFullLines=function(t,e){return this.doc.removeFullLines(t,e)},this.undoChanges=function(t,e){if(t.length){this.$fromUndo=!0;for(var i=t.length-1;-1!=i;i--){var n=t[i];"insert"==n.action||"remove"==n.action?this.doc.revertDelta(n):n.folds&&this.addFolds(n.folds)}!e&&this.$undoSelect&&(t.selectionBefore?this.selection.fromJSON(t.selectionBefore):this.selection.setRange(this.$getUndoSelection(t,!0))),this.$fromUndo=!1}},this.redoChanges=function(t,e){if(t.length){this.$fromUndo=!0;for(var i=0;i<t.length;i++){var n=t[i];"insert"!=n.action&&"remove"!=n.action||this.doc.$safeApplyDelta(n)}!e&&this.$undoSelect&&(t.selectionAfter?this.selection.fromJSON(t.selectionAfter):this.selection.setRange(this.$getUndoSelection(t,!1))),this.$fromUndo=!1}},this.setUndoSelect=function(t){this.$undoSelect=t},this.$getUndoSelection=function(t,e){function i(t){return e?"insert"!==t.action:"insert"===t.action}for(var n,s,o=0;o<t.length;o++){var r=t[o];r.start&&(n?i(r)?(s=r.start,-1==n.compare(s.row,s.column)&&n.setStart(s),s=r.end,1==n.compare(s.row,s.column)&&n.setEnd(s)):(s=r.start,-1==n.compare(s.row,s.column)&&(n=Range.fromPoints(r.start,r.start))):n=i(r)?Range.fromPoints(r.start,r.end):Range.fromPoints(r.start,r.start))}return n},this.replace=function(t,e){return this.doc.replace(t,e)},this.moveText=function(t,e,i){var n,s,o,r=this.getTextRange(t),h=this.getFoldsInRange(t),e=Range.fromPoints(e,e);return i||(this.remove(t),s=t.start.row-t.end.row,(o=s?-t.end.column:t.start.column-t.end.column)&&(e.start.row==t.end.row&&e.start.column>t.end.column&&(e.start.column+=o),e.end.row==t.end.row)&&e.end.column>t.end.column&&(e.end.column+=o),s&&e.start.row>=t.end.row&&(e.start.row+=s,e.end.row+=s)),e.end=this.insert(e.start,r),h.length&&(n=t.start,i=e.start,s=i.row-n.row,o=i.column-n.column,this.addFolds(h.map(function(t){return(t=t.clone()).start.row==n.row&&(t.start.column+=o),t.end.row==n.row&&(t.end.column+=o),t.start.row+=s,t.end.row+=s,t}))),e},this.indentRows=function(t,e,i){i=i.replace(/\t/g,this.getTabString());for(var n=t;n<=e;n++)this.doc.insertInLine({row:n,column:0},i)},this.outdentRows=function(t){for(var e=t.collapseRows(),i=new Range(0,0,0,0),n=this.getTabSize(),s=e.start.row;s<=e.end.row;++s){var o=this.getLine(s);i.start.row=s,i.end.row=s;for(var r=0;r<n&&" "==o.charAt(r);++r);r<n&&"\t"==o.charAt(r)?(i.start.column=r,i.end.column=r+1):(i.start.column=0,i.end.column=r),this.remove(i)}},this.$moveLines=function(t,e,i){if(t=this.getRowFoldStart(t),e=this.getRowFoldEnd(e),i<0){if((s=this.getRowFoldStart(t+i))<0)return 0;var n=s-t}else if(0<i){if((s=this.getRowFoldEnd(e+i))>this.doc.getLength()-1)return 0;n=s-e}else{t=this.$clipRowToDocument(t);n=(e=this.$clipRowToDocument(e))-t+1}var s=new Range(t,0,e,Number.MAX_VALUE),s=this.getFoldsInRange(s).map(function(t){return(t=t.clone()).start.row+=n,t.end.row+=n,t}),i=0==i?this.doc.getLines(t,e):this.doc.removeFullLines(t,e);return this.doc.insertFullLines(t+n,i),s.length&&this.addFolds(s),n},this.moveLinesUp=function(t,e){return this.$moveLines(t,e,-1)},this.moveLinesDown=function(t,e){return this.$moveLines(t,e,1)},this.duplicateLines=function(t,e){return this.$moveLines(t,e,0)},this.$clipRowToDocument=function(t){return Math.max(0,Math.min(t,this.doc.getLength()-1))},this.$clipColumnToRow=function(t,e){return e<0?0:Math.min(this.doc.getLine(t).length,e)},this.$clipPositionToDocument=function(t,e){var i;return e=Math.max(0,e),e=t<0?t=0:(i=this.doc.getLength())<=t?this.doc.getLine(t=i-1).length:Math.min(this.doc.getLine(t).length,e),{row:t,column:e}},this.$clipRangeToDocument=function(t){t.start.row<0?(t.start.row=0,t.start.column=0):t.start.column=this.$clipColumnToRow(t.start.row,t.start.column);var e=this.doc.getLength()-1;return t.end.row>e?(t.end.row=e,t.end.column=this.doc.getLine(e).length):t.end.column=this.$clipColumnToRow(t.end.row,t.end.column),t},this.$wrapLimit=80,this.$useWrapMode=!1,this.$wrapLimitRange={min:null,max:null},this.setUseWrapMode=function(t){t!=this.$useWrapMode&&(this.$useWrapMode=t,this.$modified=!0,this.$resetRowCache(0),t&&(t=this.getLength(),this.$wrapData=Array(t),this.$updateWrapData(0,t-1)),this._signal("changeWrapMode"))},this.getUseWrapMode=function(){return this.$useWrapMode},this.setWrapLimitRange=function(t,e){this.$wrapLimitRange.min===t&&this.$wrapLimitRange.max===e||(this.$wrapLimitRange={min:t,max:e},this.$modified=!0,this.$bidiHandler.markAsDirty(),this.$useWrapMode&&this._signal("changeWrapMode"))},this.adjustWrapLimit=function(t,e){var i=this.$wrapLimitRange,e=(i.max<0&&(i={min:e,max:e}),this.$constrainWrapLimit(t,i.min,i.max));return e!=this.$wrapLimit&&1<e&&(this.$wrapLimit=e,this.$modified=!0,this.$useWrapMode&&(this.$updateWrapData(0,this.getLength()-1),this.$resetRowCache(0),this._signal("changeWrapLimit")),!0)},this.$constrainWrapLimit=function(t,e,i){return e&&(t=Math.max(e,t)),t=i?Math.min(i,t):t},this.getWrapLimit=function(){return this.$wrapLimit},this.setWrapLimit=function(t){this.setWrapLimitRange(t,t)},this.getWrapLimitRange=function(){return{min:this.$wrapLimitRange.min,max:this.$wrapLimitRange.max}},this.$updateInternalDataOnChange=function(t){var e=this.$useWrapMode,i=t.action,n=t.start,s=t.end,o=n.row,r=s.row,h=r-o,a=null;if(this.$updating=!0,0!=h)if("remove"===i){this[e?"$wrapData":"$rowLengthCache"].splice(o,h);var c=this.$foldData,a=this.getFoldsInRange(t);this.removeFolds(a);var d=0;for((g=this.getFoldLine(s.row))&&(g.addRemoveChars(s.row,s.column,n.column-s.column),g.shiftRow(-h),(u=this.getFoldLine(o))&&u!==g&&(u.merge(g),g=u),d=c.indexOf(g)+1);d<c.length;d++)(g=c[d]).start.row>=s.row&&g.shiftRow(-h);r=o}else{var u=Array(h),l=(u.unshift(o,0),e?this.$wrapData:this.$rowLengthCache),c=(l.splice.apply(l,u),this.$foldData),d=0;for((g=this.getFoldLine(o))&&(0==(l=g.range.compareInside(n.row,n.column))?(g=g.split(n.row,n.column))&&(g.shiftRow(h),g.addRemoveChars(r,0,s.column-n.column)):-1==l&&(g.addRemoveChars(o,0,s.column-n.column),g.shiftRow(h)),d=c.indexOf(g)+1);d<c.length;d++)(g=c[d]).start.row>=o&&g.shiftRow(h)}else{var g,h=Math.abs(t.start.column-t.end.column);"remove"===i&&(a=this.getFoldsInRange(t),this.removeFolds(a),h=-h),(g=this.getFoldLine(o))&&g.addRemoveChars(o,n.column,h)}return e&&this.$wrapData.length!=this.doc.getLength()&&console.error("doc.getLength() and $wrapData.length have to be the same!"),this.$updating=!1,e?this.$updateWrapData(o,r):this.$updateRowLengthCache(o,r),a},this.$updateRowLengthCache=function(t,e,i){this.$rowLengthCache[t]=null,this.$rowLengthCache[e]=null},this.$updateWrapData=function(t,e){var r,i,h=this.doc.getAllLines(),n=this.getTabSize(),s=this.$wrapData,o=this.$wrapLimit,a=t;for(e=Math.min(e,h.length-1);a<=e;)(i=this.getFoldLine(a,i))?(r=[],i.walk(function(t,e,i,n){var s;if(null!=t){(s=this.$getDisplayTokens(t,r.length))[0]=f;for(var o=1;o<s.length;o++)s[o]=$}else s=this.$getDisplayTokens(h[e].substring(n,i),r.length);r=r.concat(s)}.bind(this),i.end.row,h[i.end.row].length+1),s[i.start.row]=this.$computeWrapSplits(r,o,n),a=i.end.row+1):(r=this.$getDisplayTokens(h[a]),s[a]=this.$computeWrapSplits(r,o,n),a++)};var f=3,$=4;function h(t){return!(t<4352)&&(4352<=t&&t<=4447||4515<=t&&t<=4519||4602<=t&&t<=4607||9001<=t&&t<=9002||11904<=t&&t<=11929||11931<=t&&t<=12019||12032<=t&&t<=12245||12272<=t&&t<=12283||12288<=t&&t<=12350||12353<=t&&t<=12438||12441<=t&&t<=12543||12549<=t&&t<=12589||12593<=t&&t<=12686||12688<=t&&t<=12730||12736<=t&&t<=12771||12784<=t&&t<=12830||12832<=t&&t<=12871||12880<=t&&t<=13054||13056<=t&&t<=19903||19968<=t&&t<=42124||42128<=t&&t<=42182||43360<=t&&t<=43388||44032<=t&&t<=55203||55216<=t&&t<=55238||55243<=t&&t<=55291||63744<=t&&t<=64255||65040<=t&&t<=65049||65072<=t&&t<=65106||65108<=t&&t<=65126||65128<=t&&t<=65131||65281<=t&&t<=65376||65504<=t&&t<=65510)}this.$computeWrapSplits=function(s,t,o){if(0==s.length)return[];var r=[],e=s.length,h=0,a=0,c=this.$wrapAsCode,d=this.$indentedSoftWrap,u=t<=Math.max(2*o,8)||!1===d?0:Math.floor(t/2);function i(t){for(var e=t-h,i=h;i<t;i++){var n=s[i];12!==n&&2!==n||--e}r.length||(l=function(){var t=0;if(0===u)return t;if(d)for(var e=0;e<s.length;e++){var i=s[e];if(10==i)t+=1;else if(11==i)t+=o;else if(12!=i)break}return c&&!1!==d&&(t+=o),Math.min(t,u)}(),r.indent=l),a+=e,r.push(a),h=t}for(var l=0;t-l<e-h;){var n=h+t-l;if(10<=s[n-1]&&10<=s[n])i(n);else if(s[n]==f||s[n]==$){for(;n!=h-1&&s[n]!=f;n--);if(h<n);else{for(n=h+t;n<s.length&&s[n]==$;n++);if(n==s.length)break}i(n)}else{for(var g=Math.max(n-(t-(t>>2)),h-1);g<n&&s[n]<f;)n--;if(c){for(;g<n&&s[n]<f;)n--;for(;g<n&&9==s[n];)n--}else for(;g<n&&s[n]<10;)n--;g<n?i(++n):(2==s[n=h+t]&&n--,i(n-l))}}return r},this.$getDisplayTokens=function(t,e){var i,n=[];e=e||0;for(var s=0;s<t.length;s++){var o=t.charCodeAt(s);if(9==o){i=this.getScreenTabSize(n.length+e),n.push(11);for(var r=1;r<i;r++)n.push(12)}else 32==o?n.push(10):39<o&&o<48||57<o&&o<64?n.push(9):4352<=o&&h(o)?n.push(1,2):n.push(1)}return n},this.$getStringScreenWidth=function(t,e,i){if(0==e)return[0,0];var n,s;for(null==e&&(e=1/0),i=i||0,s=0;s<t.length&&(9==(n=t.charCodeAt(s))?i+=this.getScreenTabSize(i):4352<=n&&h(n)?i+=2:i+=1,!(e<i));s++);return[i,s]},this.lineWidgets=null,this.getRowLength=function(t){var e=1;return this.lineWidgets&&(e+=this.lineWidgets[t]&&this.lineWidgets[t].rowCount||0),this.$useWrapMode&&this.$wrapData[t]?this.$wrapData[t].length+e:e},this.getRowLineCount=function(t){return this.$useWrapMode&&this.$wrapData[t]?this.$wrapData[t].length+1:1},this.getRowWrapIndent=function(t){var e;return this.$useWrapMode&&(t=this.screenToDocumentPosition(t,Number.MAX_VALUE),(e=this.$wrapData[t.row]).length)&&e[0]<t.column?e.indent:0},this.getScreenLastRowColumn=function(t){t=this.screenToDocumentPosition(t,Number.MAX_VALUE);return this.documentToScreenColumn(t.row,t.column)},this.getDocumentLastRowColumn=function(t,e){t=this.documentToScreenRow(t,e);return this.getScreenLastRowColumn(t)},this.getDocumentLastRowColumnPosition=function(t,e){t=this.documentToScreenRow(t,e);return this.screenToDocumentPosition(t,Number.MAX_VALUE/10)},this.getRowSplitData=function(t){if(this.$useWrapMode)return this.$wrapData[t]},this.getScreenTabSize=function(t){return this.$tabSize-(t%this.$tabSize|0)},this.screenToDocumentRow=function(t,e){return this.screenToDocumentPosition(t,e).row},this.screenToDocumentColumn=function(t,e){return this.screenToDocumentPosition(t,e).column},this.screenToDocumentPosition=function(t,e,i){if(t<0)return{row:0,column:0};for(var n,s,o,r=0,h=0,a=0,c=0,d=this.$screenRowCache,u=this.$getRowCacheIndex(d,t),l=d.length,g=(o=l&&0<=u?(a=d[u],r=this.$docRowCache[u],t>d[l-1]):!l,this.getLength()-1),f=this.getNextFoldLine(r),$=f?f.start.row:1/0;a<=t&&!(t<a+(c=this.getRowLength(r))||g<=r);)a+=c,$<++r&&(r=f.end.row+1,$=(f=this.getNextFoldLine(r,f))?f.start.row:1/0),o&&(this.$docRowCache.push(r),this.$screenRowCache.push(a));if(f&&f.start.row<=r)n=this.getFoldDisplayLine(f),r=f.start.row;else{if(a+c<=t||g<r)return{row:g,column:this.getLine(g).length};n=this.getLine(r),f=null}u=0,d=Math.floor(t-a);return this.$useWrapMode&&(l=this.$wrapData[r])&&(s=l[d],0<d)&&l.length&&(u=l.indent,h=l[d-1]||l[l.length-1],n=n.substring(h)),void 0!==i&&this.$bidiHandler.isBidiRow(a+d,r,d)&&(e=this.$bidiHandler.offsetToCol(i)),h+=this.$getStringScreenWidth(n,e-u)[1],this.$useWrapMode&&s<=h&&(h=s-1),f?f.idxToPosition(h):{row:r,column:h}},this.documentToScreenPosition=function(t,e){var i=void 0===e?this.$clipPositionToDocument(t.row,t.column):this.$clipPositionToDocument(t,e),n=(t=i.row,e=i.column,0),i=null;(h=this.getFoldAt(t,e,1))&&(t=h.start.row,e=h.start.column);for(var s,o,r=0,h=this.$docRowCache,a=this.$getRowCacheIndex(h,t),c=h.length,d=(o=c&&0<=a?(r=h[a],n=this.$screenRowCache[a],t>h[c-1]):!c,this.getNextFoldLine(r)),u=d?d.start.row:1/0;r<t;){if(u<=r){if(t<(s=d.end.row+1))break;u=(d=this.getNextFoldLine(s,d))?d.start.row:1/0}else s=r+1;n+=this.getRowLength(r),r=s,o&&(this.$docRowCache.push(r),this.$screenRowCache.push(n))}var l="",i=d&&u<=r?(l=this.getFoldDisplayLine(d,t,e),d.start.row):(l=this.getLine(t).substring(0,e),t),a=0;if(this.$useWrapMode){var g=this.$wrapData[i];if(g){for(var f=0;l.length>=g[f];)n++,f++;l=l.substring(g[f-1]||0,l.length),a=0<f?g.indent:0}}return this.lineWidgets&&this.lineWidgets[r]&&this.lineWidgets[r].rowsAbove&&(n+=this.lineWidgets[r].rowsAbove),{row:n,column:a+this.$getStringScreenWidth(l)[0]}},this.documentToScreenColumn=function(t,e){return this.documentToScreenPosition(t,e).column},this.documentToScreenRow=function(t,e){return this.documentToScreenPosition(t,e).row},this.getScreenLength=function(){var t=0,e=null;if(this.$useWrapMode)for(var i=this.$wrapData.length,n=0,s=0,o=(e=this.$foldData[s++])?e.start.row:1/0;n<i;){var r=this.$wrapData[n];t+=r?r.length+1:1,o<++n&&(n=e.end.row+1,o=(e=this.$foldData[s++])?e.start.row:1/0)}else for(var t=this.getLength(),h=this.$foldData,s=0;s<h.length;s++)t-=(e=h[s]).end.row-e.start.row;return this.lineWidgets&&(t+=this.$getWidgetScreenLength()),t},this.$setFontMetrics=function(o){this.$enableVarChar&&(this.$getStringScreenWidth=function(t,e,i){if(0===e)return[0,0];var n,s;for(e=e||1/0,i=i||0,s=0;s<t.length&&!(e<(i+="\t"===(n=t.charAt(s))?this.getScreenTabSize(i):o.getCharacterWidth(n)));s++);return[i,s]})},this.destroy=function(){this.destroyed||(this.bgTokenizer.setDocument(null),this.bgTokenizer.cleanup(),this.destroyed=!0),this.$stopWorker(),this.removeAllListeners(),this.doc&&this.doc.off("change",this.$onChange),this.selection.detach()},this.isFullWidth=h}.call(EditSession.prototype),require("./edit_session/folding").Folding.call(EditSession.prototype),require("./edit_session/bracket_match").BracketMatch.call(EditSession.prototype),config.defineOptions(EditSession.prototype,"session",{wrap:{set:function(t){t&&"off"!=t?"free"==t?t=!0:"printMargin"==t?t=-1:"string"==typeof t&&(t=parseInt(t,10)||!1):t=!1,this.$wrap!=t&&((this.$wrap=t)?(this.setWrapLimitRange(t="number"==typeof t?t:null,t),this.setUseWrapMode(!0)):this.setUseWrapMode(!1))},get:function(){return this.getUseWrapMode()?-1==this.$wrap?"printMargin":this.getWrapLimitRange().min?this.$wrap:"free":"off"},handlesSet:!0},wrapMethod:{set:function(t){(t="auto"==t?"text"!=this.$mode.type:"text"!=t)!=this.$wrapAsCode&&(this.$wrapAsCode=t,this.$useWrapMode)&&(this.$useWrapMode=!1,this.setUseWrapMode(!0))},initialValue:"auto"},indentedSoftWrap:{set:function(){this.$useWrapMode&&(this.$useWrapMode=!1,this.setUseWrapMode(!0))},initialValue:!0},firstLineNumber:{set:function(){this._signal("changeBreakpoint")},initialValue:1},useWorker:{set:function(t){this.$useWorker=t,this.$stopWorker(),t&&this.$startWorker()},initialValue:!0},useSoftTabs:{initialValue:!0},tabSize:{set:function(t){0<(t=parseInt(t))&&this.$tabSize!==t&&(this.$modified=!0,this.$rowLengthCache=[],this.$tabSize=t,this._signal("changeTabSize"))},initialValue:4,handlesSet:!0},navigateWithinSoftTabs:{initialValue:!1},foldStyle:{set:function(t){this.setFoldStyle(t)},handlesSet:!0},overwrite:{set:function(t){this._signal("changeOverwrite")},initialValue:!1},newLineMode:{set:function(t){this.doc.setNewLineMode(t)},get:function(){return this.doc.getNewLineMode()},handlesSet:!0},mode:{set:function(t){this.setMode(t)},get:function(){return this.$modeId},handlesSet:!0}}),exports.EditSession=EditSession;