"use strict";var dom=require("./lib/dom");function LineWidgets(e){this.session=e,(this.session.widgetManager=this).session.getRowLength=this.getRowLength,this.session.$getWidgetScreenLength=this.$getWidgetScreenLength,this.updateOnChange=this.updateOnChange.bind(this),this.renderWidgets=this.renderWidgets.bind(this),this.measureWidgets=this.measureWidgets.bind(this),this.session._changedWidgets=[],this.$onChangeEditor=this.$onChangeEditor.bind(this),this.session.on("change",this.updateOnChange),this.session.on("changeFold",this.updateOnFold),this.session.on("changeEditor",this.$onChangeEditor)}!function(){this.getRowLength=function(e){var t=this.lineWidgets&&this.lineWidgets[e]&&this.lineWidgets[e].rowCount||0;return this.$useWrapMode&&this.$wrapData[e]?this.$wrapData[e].length+1+t:1+t},this.$getWidgetScreenLength=function(){var t=0;return this.lineWidgets.forEach(function(e){e&&e.rowCount&&!e.hidden&&(t+=e.rowCount)}),t},this.$onChangeEditor=function(e){this.attach(e.editor)},this.attach=function(e){e&&e.widgetManager&&e.widgetManager!=this&&e.widgetManager.detach(),this.editor!=e&&(this.detach(),this.editor=e)&&(e.widgetManager=this,e.renderer.on("beforeRender",this.measureWidgets),e.renderer.on("afterRender",this.renderWidgets))},this.detach=function(e){var t=this.editor;t&&(this.editor=null,t.widgetManager=null,t.renderer.off("beforeRender",this.measureWidgets),t.renderer.off("afterRender",this.renderWidgets),t=this.session.lineWidgets)&&t.forEach(function(e){e&&e.el&&e.el.parentNode&&(e._inDocument=!1,e.el.parentNode.removeChild(e.el))})},this.updateOnFold=function(e,t){var i=t.lineWidgets;if(i&&e.action){for(var t=e.data,s=t.start.row,n=t.end.row,o="add"==e.action,d=s+1;d<n;d++)i[d]&&(i[d].hidden=o);i[n]&&(o?i[s]?i[n].hidden=o:i[s]=i[n]:(i[s]==i[n]&&(i[s]=void 0),i[n].hidden=o))}},this.updateOnChange=function(e){var t,i,s,n=this.session.lineWidgets;n&&(t=e.start.row,0!=(i=e.end.row-t))&&("remove"==e.action?(s=n.splice(t+1,i),!n[t]&&s[s.length-1]&&(n[t]=s.pop()),s.forEach(function(e){e&&this.removeLineWidget(e)},this)):(s=new Array(i),n[t]&&null!=n[t].column&&e.start.column>n[t].column&&t++,s.unshift(t,0),n.splice.apply(n,s)),this.$updateRows())},this.$updateRows=function(){var i,e=this.session.lineWidgets;e&&(i=!0,e.forEach(function(e,t){if(e)for(i=!1,e.row=t;e.$oldWidget;)e.$oldWidget.row=t,e=e.$oldWidget}),i)&&(this.session.lineWidgets=null)},this.$registerLineWidget=function(e){this.session.lineWidgets||(this.session.lineWidgets=new Array(this.session.getLength()));var t=this.session.lineWidgets[e.row];return t&&(e.$oldWidget=t).el&&t.el.parentNode&&(t.el.parentNode.removeChild(t.el),t._inDocument=!1),this.session.lineWidgets[e.row]=e},this.addLineWidget=function(e){var t,i,s;return this.$registerLineWidget(e),e.session=this.session,this.editor&&(t=this.editor.renderer,e.html&&!e.el&&(e.el=dom.createElement("div"),e.el.innerHTML=e.html),e.el&&(dom.addCssClass(e.el,"ace_lineWidgetContainer"),e.el.style.position="absolute",e.el.style.zIndex=5,t.container.appendChild(e.el),e._inDocument=!0,e.coverGutter||(e.el.style.zIndex=3),null==e.pixelHeight)&&(e.pixelHeight=e.el.offsetHeight),null==e.rowCount&&(e.rowCount=e.pixelHeight/t.layerConfig.lineHeight),i=this.session.getFoldAt(e.row,0),(e.$fold=i)&&(s=this.session.lineWidgets,e.row!=i.end.row||s[i.start.row]?e.hidden=!0:s[i.start.row]=e),this.session._emit("changeFold",{data:{start:{row:e.row}}}),this.$updateRows(),this.renderWidgets(null,t),this.onWidgetChanged(e)),e},this.removeLineWidget=function(e){if(e._inDocument=!1,e.session=null,e.el&&e.el.parentNode&&e.el.parentNode.removeChild(e.el),e.editor&&e.editor.destroy)try{e.editor.destroy()}catch(e){}if(this.session.lineWidgets){var t=this.session.lineWidgets[e.row];if(t==e)this.session.lineWidgets[e.row]=e.$oldWidget,e.$oldWidget&&this.onWidgetChanged(e.$oldWidget);else for(;t;){if(t.$oldWidget==e){t.$oldWidget=e.$oldWidget;break}t=t.$oldWidget}}this.session._emit("changeFold",{data:{start:{row:e.row}}}),this.$updateRows()},this.getWidgetsAtRow=function(e){for(var t=this.session.lineWidgets,i=t&&t[e],s=[];i;)s.push(i),i=i.$oldWidget;return s},this.onWidgetChanged=function(e){this.session._changedWidgets.push(e),this.editor&&this.editor.renderer.updateFull()},this.measureWidgets=function(e,t){var i=this.session._changedWidgets,s=t.layerConfig;if(i&&i.length){for(var n=1/0,o=0;o<i.length;o++){var d=i[o];if(d&&d.el&&d.session==this.session){if(!d._inDocument){if(this.session.lineWidgets[d.row]!=d)continue;d._inDocument=!0,t.container.appendChild(d.el)}d.h=d.el.offsetHeight,d.fixedWidth||(d.w=d.el.offsetWidth,d.screenWidth=Math.ceil(d.w/s.characterWidth));var r=d.h/s.lineHeight;d.coverLine&&(r-=this.session.getRowLineCount(d.row))<0&&(r=0),d.rowCount!=r&&(d.rowCount=r,d.row<n)&&(n=d.row)}}n!=1/0&&(this.session._emit("changeFold",{data:{start:{row:n}}}),this.session.lineWidgetWidth=null),this.session._changedWidgets=[]}},this.renderWidgets=function(e,t){var i=t.layerConfig,s=this.session.lineWidgets;if(s){for(var n=Math.min(this.firstRow,i.firstRow),o=Math.max(this.lastRow,i.lastRow,s.length);0<n&&!s[n];)n--;this.firstRow=i.firstRow,this.lastRow=i.lastRow,t.$cursorLayer.config=i;for(var d=n;d<=o;d++){var r,h=s[d];h&&h.el&&(h.hidden?h.el.style.top=-100-(h.pixelHeight||0)+"px":(h._inDocument||(h._inDocument=!0,t.container.appendChild(h.el)),r=t.$cursorLayer.getPixelPosition({row:d,column:0},!0).top,h.coverLine||(r+=i.lineHeight*this.session.getRowLineCount(h.row)),h.el.style.top=r-i.offset+"px",r=h.coverGutter?0:t.gutterWidth,h.fixedWidth||(r-=t.scrollLeft),h.el.style.left=r+"px",h.fullWidth&&h.screenWidth&&(h.el.style.minWidth=i.width+2*i.padding+"px"),h.fixedWidth?h.el.style.right=t.scrollBar.getWidth()+"px":h.el.style.right=""))}}}}.call(LineWidgets.prototype),exports.LineWidgets=LineWidgets;