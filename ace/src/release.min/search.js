"use strict";var lang=require("./lib/lang"),oop=require("./lib/oop"),Range=require("./range").Range,Search=function(){this.$options={}};function addWordBoundary(e,t){function r(e){return/\w/.test(e)||t.regExp?"\\b":""}return r(e[0])+e+r(e[e.length-1])}!function(){this.set=function(e){return oop.mixin(this.$options,e),this},this.getOptions=function(){return lang.copyObject(this.$options)},this.setOptions=function(e){this.$options=e},this.find=function(e){var i,a=this.$options,e=this.$matchIterator(e,a);return!!e&&(i=null,e.forEach(function(e,t,r,n){return i=new Range(e,t,r,n),!(t==n&&a.start&&a.start.start&&0!=a.skipCurrent&&i.isEqual(a.start)&&(i=null,1))}),i)},this.findAll=function(e){var t=this.$options;if(!t.needle)return[];this.$assembleRegExp(t);var r=t.range,n=r?e.getLines(r.start.row,r.end.row):e.doc.getAllLines(),i=[],a=t.re;if(t.$isMultiLine){var o,s=a.length,l=n.length-s;e:for(var u=a.offset||0;u<=l;u++){for(var f=0;f<s;f++)if(-1==n[u+f].search(a[f]))continue e;var h=n[u],g=n[u+s-1],h=h.length-h.match(a[0])[0].length,g=g.match(a[s-1])[0].length;o&&o.end.row===u&&o.end.column>h||(i.push(o=new Range(u,h,u+s-1,g)),2<s&&(u=u+s-2))}}else for(var c=0;c<n.length;c++)for(var p=lang.getMatchOffsets(n[c],a),f=0;f<p.length;f++){var d=p[f];i.push(new Range(c,d.offset,c,d.offset+d.length))}if(r){for(var v=r.start.column,w=r.start.column,c=0,f=i.length-1;c<f&&i[c].start.column<v&&i[c].start.row==r.start.row;)c++;for(;c<f&&i[f].end.column>w&&i[f].end.row==r.end.row;)f--;for(i=i.slice(c,f+1),c=0,f=i.length;c<f;c++)i[c].start.row+=r.start.row,i[c].end.row+=r.start.row}return i},this.replace=function(e,t){var r=this.$options,n=this.$assembleRegExp(r);if(r.$isMultiLine)return t;if(n){var i=n.exec(e);if(!i||i[0].length!=e.length)return null;if(t=e.replace(n,t),r.preserveCase){t=t.split("");for(var a=Math.min(e.length,e.length);a--;){var o=e[a];o&&o.toLowerCase()!=o?t[a]=t[a].toUpperCase():t[a]=t[a].toLowerCase()}t=t.join("")}return t}},this.$assembleRegExp=function(e,t){if(e.needle instanceof RegExp)return e.re=e.needle;var r=e.needle;if(!e.needle)return e.re=!1;e.regExp||(r=lang.escapeRegExp(r)),e.wholeWord&&(r=addWordBoundary(r,e));var n=e.caseSensitive?"gm":"gmi";if(e.$isMultiLine=!t&&/[\n\r]/.test(r),e.$isMultiLine)return e.re=this.$assembleMultilineRegExp(r,n);try{var i=new RegExp(r,n)}catch(e){i=!1}return e.re=i},this.$assembleMultilineRegExp=function(e,t){for(var r=e.replace(/\r\n|\r|\n/g,"$\n^").split("\n"),n=[],i=0;i<r.length;i++)try{n.push(new RegExp(r[i],t))}catch(e){return!1}return n},this.$matchIterator=function(f,r){var s,e,t,n,i,a,l,o,h=this.$assembleRegExp(r);return!!h&&(s=1==r.backwards,e=0!=r.skipCurrent,t=r.range,(n=(n=r.start)||(t?t[s?"end":"start"]:f.selection.getRange())).start&&(n=n[e!=s?"end":"start"]),i=t?t.start.row:0,a=t?t.end.row:f.getLength()-1,o=r.$isMultiLine?(l=h.length,function(e,t,r){var n=s?e-l+1:e;if(!(n<0||n+l>f.getLength())){var i=f.getLine(n),e=i.search(h[0]);if(!(!s&&e<t||-1===e)){for(var a=1;a<l;a++)if(-1==(i=f.getLine(n+a)).search(h[a]))return;var o=i.match(h[l-1])[0].length;if(!(s&&t<o))return!!r(n,e,n+l-1,o)||void 0}}}):s?function(e,t,r){var n,i=f.getLine(e),a=[];for(h.lastIndex=0;n=h.exec(i);){var o=n[0].length,s=n.index;if(!o){if(s>=i.length)break;h.lastIndex=s+=1}if(n.index+o>t)break;a.push(n.index,o)}for(var l=a.length-1;0<=l;l-=2){var u=a[l-1];if(r(e,u,e,u+(o=a[l])))return!0}}:function(e,t,r){var n=f.getLine(e);for(h.lastIndex=t;i=h.exec(n);){var i,a=i[0].length;if(r(e,i=i.index,e,i+a))return!0;if(!a&&(h.lastIndex=i+=1,i>=n.length))return!1}},{forEach:s?function(e){var t=n.row;if(!o(t,n.column,e)){for(t--;i<=t;t--)if(o(t,Number.MAX_VALUE,e))return;if(0!=r.wrap)for(t=a,i=n.row;i<=t;t--)if(o(t,Number.MAX_VALUE,e))return}}:function(e){var t=n.row;if(!o(t,n.column,e)){for(t+=1;t<=a;t++)if(o(t,0,e))return;if(0!=r.wrap)for(t=i,a=n.row;t<=a;t++)if(o(t,0,e))return}}})}}.call(Search.prototype),exports.Search=Search;