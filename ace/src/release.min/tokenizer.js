"use strict";var config=require("./config"),MAX_TOKEN_COUNT=2e3,Tokenizer=function(e){for(var t in this.states=e,this.regExps={},this.matchMappings={},this.states){for(var n=this.states[t],r=[],s=0,i=this.matchMappings[t]={defaultToken:"text"},o="g",a=[],h=0;h<n.length;h++){var p,u,l=n[h];l.defaultToken&&(i.defaultToken=l.defaultToken),l.caseInsensitive&&-1===o.indexOf("i")&&(o+="i"),l.unicode&&-1===o.indexOf("u")&&(o+="u"),null==l.regex||(l.regex instanceof RegExp&&(l.regex=l.regex.toString().slice(1,-1)),p=l.regex,u=new RegExp("(?:("+p+")|(.))").exec("a").length-2,Array.isArray(l.token)?1==l.token.length||1==u?l.token=l.token[0]:u-1!=l.token.length?(this.reportError("number of classes and regexp groups doesn't match",{rule:l,groupCount:u-1}),l.token=l.token[0]):(l.tokenArray=l.token,l.token=null,l.onMatch=this.$arrayTokens):"function"!=typeof l.token||l.onMatch||(l.onMatch=1<u?this.$applyToken:l.token),1<u&&(p=/\\\d/.test(l.regex)?l.regex.replace(/\\([0-9]+)/g,function(e,t){return"\\"+(parseInt(t,10)+s+1)}):(u=1,this.removeCapturingGroups(l.regex)),l.splitRegex||"string"==typeof l.token||a.push(l)),i[s]=h,s+=u,r.push(p),l.onMatch)||(l.onMatch=null)}r.length||(i[0]=0,r.push("$")),a.forEach(function(e){e.splitRegex=this.createSplitterRegexp(e.regex,o)},this),this.regExps[t]=new RegExp("("+r.join(")|(")+")|($)",o)}};!function(){this.$setMaxTokenCount=function(e){MAX_TOKEN_COUNT=0|e},this.$applyToken=function(e){var t=this.splitRegex.exec(e).slice(1),n=this.token.apply(this,t);if("string"==typeof n)return[{type:n,value:e}];for(var r=[],s=0,i=n.length;s<i;s++)t[s]&&(r[r.length]={type:n[s],value:t[s]});return r},this.$arrayTokens=function(e){if(!e)return[];var t=this.splitRegex.exec(e);if(!t)return"text";for(var n=[],r=this.tokenArray,s=0,i=r.length;s<i;s++)t[s+1]&&(n[n.length]={type:r[s],value:t[s+1]});return n},this.removeCapturingGroups=function(e){return e.replace(/\\.|\[(?:\\.|[^\\\]])*|\(\?[:=!<]|(\()/g,function(e,t){return t?"(?:":e})},this.createSplitterRegexp=function(e,t){var o,a,h;return"$"!=(e="^"!=(e=-1!=e.indexOf("(?=")&&(o=0,a=!1,h={},e.replace(/(\\.)|(\((?:\?[=!])?)|(\))|([\[\]])/g,function(e,t,n,r,s,i){return a?a="]"!=s:s?a=!0:r?(o==h.stack&&(h.end=i+1,h.stack=-1),o--):n&&(o++,1!=n.length)&&(h.stack=o,h.start=i),e}),null!=h.end)&&/^\)*$/.test(e.substr(h.end))?e.substring(0,h.start)+e.substr(h.end):e).charAt(0)?"^"+e:e).charAt(e.length-1)&&(e+="$"),new RegExp(e,(t||"").replace("g",""))},this.getLineTokens=function(e,t){t&&"string"!=typeof t?"#tmp"===(t=(n=t.slice(0))[0])&&(n.shift(),t=n.shift()):n=[];for(var n,r,s=t||"start",i=(i=this.states[s])||this.states[s="start"],o=this.matchMappings[s],a=this.regExps[s],h=[],p=a.lastIndex=0,u=0,l={type:null,value:""};r=a.exec(e);){var g,c=o.defaultToken,f=null,x=r[0],k=a.lastIndex;k-x.length>p&&(g=e.substring(p,k-x.length),l.type==c?l.value+=g:(l.type&&h.push(l),l={type:c,value:g}));for(var y=0;y<r.length-2;y++)if(void 0!==r[y+1]){c=(f=i[o[y]]).onMatch?f.onMatch(x,s,n,e):f.token,f.next&&(s="string"==typeof f.next?f.next:f.next(s,n),(i=this.states[s])||(this.reportError("state doesn't exist",s),i=this.states[s="start"]),o=this.matchMappings[s],(a=this.regExps[s]).lastIndex=p=k),f.consumeLineEnd&&(p=k);break}if(x)if("string"==typeof c)f&&!1===f.merge||l.type!==c?(l.type&&h.push(l),l={type:c,value:x}):l.value+=x;else if(c){l.type&&h.push(l);for(l={type:null,value:""},y=0;y<c.length;y++)h.push(c[y])}if(p==e.length)break;if(p=k,u++>MAX_TOKEN_COUNT){for(u>2*e.length&&this.reportError("infinite loop with in ace tokenizer",{startState:t,line:e});p<e.length;)l.type&&h.push(l),l={value:e.substring(p,p+=500),type:"overflow"};s="start",n=[];break}}return l.type&&h.push(l),1<n.length&&n[0]!==s&&n.unshift("#tmp",s),{tokens:h,state:n.length?n:s}},this.reportError=config.reportError}.call(Tokenizer.prototype),exports.Tokenizer=Tokenizer;