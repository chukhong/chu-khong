"use strict";var oop=require("./lib/oop"),Range=require("./range").Range,Search=require("./search").Search,SearchHighlight=require("./search_highlight").SearchHighlight,iSearchCommandModule=require("./commands/incremental_search_commands"),ISearchKbd=iSearchCommandModule.IncrementalSearchKeyboardHandler;function IncrementalSearch(){this.$options={wrap:!1,skipCurrent:!1},this.$keyboardHandler=new ISearchKbd(this)}function isRegExp(e){return e instanceof RegExp}function regExpToObject(e){var e=String(e),t=e.indexOf("/"),i=e.lastIndexOf("/");return{expression:e.slice(t+1,i),flags:e.slice(i+1)}}function stringToRegExp(t,e){try{return new RegExp(t,e)}catch(e){return t}}function objectToRegExp(e){return stringToRegExp(e.expression,e.flags)}oop.inherits(IncrementalSearch,Search),function(){this.activate=function(e,t){this.$editor=e,this.$startPos=this.$currentPos=e.getCursorPosition(),this.$options.needle="",this.$options.backwards=t,e.keyBinding.addKeyboardHandler(this.$keyboardHandler),this.$originalEditorOnPaste=e.onPaste,e.onPaste=this.onPaste.bind(this),this.$mousedownHandler=e.on("mousedown",this.onMouseDown.bind(this)),this.selectionFix(e),this.statusMessage(!0)},this.deactivate=function(e){this.cancelSearch(e);e=this.$editor;e.keyBinding.removeKeyboardHandler(this.$keyboardHandler),this.$mousedownHandler&&(e.off("mousedown",this.$mousedownHandler),delete this.$mousedownHandler),e.onPaste=this.$originalEditorOnPaste,this.message("")},this.selectionFix=function(e){e.selection.isEmpty()&&!e.session.$emacsMark&&e.clearSelection()},this.highlight=function(e){var t=this.$editor.session;(t.$isearchHighlight=t.$isearchHighlight||t.addDynamicMarker(new SearchHighlight(null,"ace_isearch-result","text"))).setRegexp(e),t._emit("changeBackMarker")},this.cancelSearch=function(e){var t=this.$editor;return this.$prevNeedle=this.$options.needle,this.$options.needle="",e?(t.moveCursorToPosition(this.$startPos),this.$currentPos=this.$startPos):t.pushEmacsMark&&t.pushEmacsMark(this.$startPos,!1),this.highlight(null),Range.fromPoints(this.$currentPos,this.$currentPos)},this.highlightAndFindWithNeedle=function(e,t){if(!this.$editor)return null;var i=this.$options;if(t&&(i.needle=t.call(this,i.needle||"")||""),0===i.needle.length)return this.statusMessage(!0),this.cancelSearch(!0);i.start=this.$currentPos;var t=this.$editor.session,t=this.find(t),n=this.$editor.emacsMark?!!this.$editor.emacsMark():!this.$editor.selection.isEmpty();return t&&(i.backwards&&(t=Range.fromPoints(t.end,t.start)),this.$editor.selection.setRange(Range.fromPoints(n?this.$startPos:t.end,t.end)),e&&(this.$currentPos=t.end),this.highlight(i.re)),this.statusMessage(t),t},this.addString=function(i){return this.highlightAndFindWithNeedle(!1,function(e){var t;return isRegExp(e)?((t=regExpToObject(e)).expression+=i,objectToRegExp(t)):e+i})},this.removeChar=function(e){return this.highlightAndFindWithNeedle(!1,function(e){var t;return isRegExp(e)?((t=regExpToObject(e)).expression=t.expression.substring(0,t.expression.length-1),objectToRegExp(t)):e.substring(0,e.length-1)})},this.next=function(t){return t=t||{},this.$options.backwards=!!t.backwards,this.$currentPos=this.$editor.getCursorPosition(),this.highlightAndFindWithNeedle(!0,function(e){return t.useCurrentOrPrevSearch&&0===e.length?this.$prevNeedle||"":e})},this.onMouseDown=function(e){return this.deactivate(),!0},this.onPaste=function(e){this.addString(e)},this.convertNeedleToRegExp=function(){return this.highlightAndFindWithNeedle(!1,function(e){return isRegExp(e)?e:stringToRegExp(e,"ig")})},this.convertNeedleToString=function(){return this.highlightAndFindWithNeedle(!1,function(e){return isRegExp(e)?regExpToObject(e).expression:e})},this.statusMessage=function(e){var t=this.$options,i="",i=(i+=t.backwards?"reverse-":"")+("isearch: "+t.needle);this.message(i+=e?"":" (not found)")},this.message=function(e){this.$editor.showCommandLine&&(this.$editor.showCommandLine(e),this.$editor.focus())}}.call(IncrementalSearch.prototype),exports.IncrementalSearch=IncrementalSearch;var dom=require("./lib/dom"),commands=(dom.importCssString(`
.ace_marker-layer .ace_isearch-result {
  position: absolute;
  z-index: 6;
  box-sizing: border-box;
}
div.ace_isearch-result {
  border-radius: 4px;
  background-color: rgba(255, 200, 0, 0.5);
  box-shadow: 0 0 4px rgb(255, 200, 0);
}
.ace_dark div.ace_isearch-result {
  background-color: rgb(100, 110, 160);
  box-shadow: 0 0 4px rgb(80, 90, 140);
}`,"incremental-search-highlighting",!1),require("./commands/command_manager")),Editor=(!function(){this.setupIncrementalSearch=function(e,t){var i;this.usesIncrementalSearch!=t&&(this.usesIncrementalSearch=t,i=iSearchCommandModule.iSearchStartCommands,this[t?"addCommands":"removeCommands"](i))}}.call(commands.CommandManager.prototype),require("./editor").Editor);require("./config").defineOptions(Editor.prototype,"editor",{useIncrementalSearch:{set:function(t){this.keyBinding.$handlers.forEach(function(e){e.setupIncrementalSearch&&e.setupIncrementalSearch(this,t)}),this._emit("incrementalSearchSettingChanged",{isEnabled:t})}}});