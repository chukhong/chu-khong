"use strict";var Range=require("./range").Range,comparePoints=Range.comparePoints,RangeList=function(){this.ranges=[],this.$bias=1};!function(){this.comparePoints=comparePoints,this.pointIndex=function(n,t,o){for(var r=this.ranges,s=o||0;s<r.length;s++){var e=r[s],i=comparePoints(n,e.end);if(!(0<i))return e=comparePoints(n,e.start),0===i?t&&0!==e?-s-2:s:0<e||0===e&&!t?s:-s-1}return-s-1},this.add=function(n){var t=!n.isEmpty(),o=this.pointIndex(n.start,t),t=this.pointIndex(n.end,t,o=o<0?-o-1:o);return t<0?t=-t-1:t++,this.ranges.splice(o,t-o,n)},this.addList=function(n){for(var t=[],o=n.length;o--;)t.push.apply(t,this.add(n[o]));return t},this.substractPoint=function(n){n=this.pointIndex(n);if(0<=n)return this.ranges.splice(n,1)},this.merge=function(){for(var n=[],t=this.ranges,o=(t=t.sort(function(n,t){return comparePoints(n.start,t.start)}))[0],r=1;r<t.length;r++){var s=o,o=t[r],e=comparePoints(s.end,o.start);e<0||(0!=e||s.isEmpty()||o.isEmpty())&&(comparePoints(s.end,o.end)<0&&(s.end.row=o.end.row,s.end.column=o.end.column),t.splice(r,1),n.push(o),o=s,r--)}return this.ranges=t,n},this.contains=function(n,t){return 0<=this.pointIndex({row:n,column:t})},this.containsPoint=function(n){return 0<=this.pointIndex(n)},this.rangeAtPoint=function(n){n=this.pointIndex(n);if(0<=n)return this.ranges[n]},this.clipRows=function(n,t){var o=this.ranges;if(o[0].start.row>t||o[o.length-1].start.row<n)return[];for(var n=this.pointIndex({row:n,column:0}),r=this.pointIndex({row:t,column:0},n=n<0?-n-1:n),s=(r<0&&(r=-r-1),[]),e=n;e<r;e++)s.push(o[e]);return s},this.removeAll=function(){return this.ranges.splice(0,this.ranges.length)},this.attach=function(n){this.session&&this.detach(),this.session=n,this.onChange=this.$onChange.bind(this),this.session.on("change",this.onChange)},this.detach=function(){this.session&&(this.session.removeListener("change",this.onChange),this.session=null)},this.$onChange=function(n){for(var t=n.start,o=n.end,r=t.row,s=o.row,e=this.ranges,i=0,a=e.length;i<a&&!((h=e[i]).end.row>=r);i++);if("insert"==n.action)for(var c=s-r,u=-t.column+o.column;i<a;i++){if((h=e[i]).start.row>r)break;h.start.row==r&&h.start.column>=t.column&&(h.start.column==t.column&&this.$bias<=0||(h.start.column+=u,h.start.row+=c)),h.end.row==r&&h.end.column>=t.column&&(h.end.column==t.column&&this.$bias<0||(h.end.column==t.column&&0<u&&i<a-1&&h.end.column>h.start.column&&h.end.column==e[i+1].start.column&&(h.end.column-=u),h.end.column+=u,h.end.row+=c))}else for(var h,c=r-s,u=t.column-o.column;i<a;i++){if((h=e[i]).start.row>s)break;h.end.row<s&&(r<h.end.row||r==h.end.row&&t.column<h.end.column)?(h.end.row=r,h.end.column=t.column):h.end.row==s?h.end.column<=o.column?(c||h.end.column>t.column)&&(h.end.column=t.column,h.end.row=t.row):(h.end.column+=u,h.end.row+=c):h.end.row>s&&(h.end.row+=c),h.start.row<s&&(r<h.start.row||r==h.start.row&&t.column<h.start.column)?(h.start.row=r,h.start.column=t.column):h.start.row==s?h.start.column<=o.column?(c||h.start.column>t.column)&&(h.start.column=t.column,h.start.row=t.row):(h.start.column+=u,h.start.row+=c):h.start.row>s&&(h.start.row+=c)}if(0!=c&&i<a)for(;i<a;i++)(h=e[i]).start.row+=c,h.end.row+=c}}.call(RangeList.prototype),exports.RangeList=RangeList;