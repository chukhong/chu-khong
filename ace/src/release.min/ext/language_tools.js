"use strict";var snippetManager=require("../snippets").snippetManager,Autocomplete=require("../autocomplete").Autocomplete,config=require("../config"),lang=require("../lib/lang"),util=require("../autocomplete/util"),textCompleter=require("../autocomplete/text_completer"),keyWordCompleter={getCompletions:function(e,t,o,n,p){if(t.$mode.completer)return t.$mode.completer.getCompletions(e,t,o,n,p);e=e.session.getState(o.row);p(null,t.$mode.getCompletions(e,t,o,n))}},transformSnippetTooltip=function(e){var p={};return e.replace(/\${(\d+)(:(.*?))?}/g,function(e,t,o,n){return p[t]=n||""}).replace(/\$(\d+?)/g,function(e,t){return p[t]})},snippetCompleter={getCompletions:function(e,t,o,n,p){var i=[],t=t.getTokenAt(o.row,o.column),r=(t&&t.type.match(/(tag-name|tag-open|tag-whitespace|attribute-name|attribute-value)\.xml$/)?i.push("html-tag"):i=snippetManager.getActiveScopes(e),snippetManager.snippetMap),a=[];i.forEach(function(e){for(var t=r[e]||[],o=t.length;o--;){var n=t[o],p=n.name||n.tabTrigger;p&&a.push({caption:p,snippet:n.content,meta:n.tabTrigger&&!n.name?n.tabTrigger+"â‡¥ ":"snippet",type:"snippet"})}},this),p(null,a)},getDocTooltip:function(e){"snippet"!=e.type||e.docHTML||(e.docHTML=["<b>",lang.escapeHTML(e.caption),"</b>","<hr></hr>",lang.escapeHTML(transformSnippetTooltip(e.snippet))].join(""))}},completers=[snippetCompleter,textCompleter,keyWordCompleter],expandSnippet=(exports.setCompleters=function(e){completers.length=0,e&&completers.push.apply(completers,e)},exports.addCompleter=function(e){completers.push(e)},exports.textCompleter=textCompleter,exports.keyWordCompleter=keyWordCompleter,exports.snippetCompleter=snippetCompleter,{name:"expandSnippet",exec:function(e){return snippetManager.expandWithTab(e)},bindKey:"Tab"}),onChangeMode=function(e,t){loadSnippetsForMode(t.session.$mode)},loadSnippetsForMode=function(e){(e="string"==typeof e?config.$modes[e]:e)&&(snippetManager.files||(snippetManager.files={}),loadSnippetFile(e.$id,e.snippetFileId),e.modes)&&e.modes.forEach(loadSnippetsForMode)},loadSnippetFile=function(t,e){e&&t&&!snippetManager.files[t]&&(snippetManager.files[t]={},config.loadModule(e,function(e){e&&(!(snippetManager.files[t]=e).snippets&&e.snippetText&&(e.snippets=snippetManager.parseSnippetFile(e.snippetText)),snippetManager.register(e.snippets||[],e.scope),e.includeScopes)&&(snippetManager.snippetMap[e.scope].includeScopes=e.includeScopes,e.includeScopes.forEach(function(e){loadSnippetsForMode("ace/mode/"+e)}))}))},doLiveAutocomplete=function(e){var t=e.editor,o=t.completer&&t.completer.activated;"backspace"===e.command.name?o&&!util.getCompletionPrefix(t)&&t.completer.detach():"insertstring"===e.command.name&&util.getCompletionPrefix(t)&&!o&&((e=Autocomplete.for(t)).autoInsert=!1,e.showPopup(t))},Editor=require("../editor").Editor;require("../config").defineOptions(Editor.prototype,"editor",{enableBasicAutocompletion:{set:function(e){e?(this.completers||(this.completers=Array.isArray(e)?e:completers),this.commands.addCommand(Autocomplete.startCommand)):this.commands.removeCommand(Autocomplete.startCommand)},value:!1},enableLiveAutocompletion:{set:function(e){e?(this.completers||(this.completers=Array.isArray(e)?e:completers),this.commands.on("afterExec",doLiveAutocomplete)):this.commands.removeListener("afterExec",doLiveAutocomplete)},value:!1},enableSnippets:{set:function(e){e?(this.commands.addCommand(expandSnippet),this.on("changeMode",onChangeMode),onChangeMode(null,this)):(this.commands.removeCommand(expandSnippet),this.off("changeMode",onChangeMode))},value:!1}});