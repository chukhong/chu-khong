"use strict";var openPrompt,Range=require("../range").Range,dom=require("../lib/dom"),shortcuts=require("../ext/menu_tools/get_editor_keyboard_shortcuts"),FilteredList=require("../autocomplete").FilteredList,AcePopup=require("../autocomplete/popup").AcePopup,$singleLineEditor=require("../autocomplete/popup").$singleLineEditor,UndoManager=require("../undomanager").UndoManager,Tokenizer=require("../tokenizer").Tokenizer,overlayPage=require("./menu_tools/overlay_page").overlayPage,modelist=require("./modelist");function prompt(e,o,t,n){if("object"==typeof o)return prompt(e,"",o,t);if(openPrompt){var r=openPrompt;if(e=r.editor,r.close(),r.name&&r.name==t.name)return}if(t.$type)return prompt[t.$type](e,n);var i,s=$singleLineEditor(),r=(s.session.setUndoManager(new UndoManager),dom.buildDom(["div",{class:"ace_prompt_container"+(t.hasDescription?" input-box-with-description":"")}])),a=overlayPage(e,r,p);function c(){var e=i&&0<i.getCursorPosition().row?u():s.getValue(),o=i?i.getData(i.getRow()):e;o&&!o.error&&(p(),t.onAccept)&&t.onAccept({value:e,item:o},s)}r.appendChild(s.container),e&&(e.cmdLine=s).setOption("fontSize",e.getOption("fontSize")),o&&s.setValue(o,1),t.selection&&s.selection.setRange({start:s.session.doc.indexToPosition(t.selection[0]),end:s.session.doc.indexToPosition(t.selection[1])}),t.getCompletions&&((i=new AcePopup).renderer.setStyle("ace_autocomplete_inline"),i.container.style.display="block",i.container.style.maxWidth="600px",i.container.style.width="100%",i.container.style.marginTop="3px",i.renderer.setScrollMargin(2,2,0,0),i.autoSelect=!1,i.renderer.$maxLines=15,i.setRow(-1),i.on("click",function(e){var o=i.getData(i.getRow());o.error||(s.setValue(o.value||o.name||o),c(),e.stop())}),r.appendChild(i.container),m()),t.$rules&&(o=new Tokenizer(t.$rules),s.session.bgTokenizer.setTokenizer(o)),t.placeholder&&s.setOption("placeholder",t.placeholder),t.hasDescription&&(o=dom.buildDom(["div",{class:"ace_prompt_text_container"}]),dom.buildDom(t.prompt||"Press 'Enter' to confirm or 'Escape' to cancel",o),r.appendChild(o)),a.setIgnoreFocusOut(t.ignoreFocusOut);r={Enter:c,"Esc|Shift-Esc":function(){t.onCancel&&t.onCancel(s.getValue(),s),p()}};function p(){a.close(),n&&n(),openPrompt=null}function m(){var e,o;t.getCompletions&&(t.getPrefix&&(e=t.getPrefix(s)),o=t.getCompletions(s),i.setData(o,e),i.resize(!0))}function u(){var e=i.getData(i.getRow());if(e&&!e.error)return e.value||e.caption||e}i&&Object.assign(r,{Up:function(e){i.goTo("up"),u()},Down:function(e){i.goTo("down"),u()},"Ctrl-Up|Ctrl-Home":function(e){i.goTo("start"),u()},"Ctrl-Down|Ctrl-End":function(e){i.goTo("end"),u()},Tab:function(e){i.goTo("down"),u()},PageUp:function(e){i.gotoPageUp(),u()},PageDown:function(e){i.gotoPageDown(),u()}}),s.commands.bindKeys(r),s.on("input",function(){t.onInput&&t.onInput(),m()}),s.resize(!0),i&&i.resize(!0),s.focus(),openPrompt={close:p,name:t.name,editor:e}}prompt.gotoLine=function(s,e){var o;prompt(s,":"+(o=s.selection.toJSON(),(o=Array.isArray(o)?o:[o]).map(function(e){var o=e.isBackwards?e.start:e.end,e=e.isBackwards?e.end:e.start,t=e.row+1+":"+e.column;return e.row==o.row?e.column!=o.column&&(t+=">:"+o.column):t+=">"+(o.row+1)+":"+o.column,t}).reverse().join(", ")),{name:"gotoLine",selection:[1,Number.MAX_VALUE],onAccept:function(e){var e=e.value,o=prompt.gotoLine._history,i=(o||(prompt.gotoLine._history=o=[]),-1!=o.indexOf(e)&&o.splice(o.indexOf(e),1),o.unshift(e),20<o.length&&(o.length=20),s.getCursorPosition()),t=[],o=(e.replace(/^:/,"").split(/,/).map(function(e){var n=e.split(/([<>:+-]|c?\d+)|[^c\d<>:+-]+/).filter(Boolean),r=0;function o(){var e,o,t=n[r++];if(t)return"c"==t[0]?(e=parseInt(t.slice(1))||0,s.session.doc.indexToPosition(e)):(e=i.row,o=0,/\d/.test(t)&&(e=parseInt(t)-1,t=n[r++]),{row:e,column:o=":"==t&&(t=n[r++],/\d/.test(t))?parseInt(t)||0:o})}i=o();e=Range.fromPoints(i,i);">"==n[r]?(r++,e.end=o()):"<"==n[r]&&(r++,e.start=o()),t.unshift(e)}),s.selection.fromJSON(t),s.renderer.scrollTop);s.renderer.scrollSelectionIntoView(s.selection.anchor,s.selection.cursor,.5),s.renderer.animateScrolling(o)},history:function(){s.session.getUndoManager();return prompt.gotoLine._history||[]},getCompletions:function(e){var e=e.getValue(),o=e.replace(/^:/,"").split(":"),o=Math.min(parseInt(o[0])||1,s.session.getLength())-1;return[e+"  "+s.session.getLine(o)].concat(this.history())},$rules:{start:[{regex:/\d+/,token:"string"},{regex:/[:,><+\-c]/,token:"keyword"}]}})},prompt.commands=function(t,e){a=["insertstring","inserttext","setIndentation","paste"],c=[],p={},t.keyBinding.$handlers.forEach(function(e){var o,t=e.platform,n=e.byName;for(o in n){var r=n[o].bindKey,i=("string"!=typeof r&&(r=r&&r[t]||""),n[o]),s=i.description||(i.name||"").replace(/^./,function(e){return e.toUpperCase(e)}).replace(/[a-z][A-Z]/g,function(e){return e[0]+" "+e[1].toLowerCase(e)});(i=Array.isArray(i)?i:[i]).forEach(function(o){"string"!=typeof o&&(o=o.name),a.find(function(e){return e===o})||(p[o]?p[o].key+="|"+r:(p[o]={key:r,command:o,description:s},c.push(p[o])))})}});var a,c,p,m=(m=c).map(function(e){return{value:e.description,meta:e.key,command:e.command}});prompt(t,"",{name:"commands",selection:[0,Number.MAX_VALUE],maxHistoryCount:5,onAccept:function(e){var o;e.item&&(o=e.item.command,this.addToHistory(e.item),t.execCommand(o))},addToHistory:function(e){var o=this.history();o.unshift(e),delete e.message;for(var t=1;t<o.length;t++)if(o[t].command==e.command){o.splice(t,1);break}0<this.maxHistoryCount&&o.length>this.maxHistoryCount&&o.splice(o.length-1,1),prompt.commands.history=o},history:function(){return prompt.commands.history||[]},getPrefix:function(e){var o=e.getCursorPosition();return e.getValue().substring(0,o.column)},getCompletions:function(e){function o(e,o){e=JSON.parse(JSON.stringify(e));return new FilteredList(e).filterCompletions(e,o)}var e=this.getPrefix(e),t=o(this.history(),e);s=m;var n,r,i=o(i=(i=t)&&i.length?(n=[],i.forEach(function(e){n.push(e.command)}),r=[],s.forEach(function(e){-1===n.indexOf(e.command)&&r.push(e)}),r):s,e),s=(t.length&&i.length&&(t[0].message=" Recently used",i[0].message=" Other commands"),t.concat(i));return 0<s.length?s:[{value:"No matching commands",error:1}]}})},prompt.modes=function(o,e){var t=(t=modelist.modes).map(function(e){return{value:e.caption,mode:e.name}});prompt(o,"",{name:"modes",selection:[0,Number.MAX_VALUE],onAccept:function(e){e.item&&(e="ace/mode/"+e.item.mode,o.session.setMode(e))},getPrefix:function(e){var o=e.getCursorPosition();return e.getValue().substring(0,o.column)},getCompletions:function(e){var e=this.getPrefix(e),o=(o=t,e=e,o=JSON.parse(JSON.stringify(o)),new FilteredList(o).filterCompletions(o,e));return 0<o.length?o:[{caption:"No mode matching",value:"No mode matching",error:1}]}})},dom.importCssString(`.ace_prompt_container {
    max-width: 600px;
    width: 100%;
    margin: 20px auto;
    padding: 3px;
    background: white;
    border-radius: 2px;
    box-shadow: 0px 2px 3px 0px #555;
}`,"promtp.css",!1),exports.prompt=prompt;