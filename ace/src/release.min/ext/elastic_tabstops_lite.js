"use strict";var ElasticTabstopsLite=function(t){this.$editor=t;var s=this,e=[],i=!1;this.onAfterExec=function(){i=!1,s.processRows(e),e=[]},this.onExec=function(){i=!0},this.onChange=function(t){i&&(-1==e.indexOf(t.start.row)&&e.push(t.start.row),t.end.row!=t.start.row)&&e.push(t.end.row)}},Editor=(!function(){this.processRows=function(t){this.$inChange=!0;for(var s=[],e=0,i=t.length;e<i;e++){var o=t[e];if(!(-1<s.indexOf(o)))for(var o=this.$findCellWidthsForBlock(o),n=this.$setBlockCellWidthsToMax(o.cellWidths),r=o.firstRow,h=0,a=n.length;h<a;h++){var l=n[h];s.push(r),this.$adjustRow(r,l),r++}}this.$inChange=!1},this.$findCellWidthsForBlock=function(t){for(var s,e=[],i=t;0<=i&&0!=(s=this.$cellWidthsForRow(i)).length;)e.unshift(s),i--;for(var o=i+1,i=t,n=this.$editor.session.getLength();i<n-1&&0!=(s=this.$cellWidthsForRow(++i)).length;)e.push(s);return{cellWidths:e,firstRow:o}},this.$cellWidthsForRow=function(t){for(var s=this.$selectionColumnsForRow(t),e=[-1].concat(this.$tabsForRow(t)),i=e.map(function(t){return 0}).slice(1),o=this.$editor.session.getLine(t),n=0,r=e.length-1;n<r;n++){var h=e[n]+1,a=e[n+1],l=this.$rightmostSelectionInCell(s,a),a=o.substring(h,a);i[n]=Math.max(a.replace(/\s+$/g,"").length,l-h)}return i},this.$selectionColumnsForRow=function(t){var s=[],e=this.$editor.getCursorPosition();return this.$editor.session.getSelection().isEmpty()&&t==e.row&&s.push(e.column),s},this.$setBlockCellWidthsToMax=function(t){for(var s,e,i=!0,o=this.$izip_longest(t),n=0,r=o.length;n<r;n++){var h=o[n];if(h.push){h.push(NaN);for(var a=0,l=h.length;a<l;a++){var c=h[a];if(i&&(s=a,e=0,i=!1),isNaN(c)){for(var u=a,f=s;f<u;f++)t[f][n]=e;i=!0}e=Math.max(e,c)}}else console.error(h)}return t},this.$rightmostSelectionInCell=function(t,s){var e=0;if(t.length){for(var i=[],o=0,n=t.length;o<n;o++)t[o]<=s?i.push(o):i.push(0);e=Math.max.apply(Math,i)}return e},this.$tabsForRow=function(t){for(var s,e=[],i=this.$editor.session.getLine(t),o=/\t/g;null!=(s=o.exec(i));)e.push(s.index);return e},this.$adjustRow=function(t,s){var e=this.$tabsForRow(t);if(0!=e.length)for(var i=0,o=-1,n=this.$izip(s,e),r=0,h=n.length;r<h;r++){var a,l,c=n[r][0],u=n[r][1],c=(o+=1+c)-(u+=i);0!=c&&(a=(l=this.$editor.session.getLine(t).substr(0,u)).replace(/\s*$/g,""),l=l.length-a.length,0<c&&(this.$editor.session.getDocument().insertInLine({row:t,column:u+1},Array(1+c).join(" ")+"\t"),this.$editor.session.getDocument().removeInLine(t,u,u+1),i+=c),c<0&&-c<=l)&&(this.$editor.session.getDocument().removeInLine(t,u+c,u),i+=c)}},this.$izip_longest=function(t){if(!t[0])return[];for(var s=t[0].length,e=t.length,i=1;i<e;i++){var o=t[i].length;s<o&&(s=o)}for(var n=[],r=0;r<s;r++){for(var h=[],i=0;i<e;i++)""===t[i][r]?h.push(NaN):h.push(t[i][r]);n.push(h)}return n},this.$izip=function(t,s){for(var e=(t.length>=s.length?s:t).length,i=[],o=0;o<e;o++){var n=[t[o],s[o]];i.push(n)}return i}}.call(ElasticTabstopsLite.prototype),exports.ElasticTabstopsLite=ElasticTabstopsLite,require("../editor").Editor);require("../config").defineOptions(Editor.prototype,"editor",{useElasticTabstops:{set:function(t){t?(this.elasticTabstops||(this.elasticTabstops=new ElasticTabstopsLite(this)),this.commands.on("afterExec",this.elasticTabstops.onAfterExec),this.commands.on("exec",this.elasticTabstops.onExec),this.on("change",this.elasticTabstops.onChange)):this.elasticTabstops&&(this.commands.removeListener("afterExec",this.elasticTabstops.onAfterExec),this.commands.removeListener("exec",this.elasticTabstops.onExec),this.removeListener("change",this.elasticTabstops.onChange))}}});