"use strict";var TokenIterator=require("../token_iterator").TokenIterator;function is(t,e){return-1<t.type.lastIndexOf(e+".xml")}exports.singletonTags=["area","base","br","col","command","embed","hr","html","img","input","keygen","link","meta","param","source","track","wbr"],exports.blockTags=["article","aside","blockquote","body","div","dl","fieldset","footer","form","head","header","html","nav","ol","p","script","section","style","table","tbody","tfoot","thead","ul"],exports.formatOptions={lineBreaksAfterCommasInCurlyBlock:!0},exports.beautify=function(t){for(var e,r,s,a,o,i=new TokenIterator(t,0,0),n=i.getCurrentToken(),c=t.getTabString(),l=exports.singletonTags,m=exports.blockTags,p=exports.formatOptions||{},u=!1,f=!1,h=!1,g="",y="",b="",d=0,k=0,$=0,x=0,w=0,v=0,T=0,C=0,I=!1,R=!1,B=!1,O={0:0},q=[],A=!1,F=function(){e&&e.value&&"string.regexp"!==e.type&&(e.value=e.value.replace(/^\s*/,""))},S=function(){for(var t=g.length-1;0!=t&&" "===g[t];)t-=1;g=g.slice(0,t+1)},_=function(){g=g.trimRight(),u=!1};null!==n;){if(s=i.getCurrentTokenRow(),i.$rowTokens,e=i.stepForward(),void 0!==n){if(y=n.value,w=0,o="style"===b||"ace/mode/css"===t.$modeId,is(n,"tag-open")?(R=!0,e&&(B=-1!==m.indexOf(e.value)),"</"===y&&(B&&!u&&C<1&&C++,o&&(C=1),B=!(w=1))):is(n,"tag-close")?R=!1:is(n,"comment.start")?B=!0:is(n,"comment.end")&&(B=!1),R||C||"paren.rparen"!==n.type||"}"!==n.value.substr(0,1)||C++,s!==r&&(C=s,r)&&(C-=r),C){for(_();0<C;C--)g+="\n";u=!0,is(n,"comment")||n.type.match(/^(comment|string)$/)||(y=y.trimLeft())}if(y){if("keyword"===n.type&&y.match(/^(if|else|elseif|for|foreach|while|switch)$/)?(q[d]=y,F(),h=!0,y.match(/^(else|elseif)$/)&&g.match(/\}[\s]*$/)&&(_(),f=!0)):"paren.lparen"===n.type?(F(),"{"===y.substr(-1)&&(I=!(h=!0),R||(C=1)),"{"===y.substr(0,1)&&(f=!0,"["!==g.substr(-1)&&"["===g.trimRight().substr(-1)?(_(),f=!1):(")"===g.trimRight().substr(-1)?_:S)())):"paren.rparen"===n.type?("}"===y.substr(0,w=1)&&("case"===q[d-1]&&w++,"{"===g.trimRight().substr(-1)?_():(f=!0,o&&(C+=2))),"]"===y.substr(0,1)&&"}"!==g.substr(-1)&&"}"===g.trimRight().substr(-1)&&(f=!1,x++,_()),")"===y.substr(0,1)&&"("!==g.substr(-1)&&"("===g.trimRight().substr(-1)&&(f=!1,x++,_()),S()):"keyword.operator"!==n.type&&"keyword"!==n.type||!y.match(/^(=|==|===|!=|!==|&&|\|\||and|or|xor|\+=|.=|>|>=|<|<=|=>)$/)?"punctuation.operator"===n.type&&";"===y?(_(),F(),h=!0,o&&C++):"punctuation.operator"===n.type&&y.match(/^(:|,)$/)?(_(),F(),y.match(/^(,)$/)&&0<T&&0===v&&p.lineBreaksAfterCommasInCurlyBlock?C++:u=!(h=!0)):"support.php_tag"!==n.type||"?>"!==y||u?is(n,"attribute-name")&&g.substr(-1).match(/^\s$/)?f=!0:is(n,"attribute-equals")?(S(),F()):is(n,"tag-close")?(S(),"/>"===y&&(f=!0)):"keyword"===n.type&&y.match(/^(case|default)$/)&&A&&(w=1):(_(),f=!0):(_(),F(),h=f=!0),u&&(!n.type.match(/^(comment)$/)||y.substr(0,1).match(/^[/#]$/))&&(!n.type.match(/^(string)$/)||y.substr(0,1).match(/^['"@]$/))){if(x=$,k<d)for(x++,a=d;k<a;a--)O[a]=x;else d<k&&(x=O[d]);for(k=d,$=x,w&&(x-=w),I&&!v&&(x++,I=!1),a=0;a<x;a++)g+=c}if("keyword"===n.type&&y.match(/^(case|default)$/)?!1===A&&(q[d]=y,d++,A=!0):"keyword"===n.type&&y.match(/^(break)$/)&&q[d-1]&&q[d-1].match(/^(case|default)$/)&&(d--,A=!1),"paren.lparen"===n.type&&(v+=(y.match(/\(/g)||[]).length,T+=(y.match(/\{/g)||[]).length,d+=y.length),"keyword"===n.type&&y.match(/^(if|else|elseif|for|while)$/)?(I=!0,v=0):!v&&y.trim()&&"comment"!==n.type&&(I=!1),"paren.rparen"===n.type)for(v-=(y.match(/\)/g)||[]).length,T-=(y.match(/\}/g)||[]).length,a=0;a<y.length;a++)d--,"}"===y.substr(a,1)&&"case"===q[d]&&d--;"text"==n.type&&(y=y.replace(/\s+$/," ")),f&&!u&&(S(),"\n"!==g.substr(-1))&&(g+=" "),g+=y,h&&(g+=" "),h=f=u=!1,(is(n,"tag-close")&&(B||-1!==m.indexOf(b))||is(n,"doctype")&&">"===y)&&(C=B&&e&&"</"===e.value?-1:1),e&&-1===l.indexOf(e.value)&&(is(n,"tag-open")&&"</"===y?d--:is(n,"tag-open")&&"<"===y?d++:is(n,"tag-close")&&"/>"===y&&d--),is(n,"tag-name")&&(b=y),r=s}}n=e}g=g.trim(),t.doc.setValue(g)},exports.commands=[{name:"beautify",description:"Format selection (Beautify)",exec:function(t){exports.beautify(t.session)},bindKey:"Ctrl-Shift-B"}];