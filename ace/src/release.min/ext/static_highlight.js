"use strict";var EditSession=require("../edit_session").EditSession,TextLayer=require("../layer/text").Text,baseStyles=require("./static.css"),config=require("../config"),dom=require("../lib/dom"),escapeHTML=require("../lib/lang").escapeHTML;function Element(e){this.type=e,this.style={},this.textContent=""}Element.prototype.cloneNode=function(){return this},Element.prototype.appendChild=function(e){this.textContent+=e.toString()},Element.prototype.toString=function(){var e=[];if("fragment"!=this.type){e.push("<",this.type),this.className&&e.push(" class='",this.className,"'");var t,n=[];for(t in this.style)n.push(t,":",this.style[t]);n.length&&e.push(" style='",n.join(""),"'"),e.push(">")}return this.textContent&&e.push(this.textContent),"fragment"!=this.type&&e.push("</",this.type,">"),e.join("")};var simpleDom={createTextNode:function(e,t){return escapeHTML(e)},createElement:function(e){return new Element(e)},createFragment:function(){return new Element("fragment")}},SimpleTextLayer=function(){this.config={},this.dom=simpleDom},highlight=(SimpleTextLayer.prototype=TextLayer.prototype,function(s,e,r){var t=s.className.match(/lang-(\w+)/),t=e.mode||t&&"ace/mode/"+t[1];if(!t)return!1;var n=e.theme||"ace/theme/textmate",i="",o=[];if(s.firstElementChild)for(var a=0,l=0;l<s.childNodes.length;l++){var h=s.childNodes[l];3==h.nodeType?(a+=h.data.length,i+=h.data):o.push(a,h)}else i=s.textContent,e.trim&&(i=i.trim());highlight.render(i,t,n,e.firstLineNumber,!e.showGutter,function(e){dom.importCssString(e.css,"ace_highlight"),s.innerHTML=e.html;for(var t=s.firstChild.firstChild,n=0;n<o.length;n+=2){var i=e.session.doc.indexToPosition(o[n]),i=t.children[i.row];i&&i.appendChild(o[n+1])}r&&r()})});highlight.render=function(t,n,i,s,r,o){var a,l=1,h=EditSession.prototype.$modes;function c(){var e=highlight.renderSync(t,n,i,s,r);return o?o(e):e}return"string"==typeof i&&(l++,config.loadModule(["theme",i],function(e){i=e,--l||c()})),"string"==typeof(n=n&&"object"==typeof n&&!n.getTokenizer?(a=n).path:n)&&(l++,config.loadModule(["mode",n],function(e){h[n]&&!a||(h[n]=new e.Mode(a)),n=h[n],--l||c()})),--l||c()},highlight.renderSync=function(e,t,n,i,s){i=parseInt(i||1,10);var r=new EditSession(""),o=(r.setUseWorker(!1),r.setMode(t),new SimpleTextLayer),a=(o.setSession(r),Object.keys(o.$tabStrings).forEach(function(e){var t;"string"==typeof o.$tabStrings[e]&&((t=simpleDom.createFragment()).textContent=o.$tabStrings[e],o.$tabStrings[e]=t)}),r.setValue(e),r.getLength()),t=simpleDom.createElement("div"),l=(t.className=n.cssClass,simpleDom.createElement("div"));l.className="ace_static_highlight"+(s?"":" ace_show_gutter"),l.style["counter-reset"]="ace_line "+(i-1);for(var h=0;h<a;h++){var c,m=simpleDom.createElement("div");m.className="ace_line",s||((c=simpleDom.createElement("span")).className="ace_gutter ace_gutter-cell",c.textContent="",m.appendChild(c)),o.$renderLine(m,h,!1),m.textContent+="\n",l.appendChild(m)}return t.appendChild(l),{css:baseStyles+n.cssText,html:t.toString(),session:r}},module.exports=highlight,module.exports.highlight=highlight;