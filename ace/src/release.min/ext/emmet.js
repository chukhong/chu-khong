"use strict";var emmet,emmetPath,HashHandler=require("../keyboard/hash_handler").HashHandler,Editor=require("../editor").Editor,snippetManager=require("../snippets").snippetManager,Range=require("../range").Range,config=require("../config");function AceEmmetEditor(){}AceEmmetEditor.prototype={setupContext:function(e){this.ace=e,this.indentation=e.session.getTabString(),((emmet=emmet||window.emmet).resources||emmet.require("resources")).setVariable("indentation",this.indentation),this.$syntax=null,this.$syntax=this.getSyntax()},getSelectionRange:function(){var e=this.ace.getSelectionRange(),t=this.ace.session.doc;return{start:t.positionToIndex(e.start),end:t.positionToIndex(e.end)}},createSelection:function(e,t){var n=this.ace.session.doc;this.ace.selection.setRange({start:n.indexToPosition(e),end:n.indexToPosition(t)})},getCurrentLineRange:function(){var e=this.ace,t=e.getCursorPosition().row,n=e.session.getLine(t).length,e=e.session.doc.positionToIndex({row:t,column:0});return{start:e,end:e+n}},getCaretPos:function(){var e=this.ace.getCursorPosition();return this.ace.session.doc.positionToIndex(e)},setCaretPos:function(e){e=this.ace.session.doc.indexToPosition(e);this.ace.selection.moveToPosition(e)},getCurrentLine:function(){var e=this.ace.getCursorPosition().row;return this.ace.session.getLine(e)},replaceContent:function(e,t,n,i){null==n&&(n=null==t?this.getContent().length:t);var o=this.ace,r=o.session.doc,t=Range.fromPoints(r.indexToPosition(t=null==t?0:t),r.indexToPosition(n));o.session.remove(t),t.end=t.start,e=this.$updateTabstops(e),snippetManager.insertSnippet(o,e)},getContent:function(){return this.ace.getValue()},getSyntax:function(){var e,t;return this.$syntax||(("html"==(e=this.ace.session.$modeId.split("/").pop())||"php"==e)&&(t=this.ace.getCursorPosition(),t="string"!=typeof(t=this.ace.session.getState(t.row))?t[0]:t)&&(1<(t=t.split("-")).length?e=t[0]:"php"==e&&(e="html")),e)},getProfileName:function(){var e=emmet.resources||emmet.require("resources");switch(this.getSyntax()){case"css":return"css";case"xml":case"xsl":return"xml";case"html":return e.getVariable("profile")||(-1!=this.ace.session.getLines(0,2).join("").search(/<!DOCTYPE[^>]+XHTML/i)?"xhtml":"html");default:var t=this.ace.session.$mode;return t.emmetConfig&&t.emmetConfig.profile||"xhtml"}},prompt:function(e){return prompt(e)},getSelection:function(){return this.ace.session.getTextRange()},getFilePath:function(){return""},$updateTabstops:function(e){var o=0,r=null,s=emmet.tabStops||emmet.require("tabStops"),t=(emmet.resources||emmet.require("resources")).getVocabulary("user"),a={tabstop:function(e){var t=parseInt(e.group,10),n=0===t,i=(n?t=++o:t+=1e3,e.placeholder),t="${"+t+((i=i&&s.processText(i,a))?":"+i:"")+"}";return n&&(r=[e.start,t]),t},escape:function(e){return"$"==e?"\\$":"\\"==e?"\\\\":e}};return e=s.processText(e,a),t.variables.insert_final_tabstop&&!/\$\{0\}$/.test(e)?e+="${0}":r&&(e=(emmet.utils?emmet.utils.common:emmet.require("utils")).replaceSubstring(e,"${0}",r[0],r[1])),e}};var command,keymap={expand_abbreviation:{mac:"ctrl+alt+e",win:"alt+e"},match_pair_outward:{mac:"ctrl+d",win:"ctrl+,"},match_pair_inward:{mac:"ctrl+j",win:"ctrl+shift+0"},matching_pair:{mac:"ctrl+alt+j",win:"alt+j"},next_edit_point:"alt+right",prev_edit_point:"alt+left",toggle_comment:{mac:"command+/",win:"ctrl+/"},split_join_tag:{mac:"shift+command+'",win:"shift+ctrl+`"},remove_tag:{mac:"command+'",win:"shift+ctrl+;"},evaluate_math_expression:{mac:"shift+command+y",win:"shift+ctrl+y"},increment_number_by_1:"ctrl+up",decrement_number_by_1:"ctrl+down",increment_number_by_01:"alt+up",decrement_number_by_01:"alt+down",increment_number_by_10:{mac:"alt+command+up",win:"shift+alt+up"},decrement_number_by_10:{mac:"alt+command+down",win:"shift+alt+down"},select_next_item:{mac:"shift+command+.",win:"shift+ctrl+."},select_previous_item:{mac:"shift+command+,",win:"shift+ctrl+,"},reflect_css_value:{mac:"shift+command+r",win:"shift+ctrl+r"},encode_decode_data_url:{mac:"shift+ctrl+d",win:"ctrl+'"},expand_abbreviation_with_tab:"Tab",wrap_with_abbreviation:{mac:"shift+ctrl+a",win:"shift+ctrl+a"}},editorProxy=new AceEmmetEditor;for(command in exports.commands=new HashHandler,exports.runEmmetCommand=function t(n){if("expand_abbreviation_with_tab"==this.action){if(!n.selection.isEmpty())return!1;var i=n.selection.lead,i=n.session.getTokenAt(i.row,i.column);if(i&&/\btag\b/.test(i.type))return!1}try{editorProxy.setupContext(n);var e=emmet.actions||emmet.require("actions");if("wrap_with_abbreviation"==this.action)return setTimeout(function(){e.run("wrap_with_abbreviation",editorProxy)},0);var o=e.run(this.action,editorProxy)}catch(e){if(!emmet)return i=exports.load(t.bind(this,n)),"expand_abbreviation_with_tab"!=this.action&&i;n._signal("changeStatus","string"==typeof e?e:e.message),config.warn(e),o=!1}return o},keymap)exports.commands.addCommand({name:"emmet:"+command,action:command,bindKey:keymap[command],exec:exports.runEmmetCommand,multiSelectAction:"forEach"});exports.updateCommands=function(e,t){t?e.keyBinding.addKeyboardHandler(exports.commands):e.keyBinding.removeKeyboardHandler(exports.commands)},exports.isSupportedMode=function(e){return!!e&&(!!e.emmetConfig||(e=e.$id||e,/css|less|scss|sass|stylus|html|php|twig|ejs|handlebars/.test(e)))},exports.isAvailable=function(e,t){if(/(evaluate_math_expression|expand_abbreviation)$/.test(t))return!0;var t=e.session.$mode,n=exports.isSupportedMode(t);if(n&&t.$modes)try{editorProxy.setupContext(e),/js|php/.test(editorProxy.getSyntax())&&(n=!1)}catch(e){}return n};var onChangeMode=function(e,t){var n;t&&(n=exports.isSupportedMode(t.session.$mode),(n=!1===e.enableEmmet?!1:n)&&exports.load(),exports.updateCommands(t,n))};exports.load=function(e){return"string"!=typeof emmetPath?(config.warn("script for emmet-core is not loaded"),!1):(config.loadModule(emmetPath,function(){emmetPath=null,e&&e()}),!0)},exports.AceEmmetEditor=AceEmmetEditor,config.defineOptions(Editor.prototype,"editor",{enableEmmet:{set:function(e){this[e?"on":"removeListener"]("changeMode",onChangeMode),onChangeMode({enableEmmet:!!e},this)},value:!0}}),exports.setCore=function(e){"string"==typeof e?emmetPath=e:emmet=e};