"use strict";var event=require("../lib/event"),UA=require("../lib/useragent"),net=require("../lib/net"),ace=require("../ace"),getCSSProperty=(module.exports=exports=ace,function(e,t,n){var i=e.style[n];return i=(i=i||(window.getComputedStyle?window.getComputedStyle(e,"").getPropertyValue(n):e.currentStyle[n]))&&"auto"!=i&&"intrinsic"!=i?i:t.style[n]});function applyStyles(e,t){for(var n in t)e.style[n]=t[n]}function setupContainer(i,t){if("textarea"!=i.type)throw new Error("Textarea required!");function e(){var t="position:relative;",e=(["margin-top","margin-left","margin-right","margin-bottom"].forEach(function(e){t+=e+":"+getCSSProperty(i,o,e)+";"}),getCSSProperty(i,o,"width")||i.clientWidth+"px"),n=getCSSProperty(i,o,"height")||i.clientHeight+"px",t=t+("height:"+n+";width:"+e+";")+"display:inline-block;";o.setAttribute("style",t)}var n=i.parentNode,o=document.createElement("div");for(event.addListener(window,"resize",e),e(),n.insertBefore(o,i.nextSibling);n!==document;){if("FORM"===n.tagName.toUpperCase()){var r=n.onsubmit;n.onsubmit=function(e){i.value=t(),r&&r.call(this,e)};break}n=n.parentNode}return o}function load(e,t,n){net.loadScript(e,function(){require([t],n)})}function setupApi(i,e,t,n,o){i.getSession(),i.renderer;return i.setDisplaySettings=function(e){(e=null==e?"none"==t.style.display:e)?(t.style.display="block",t.hideButton.focus(),i.on("focus",function e(){i.removeListener("focus",e),t.style.display="none"})):i.focus()},i.$setOption=i.setOption,i.$getOption=i.getOption,i.setOption=function(e,t){switch(e){case"mode":i.$setOption("mode","ace/mode/"+t);break;case"theme":i.$setOption("theme","ace/theme/"+t);break;case"keybindings":switch(t){case"vim":i.setKeyboardHandler("ace/keyboard/vim");break;case"emacs":i.setKeyboardHandler("ace/keyboard/emacs");break;default:i.setKeyboardHandler(null)}break;case"wrap":case"fontSize":i.$setOption(e,t);break;default:i.$setOption(e,"true"===(n=t)||1==n)}var n},i.getOption=function(e){switch(e){case"mode":return i.$getOption("mode").substr("ace/mode/".length);case"theme":return i.$getOption("theme").substr("ace/theme/".length);case"keybindings":var t=i.getKeyboardHandler();switch(t&&t.$id){case"ace/keyboard/vim":return"vim";case"ace/keyboard/emacs":return"emacs";default:return"ace"}break;default:return i.$getOption(e)}},i.setOptions(o),i}function setupSettingPanel(e,t,n){var i,o={mode:"Mode:",wrap:"Soft Wrap:",theme:"Theme:",fontSize:"Font Size:",showGutter:"Display Gutter:",keybindings:"Keyboard",showPrintMargin:"Show Print Margin:",useSoftTabs:"Use Soft Tabs:",showInvisibles:"Show Invisibles"},r={mode:{text:"Plain",javascript:"JavaScript",xml:"XML",html:"HTML",css:"CSS",scss:"SCSS",python:"Python",php:"PHP",java:"Java",ruby:"Ruby",c_cpp:"C/C++",coffee:"CoffeeScript",json:"json",perl:"Perl",clojure:"Clojure",ocaml:"OCaml",csharp:"C#",haxe:"haXe",svg:"SVG",textile:"Textile",groovy:"Groovy",liquid:"Liquid",Scala:"Scala"},theme:{clouds:"Clouds",clouds_midnight:"Clouds Midnight",cobalt:"Cobalt",crimson_editor:"Crimson Editor",dawn:"Dawn",gob:"Green on Black",eclipse:"Eclipse",idle_fingers:"Idle Fingers",kr_theme:"Kr Theme",merbivore:"Merbivore",merbivore_soft:"Merbivore Soft",mono_industrial:"Mono Industrial",monokai:"Monokai",pastel_on_dark:"Pastel On Dark",solarized_dark:"Solarized Dark",solarized_light:"Solarized Light",textmate:"Textmate",twilight:"Twilight",vibrant_ink:"Vibrant Ink"},showGutter:null,fontSize:{"10px":"10px","11px":"11px","12px":"12px","14px":"14px","16px":"16px"},wrap:{off:"Off",40:"40",80:"80",free:"Free"},keybindings:{ace:"ace",vim:"vim",emacs:"emacs"},showPrintMargin:null,useSoftTabs:null,showInvisibles:null},a=[];for(i in a.push("<table><tr><th>Setting</th><th>Value</th></tr>"),exports.defaultOptions){a.push("<tr><td>",o[i],"</td>"),a.push("<td>"),c=u=p=l=s=void 0;var s=a,l=i,p=r[i],u=n.getOption(i);if(p){for(var c in s.push("<select title='"+l+"'>"),p)s.push("<option value='"+c+"' "),u==c&&s.push(" selected "),s.push(">",p[c],"</option>");s.push("</select>")}else s.push("<input type='checkbox' title='",l,"' ",u+""=="true"?"checked='true'":"","'></input>");a.push("</td></tr>")}a.push("</table>"),e.innerHTML=a.join("");for(var d=function(e){e=e.currentTarget;n.setOption(e.title,e.value)},h=function(e){e=e.currentTarget;n.setOption(e.title,e.checked)},g=e.getElementsByTagName("select"),f=0;f<g.length;f++)g[f].onchange=d;for(var m=e.getElementsByTagName("input"),f=0;f<m.length;f++)m[f].onclick=h;var b=document.createElement("input");b.type="button",b.value="Hide",event.addListener(b,"click",function(){n.setDisplaySettings(!1)}),e.appendChild(b),e.hideButton=b}exports.transformTextarea=function(e,t){var n=e.autofocus||document.activeElement==e,o=setupContainer(e,function(){return p.getValue()}),i=(e.style.display="none",o.style.background="white",document.createElement("div")),r=(applyStyles(i,{top:"0px",left:"0px",right:"0px",bottom:"0px",border:"1px solid gray",position:"absolute"}),o.appendChild(i),document.createElement("div")),a=(applyStyles(r,{position:"absolute",right:"0px",bottom:"0px",cursor:"nw-resize",border:"solid 9px",borderColor:"lightblue gray gray #ceade6",zIndex:101}),document.createElement("div")),s={top:"0px",left:"20%",right:"0px",bottom:"0px",position:"absolute",padding:"5px",zIndex:100,color:"white",display:"none",overflow:"auto",fontSize:"14px",boxShadow:"-5px 2px 3px gray"},l=(UA.isOldIE?s.backgroundColor="#333":s.backgroundColor="rgba(0, 0, 0, 0.6)",applyStyles(a,s),o.appendChild(a),t=t||exports.defaultOptions,ace.edit(i)),p=l.getSession(),u=(p.setValue(e.value||e.innerHTML),n&&l.focus(),o.appendChild(r),setupApi(l,i,a,ace,t),setupSettingPanel(a,r,l),"");return event.addListener(r,"mousemove",function(e){var t=this.getBoundingClientRect();e.clientX-t.left+(e.clientY-t.top)<(t.width+t.height)/2?(this.style.cursor="pointer",u="toggle"):(u="resize",this.style.cursor="nw-resize")}),event.addListener(r,"mousedown",function(e){var t,n,i;e.preventDefault(),"toggle"==u?l.setDisplaySettings():(o.style.zIndex=1e5,t=o.getBoundingClientRect(),n=t.width+t.left-e.clientX,i=t.height+t.top-e.clientY,event.capture(r,function(e){o.style.width=e.clientX-t.left+n+"px",o.style.height=e.clientY-t.top+i+"px",l.resize()},function(){}))}),l},exports.defaultOptions={mode:"javascript",theme:"textmate",wrap:"off",fontSize:"12px",showGutter:"false",keybindings:"ace",showPrintMargin:"false",useSoftTabs:"true",showInvisibles:"false"};