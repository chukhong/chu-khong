"use strict";var Range=require("../range").Range;function hardWrap(e,n){for(var t=n.column||e.getOption("printMarginColumn"),r=0!=n.allowMerge,a=Math.min(n.startRow,n.endRow),o=Math.max(n.startRow,n.endRow),s=e.session;a<=o;){var i,l,g,d,h,c=s.getLine(a);c.length>t?((d=p(c,t,5))&&(i=/^\s*/.exec(c)[0],s.replace(new Range(a,d.start,a,d.end),"\n"+i)),o++):r&&/\S/.test(c)&&a!=o&&(i=s.getLine(a+1))&&/\S/.test(i)&&((d=p(h=(l=c.replace(/\s+$/,""))+" "+(g=i.replace(/^\s+/,"")),t,5))&&d.start>l.length||h.length<t?(h=new Range(a,l.length,a+1,i.length-g.length),s.replace(h," "),a--,o--):l.length<c.length&&s.remove(new Range(a,l.length,a,c.length))),a++}function p(e,n,t){var r,a,o;if(!(e.length<n))return r=e.slice(0,n),e=e.slice(n),e=/^(?:(\s+)|(\S+)(\s+))/.exec(e),o=a=0,(r=/(?:(\s+)|(\s+)(\S+))$/.exec(r))&&!r[2]&&(a=n-r[1].length,o=n),e&&!e[2]&&(a=a||n,o=n+e[1].length),a?{start:a,end:o}:r&&r[2]&&r.index>t?{start:r.index,end:r.index+r[2].length}:e&&e[2]?{start:a=n+e[2].length,end:a+e[3].length}:void 0}}function wrapAfterInput(e){var n,t;"insertstring"!=e.command.name||!/\S/.test(e.args)||(n=(e=e.editor).selection.cursor).column<=e.renderer.$printMarginColumn||(t=e.session.$undoManager.$lastDelta,hardWrap(e,{startRow:n.row,endRow:n.row,allowMerge:!1}),t!=e.session.$undoManager.$lastDelta&&e.session.markUndoGroup())}var Editor=require("../editor").Editor;require("../config").defineOptions(Editor.prototype,"editor",{hardWrap:{set:function(e){e?this.commands.on("afterExec",wrapAfterInput):this.commands.off("afterExec",wrapAfterInput)},value:!1}}),exports.hardWrap=hardWrap;