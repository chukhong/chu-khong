"use strict";var oop=require("../lib/oop"),dom=require("../lib/dom"),lang=require("../lib/lang"),Lines=require("./lines").Lines,EventEmitter=require("../lib/event_emitter").EventEmitter,Text=function(e){this.dom=dom,this.element=this.dom.createElement("div"),this.element.className="ace_layer ace_text-layer",e.appendChild(this.element),this.$updateEolChar=this.$updateEolChar.bind(this),this.$lines=new Lines(this.element)};!function(){oop.implement(this,EventEmitter),this.EOF_CHAR="¶",this.EOL_CHAR_LF="¬",this.EOL_CHAR_CRLF="¤",this.EOL_CHAR=this.EOL_CHAR_LF,this.TAB_CHAR="—",this.SPACE_CHAR="·",this.$padding=0,this.MAX_LINE_LENGTH=1e4,this.$updateEolChar=function(){var e=this.session.doc,e="\n"==e.getNewLineCharacter()&&"windows"!=e.getNewLineMode()?this.EOL_CHAR_LF:this.EOL_CHAR_CRLF;if(this.EOL_CHAR!=e)return this.EOL_CHAR=e,!0},this.setPadding=function(e){this.$padding=e,this.element.style.margin="0 "+e+"px"},this.getLineHeight=function(){return this.$fontMetrics.$characterSize.height||0},this.getCharacterWidth=function(){return this.$fontMetrics.$characterSize.width||0},this.$setFontMetrics=function(e){this.$fontMetrics=e,this.$fontMetrics.on("changeCharacterSize",function(e){this._signal("changeCharacterSize",e)}.bind(this)),this.$pollSizeChanges()},this.checkForSizeChanges=function(){this.$fontMetrics.checkForSizeChanges()},this.$pollSizeChanges=function(){return this.$pollSizeChangesTimer=this.$fontMetrics.$pollSizeChanges()},this.setSession=function(e){(this.session=e)&&this.$computeTabString()},this.showInvisibles=!1,this.showSpaces=!1,this.showTabs=!1,this.showEOL=!1,this.setShowInvisibles=function(e){return this.showInvisibles!=e&&("string"==typeof(this.showInvisibles=e)?(this.showSpaces=/tab/i.test(e),this.showTabs=/space/i.test(e),this.showEOL=/eol/i.test(e)):this.showSpaces=this.showTabs=this.showEOL=e,this.$computeTabString(),!0)},this.displayIndentGuides=!0,this.setDisplayIndentGuides=function(e){return this.displayIndentGuides!=e&&(this.displayIndentGuides=e,this.$computeTabString(),!0)},this.$tabStrings=[],this.onChangeTabSize=this.$computeTabString=function(){for(var e,t,i,s,n,h,a=this.session.getTabSize(),r=(this.tabSize=a,this.$tabStrings=[0]),o=1;o<a+1;o++)this.showTabs?((h=this.dom.createElement("span")).className="ace_invisible ace_invisible_tab",h.textContent=lang.stringRepeat(this.TAB_CHAR,o),r.push(h)):r.push(this.dom.createTextNode(lang.stringRepeat(" ",o),this.element));this.displayIndentGuides&&(this.$indentGuideRe=/\s\S| \t|\t |\s$/,e="ace_indent-guide",t=this.showSpaces?" ace_invisible ace_invisible_space":"",i=this.showSpaces?lang.stringRepeat(this.SPACE_CHAR,this.tabSize):lang.stringRepeat(" ",this.tabSize),s=this.showTabs?" ace_invisible ace_invisible_tab":"",n=this.showTabs?lang.stringRepeat(this.TAB_CHAR,this.tabSize):i,(h=this.dom.createElement("span")).className=e+t,h.textContent=i,this.$tabStrings[" "]=h,(h=this.dom.createElement("span")).className=e+s,h.textContent=n,this.$tabStrings["\t"]=h)},this.updateLines=function(e,t,i){if(this.config.lastRow!=e.lastRow||this.config.firstRow!=e.firstRow)return this.update(e);this.config=e;for(var s=Math.max(t,e.firstRow),n=Math.min(i,e.lastRow),h=this.element.childNodes,a=0,r=e.firstRow;r<s;r++){if(o=this.session.getFoldLine(r)){if(o.containsRow(s)){s=o.start.row;break}r=o.end.row}a++}for(var o,l=!1,r=s,u=(o=this.session.getNextFoldLine(r))?o.start.row:1/0;u<r&&(r=o.end.row+1,u=(o=this.session.getNextFoldLine(r,o))?o.start.row:1/0),!(n<r);){var d,c=h[a++];c&&(this.dom.removeChildren(c),this.$renderLine(c,r,r==u&&o),l&&(c.style.top=this.$lines.computeLineTop(r,e,this.session)+"px"),d=e.lineHeight*this.session.getRowLength(r)+"px",c.style.height!=d)&&(l=!0,c.style.height=d),r++}if(l)for(;a<this.$lines.cells.length;){var p=this.$lines.cells[a++];p.element.style.top=this.$lines.computeLineTop(p.row,e,this.session)+"px"}},this.scrollLines=function(e){var t=this.config;if(this.config=e,this.$lines.pageChanged(t,e))return this.update(e);this.$lines.moveContainer(e);var i=e.lastRow,s=t?t.lastRow:-1;if(!t||s<e.firstRow)return this.update(e);if(i<t.firstRow)return this.update(e);if(!t||t.lastRow<e.firstRow)return this.update(e);if(e.lastRow<t.firstRow)return this.update(e);if(t.firstRow<e.firstRow)for(var n=this.session.getFoldedRowCount(t.firstRow,e.firstRow-1);0<n;n--)this.$lines.shift();if(t.lastRow>e.lastRow)for(n=this.session.getFoldedRowCount(e.lastRow+1,t.lastRow);0<n;n--)this.$lines.pop();e.firstRow<t.firstRow&&this.$lines.unshift(this.$renderLinesFragment(e,e.firstRow,t.firstRow-1)),e.lastRow>t.lastRow&&this.$lines.push(this.$renderLinesFragment(e,t.lastRow+1,e.lastRow))},this.$renderLinesFragment=function(e,t,i){for(var s=[],n=t,h=this.session.getNextFoldLine(n),a=h?h.start.row:1/0;a<n&&(n=h.end.row+1,a=(h=this.session.getNextFoldLine(n,h))?h.start.row:1/0),!(i<n);){var r=this.$lines.createCell(n,e,this.session),o=r.element;this.dom.removeChildren(o),dom.setStyle(o.style,"height",this.$lines.computeLineHeight(n,e,this.session)+"px"),dom.setStyle(o.style,"top",this.$lines.computeLineTop(n,e,this.session)+"px"),this.$renderLine(o,n,n==a&&h),this.$useLineGroups()?o.className="ace_line_group":o.className="ace_line",s.push(r),n++}return s},this.update=function(e){this.$lines.moveContainer(e);for(var t=(this.config=e).firstRow,i=e.lastRow,s=this.$lines;s.getLength();)s.pop();s.push(this.$renderLinesFragment(e,t,i))},this.$textToken={text:!0,rparen:!0,lparen:!0},this.$renderToken=function(e,t,i,s){for(var n,h,a=this,r=/(\t)|( +)|([\x00-\x1f\x80-\xa0\xad\u1680\u180E\u2000-\u200f\u2028\u2029\u202F\u205F\uFEFF\uFFF9-\uFFFC\u2066\u2067\u2068\u202A\u202B\u202D\u202E\u202C\u2069]+)|(\u3000)|([\u1100-\u115F\u11A3-\u11A7\u11FA-\u11FF\u2329-\u232A\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u2FF0-\u2FFB\u3001-\u303E\u3041-\u3096\u3099-\u30FF\u3105-\u312D\u3131-\u318E\u3190-\u31BA\u31C0-\u31E3\u31F0-\u321E\u3220-\u3247\u3250-\u32FE\u3300-\u4DBF\u4E00-\uA48C\uA490-\uA4C6\uA960-\uA97C\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFAFF\uFE10-\uFE19\uFE30-\uFE52\uFE54-\uFE66\uFE68-\uFE6B\uFF01-\uFF60\uFFE0-\uFFE6]|[\uD800-\uDBFF][\uDC00-\uDFFF])/g,o=this.dom.createFragment(this.element),l=0;n=r.exec(s);){var u,d,c=n[1],p=n[2],g=n[3],f=n[4],m=n[5];!a.showSpaces&&p||(u=l!=n.index?s.slice(l,n.index):"",l=n.index+n[0].length,u&&o.appendChild(this.dom.createTextNode(u,this.element)),c?(u=a.session.getScreenTabSize(t+n.index),o.appendChild(a.$tabStrings[u].cloneNode(!0)),t+=u-1):p?a.showSpaces?((d=this.dom.createElement("span")).className="ace_invisible ace_invisible_space",d.textContent=lang.stringRepeat(a.SPACE_CHAR,p.length),o.appendChild(d)):o.appendChild(this.com.createTextNode(p,this.element)):g?((d=this.dom.createElement("span")).className="ace_invisible ace_invisible_space ace_invalid",d.textContent=lang.stringRepeat(a.SPACE_CHAR,g.length),o.appendChild(d)):f?(t+=1,(d=this.dom.createElement("span")).style.width=2*a.config.characterWidth+"px",d.className=a.showSpaces?"ace_cjk ace_invisible ace_invisible_space":"ace_cjk",d.textContent=a.showSpaces?a.SPACE_CHAR:f,o.appendChild(d)):m&&(t+=1,(d=this.dom.createElement("span")).style.width=2*a.config.characterWidth+"px",d.className="ace_cjk",d.textContent=m,o.appendChild(d)))}return o.appendChild(this.dom.createTextNode(l?s.slice(l):s,this.element)),this.$textToken[i.type]?e.appendChild(o):(h="ace_"+i.type.replace(/\./g," ace_"),d=this.dom.createElement("span"),"fold"==i.type&&(d.style.width=i.value.length*this.config.characterWidth+"px"),d.className=h,d.appendChild(o),e.appendChild(d)),t+s.length},this.renderIndentGuide=function(e,t,i){var s=t.search(this.$indentGuideRe);if(s<=0||i<=s)return t;if(" "==t[0])for(var n=(s-=s%this.tabSize)/this.tabSize,h=0;h<n;h++)e.appendChild(this.$tabStrings[" "].cloneNode(!0));else{if("\t"!=t[0])return t;for(h=0;h<s;h++)e.appendChild(this.$tabStrings["\t"].cloneNode(!0))}return t.substr(s)},this.$createLineElement=function(e){var t=this.dom.createElement("div");return t.className="ace_line",t.style.height=this.config.lineHeight+"px",t},this.$renderWrappedLine=function(e,t,i){var s=0,n=0,h=i[0],a=0,r=this.$createLineElement();e.appendChild(r);for(var o=0;o<t.length;o++){var l=t[o],u=l.value;if(0==o&&this.displayIndentGuides){if(s=u.length,!(u=this.renderIndentGuide(r,u,h)))continue;s-=u.length}if(s+u.length<h)a=this.$renderToken(r,a,l,u),s+=u.length;else{for(;s+u.length>=h;)a=this.$renderToken(r,a,l,u.substring(0,h-s)),u=u.substring(h-s),s=h,r=this.$createLineElement(),e.appendChild(r),r.appendChild(this.dom.createTextNode(lang.stringRepeat(" ",i.indent),this.element)),a=0,h=i[++n]||Number.MAX_VALUE;0!=u.length&&(s+=u.length,a=this.$renderToken(r,a,l,u))}}i[i.length-1]>this.MAX_LINE_LENGTH&&this.$renderOverflowMessage(r,a,null,"",!0)},this.$renderSimpleLine=function(e,t){for(var i=0,s=0;s<t.length;s++){var n=t[s],h=n.value;if(0!=s||!this.displayIndentGuides||(h=this.renderIndentGuide(e,h))){if(i+h.length>this.MAX_LINE_LENGTH)return this.$renderOverflowMessage(e,i,n,h);i=this.$renderToken(e,i,n,h)}}},this.$renderOverflowMessage=function(e,t,i,s,n){i&&this.$renderToken(e,t,i,s.slice(0,this.MAX_LINE_LENGTH-t));i=this.dom.createElement("span");i.className="ace_inline_button ace_keyword ace_toggle_wrap",i.textContent=n?"<hide>":"<click to see more...>",e.appendChild(i)},this.$renderLine=function(e,t,i){var s,n,h=e;(s=(i=i||0==i?i:this.session.getFoldLine(t))?this.$getFoldLineTokens(t,i):this.session.getTokens(t)).length?(n=this.session.getRowSplitData(t))&&n.length?(this.$renderWrappedLine(e,s,n),h=e.lastChild):(h=e,this.$useLineGroups()&&(h=this.$createLineElement(),e.appendChild(h)),this.$renderSimpleLine(h,s)):this.$useLineGroups()&&(h=this.$createLineElement(),e.appendChild(h)),this.showEOL&&h&&(i&&(t=i.end.row),(n=this.dom.createElement("span")).className="ace_invisible ace_invisible_eol",n.textContent=t==this.session.getLength()-1?this.EOF_CHAR:this.EOL_CHAR,h.appendChild(n))},this.$getFoldLineTokens=function(e,t){var d=this.session,c=[];var p=d.getTokens(e);return t.walk(function(e,t,i,s,n){if(null!=e)c.push({type:"fold",value:e});else if((p=n?d.getTokens(t):p).length){for(var h,a=p,r=s,o=i,l=0,u=0;u+a[l].value.length<r;)if(u+=a[l].value.length,++l==a.length)return void!void 0;for(u!=r&&((h=a[l].value.substring(r-u)).length>o-r&&(h=h.substring(0,o-r)),c.push({type:a[l].type,value:h}),u=r+h.length,l+=1);u<o&&l<a.length;)(h=a[l].value).length+u>o?c.push({type:a[l].type,value:h.substring(0,o-u)}):c.push(a[l]),u+=h.length,l+=1}},t.end.row,this.session.getLine(t.end.row).length),c},this.$useLineGroups=function(){return this.session.getUseWrapMode()},this.destroy=function(){}}.call(Text.prototype),exports.Text=Text;