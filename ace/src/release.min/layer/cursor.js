"use strict";var dom=require("../lib/dom"),Cursor=function(s){this.element=dom.createElement("div"),this.element.className="ace_layer ace_cursor-layer",s.appendChild(this.element),this.isVisible=!1,this.isBlinking=!0,this.blinkInterval=1e3,this.smoothBlinking=!1,this.cursors=[],this.cursor=this.addCursor(),dom.addCssClass(this.element,"ace_hidden-cursors"),this.$updateCursors=this.$updateOpacity.bind(this)};!function(){this.$updateOpacity=function(s){for(var i=this.cursors,t=i.length;t--;)dom.setStyle(i[t].style,"opacity",s?"":"0")},this.$startCssAnimation=function(){for(var s=this.cursors,i=s.length;i--;)s[i].style.animationDuration=this.blinkInterval+"ms";this.$isAnimating=!0,setTimeout(function(){this.$isAnimating&&dom.addCssClass(this.element,"ace_animate-blinking")}.bind(this))},this.$stopCssAnimation=function(){this.$isAnimating=!1,dom.removeCssClass(this.element,"ace_animate-blinking")},this.$padding=0,this.setPadding=function(s){this.$padding=s},this.setSession=function(s){this.session=s},this.setBlinking=function(s){s!=this.isBlinking&&(this.isBlinking=s,this.restartTimer())},this.setBlinkInterval=function(s){s!=this.blinkInterval&&(this.blinkInterval=s,this.restartTimer())},this.setSmoothBlinking=function(s){s!=this.smoothBlinking&&(this.smoothBlinking=s,dom.setCssClass(this.element,"ace_smooth-blinking",s),this.$updateCursors(!0),this.restartTimer())},this.addCursor=function(){var s=dom.createElement("div");return s.className="ace_cursor",this.element.appendChild(s),this.cursors.push(s),s},this.removeCursor=function(){var s;if(1<this.cursors.length)return(s=this.cursors.pop()).parentNode.removeChild(s),s},this.hideCursor=function(){this.isVisible=!1,dom.addCssClass(this.element,"ace_hidden-cursors"),this.restartTimer()},this.showCursor=function(){this.isVisible=!0,dom.removeCssClass(this.element,"ace_hidden-cursors"),this.restartTimer()},this.restartTimer=function(){var s,i=this.$updateCursors;clearInterval(this.intervalId),clearTimeout(this.timeoutId),this.$stopCssAnimation(),this.smoothBlinking&&(this.$isSmoothBlinking=!1,dom.removeCssClass(this.element,"ace_smooth-blinking")),i(!0),this.isBlinking&&this.blinkInterval&&this.isVisible?(this.smoothBlinking&&(this.$isSmoothBlinking=!0,setTimeout(function(){this.$isSmoothBlinking&&dom.addCssClass(this.element,"ace_smooth-blinking")}.bind(this))),dom.HAS_CSS_ANIMATION?this.$startCssAnimation():(s=function(){this.timeoutId=setTimeout(function(){i(!1)},.6*this.blinkInterval)}.bind(this),this.intervalId=setInterval(function(){i(!0),s()},this.blinkInterval),s())):this.$stopCssAnimation()},this.getPixelPosition=function(s,i){if(!this.config||!this.session)return{left:0,top:0};s=s||this.session.selection.getCursor();var t=this.session.documentToScreenPosition(s);return{left:this.$padding+(this.session.$bidiHandler.isBidiRow(t.row,s.row)?this.session.$bidiHandler.getPosLeft(t.column):t.column*this.config.characterWidth),top:(t.row-(i?this.config.firstRowScreen:0))*this.config.lineHeight}},this.isCursorInView=function(s,i){return 0<=s.top&&s.top<i.maxHeight},this.update=function(s){this.config=s;for(var i=this.session.$selectionMarkers,t=0,e=0,t=0,n=(i=void 0!==i&&0!==i.length?i:[{cursor:null}]).length;t<n;t++){var o,r,h=this.getPixelPosition(i[t].cursor,!0);(h.top>s.height+s.offset||h.top<0)&&1<t||(r=(o=this.cursors[e++]||this.addCursor()).style,this.drawCursor?this.drawCursor(o,h,s,i[t],this.session):this.isCursorInView(h,s)?(dom.setStyle(r,"display","block"),dom.translate(o,h.left,h.top),dom.setStyle(r,"width",Math.round(s.characterWidth)+"px"),dom.setStyle(r,"height",s.lineHeight+"px")):dom.setStyle(r,"display","none"))}for(;this.cursors.length>e;)this.removeCursor();var a=this.session.getOverwrite();this.$setOverwrite(a),this.$pixelPos=h,this.restartTimer()},this.drawCursor=null,this.$setOverwrite=function(s){s!=this.overwrite&&((this.overwrite=s)?dom.addCssClass(this.element,"ace_overwrite-cursors"):dom.removeCssClass(this.element,"ace_overwrite-cursors"))},this.destroy=function(){clearInterval(this.intervalId),clearTimeout(this.timeoutId)}}.call(Cursor.prototype),exports.Cursor=Cursor;