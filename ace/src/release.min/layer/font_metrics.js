var oop=require("../lib/oop"),dom=require("../lib/dom"),lang=require("../lib/lang"),event=require("../lib/event"),useragent=require("../lib/useragent"),EventEmitter=require("../lib/event_emitter").EventEmitter,CHAR_COUNT=256,USE_OBSERVER="function"==typeof ResizeObserver,L=200,FontMetrics=exports.FontMetrics=function(e){this.el=dom.createElement("div"),this.$setMeasureNodeStyles(this.el.style,!0),this.$main=dom.createElement("div"),this.$setMeasureNodeStyles(this.$main.style),this.$measureNode=dom.createElement("div"),this.$setMeasureNodeStyles(this.$measureNode.style),this.el.appendChild(this.$main),this.el.appendChild(this.$measureNode),e.appendChild(this.el),this.$measureNode.textContent=lang.stringRepeat("X",CHAR_COUNT),this.$characterSize={width:0,height:0},USE_OBSERVER?this.$addObserver():this.checkForSizeChanges()};!function(){oop.implement(this,EventEmitter),this.$characterSize={width:0,height:0},this.$setMeasureNodeStyles=function(e,t){e.width=e.height="auto",e.left=e.top="0px",e.visibility="hidden",e.position="absolute",e.whiteSpace="pre",useragent.isIE<8?e["font-family"]="inherit":e.font="inherit",e.overflow=t?"hidden":"visible"},this.checkForSizeChanges=function(e){var t;!(e=void 0===e?this.$measureSizes():e)||this.$characterSize.width===e.width&&this.$characterSize.height===e.height||(this.$measureNode.style.fontWeight="bold",t=this.$measureSizes(),this.$measureNode.style.fontWeight="",this.$characterSize=e,this.charSizes=Object.create(null),this.allowBoldFonts=t&&t.width===e.width&&t.height===e.height,this._emit("changeCharacterSize",{data:e}))},this.$addObserver=function(){var t=this;this.$observer=new window.ResizeObserver(function(e){t.checkForSizeChanges()}),this.$observer.observe(this.$measureNode)},this.$pollSizeChanges=function(){var t;return this.$pollSizeChangesTimer||this.$observer?this.$pollSizeChangesTimer:(t=this).$pollSizeChangesTimer=event.onIdle(function e(){t.checkForSizeChanges(),event.onIdle(e,500)},500)},this.setPolling=function(e){e?this.$pollSizeChanges():this.$pollSizeChangesTimer&&(clearInterval(this.$pollSizeChangesTimer),this.$pollSizeChangesTimer=0)},this.$measureSizes=function(e){e={height:(e||this.$measureNode).clientHeight,width:(e||this.$measureNode).clientWidth/CHAR_COUNT};return 0===e.width||0===e.height?null:e},this.$measureCharWidth=function(e){return this.$main.textContent=lang.stringRepeat(e,CHAR_COUNT),this.$main.getBoundingClientRect().width/CHAR_COUNT},this.getCharacterWidth=function(e){var t=this.charSizes[e];return t=void 0===t?this.charSizes[e]=this.$measureCharWidth(e)/this.$characterSize.width:t},this.destroy=function(){clearInterval(this.$pollSizeChangesTimer),this.$observer&&this.$observer.disconnect(),this.el&&this.el.parentNode&&this.el.parentNode.removeChild(this.el)},this.$getZoom=function e(t){return t&&t.parentElement?(window.getComputedStyle(t).zoom||1)*e(t.parentElement):1},this.$initTransformMeasureNodes=function(){function e(e,t){return["div",{style:"position: absolute;top:"+e+"px;left:"+t+"px;"}]}this.els=dom.buildDom([e(0,0),e(L,0),e(0,L),e(L,L)],this.el)},this.transformCoordinates=function(e,t){function i(e,t,i){var s=e[1]*t[0]-e[0]*t[1];return[(-t[1]*i[0]+t[0]*i[1])/s,(+e[1]*i[0]-e[0]*i[1])/s]}function s(e,t){return[e[0]-t[0],e[1]-t[1]]}function h(e,t){return[e[0]+t[0],e[1]+t[1]]}function r(e,t){return[e*t[0],e*t[1]]}function n(e){e=e.getBoundingClientRect();return[e.left,e.top]}e=e&&r(1/this.$getZoom(this.el),e),this.els||this.$initTransformMeasureNodes();var o,a=n(this.els[0]),l=n(this.els[1]),d=n(this.els[2]),u=n(this.els[3]),u=i(s(u,l),s(u,d),s(h(l,d),h(u,a))),l=r(1+u[0],s(l,a)),d=r(1+u[1],s(d,a));return t?(o=u[0]*t[0]/L+u[1]*t[1]/L+1,t=h(r(t[0],l),r(t[1],d)),h(r(1/o/L,t),a)):(o=s(e,a),t=i(s(l,r(u[0],o)),s(d,r(u[1],o)),o),r(L,t))}}.call(FontMetrics.prototype);