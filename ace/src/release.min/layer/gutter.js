"use strict";var dom=require("../lib/dom"),oop=require("../lib/oop"),lang=require("../lib/lang"),EventEmitter=require("../lib/event_emitter").EventEmitter,Lines=require("./lines").Lines,Gutter=function(t){this.element=dom.createElement("div"),this.element.className="ace_layer ace_gutter-layer",t.appendChild(this.element),this.setShowFoldWidgets(this.$showFoldWidgets),this.gutterWidth=0,this.$annotations=[],this.$updateAnnotations=this.$updateAnnotations.bind(this),this.$lines=new Lines(this.element),this.$lines.$offsetCoefficient=1};function onCreateCell(t){var e=document.createTextNode(""),e=(t.appendChild(e),dom.createElement("span"));return t.appendChild(e),t}!function(){oop.implement(this,EventEmitter),this.setSession=function(t){this.session&&this.session.off("change",this.$updateAnnotations),(this.session=t)&&t.on("change",this.$updateAnnotations)},this.addGutterDecoration=function(t,e){window.console&&console.warn&&console.warn("deprecated use session.addGutterDecoration"),this.session.addGutterDecoration(t,e)},this.removeGutterDecoration=function(t,e){window.console&&console.warn&&console.warn("deprecated use session.removeGutterDecoration"),this.session.removeGutterDecoration(t,e)},this.setAnnotations=function(t){this.$annotations=[];for(var e=0;e<t.length;e++){var s=t[e],i=s.row,n=(n=this.$annotations[i])||(this.$annotations[i]={text:[]}),i=(i=s.text)?lang.escapeHTML(i):s.html||"",i=(-1===n.text.indexOf(i)&&n.text.push(i),s.type),s=s.className;s?n.className=s:"error"==i?n.className=" ace_error":"warning"==i&&" ace_error"!=n.className?n.className=" ace_warning":"info"!=i||n.className||(n.className=" ace_info")}},this.$updateAnnotations=function(t){var e,s;this.$annotations.length&&(e=t.start.row,0!=(s=t.end.row-e))&&("remove"==t.action?this.$annotations.splice(e,1+s,null):((t=new Array(1+s)).unshift(e,1),this.$annotations.splice.apply(this.$annotations,t)))},this.update=function(t){this.config=t;for(var e=this.session,s=t.firstRow,i=Math.min(t.lastRow+t.gutterOffset,e.getLength()-1),n=(this.oldLastRow=i,this.config=t,this.$lines.moveContainer(t),this.$updateCursorRow(),e.getNextFoldLine(s)),r=n?n.start.row:1/0,o=null,h=-1,a=s;;){if(r<a&&(a=n.end.row+1,r=(n=e.getNextFoldLine(a,n))?n.start.row:1/0),i<a){for(;this.$lines.getLength()>h+1;)this.$lines.pop();break}(o=this.$lines.get(++h))?o.row=a:(o=this.$lines.createCell(a,t,this.session,onCreateCell),this.$lines.push(o)),this.$renderCell(o,t,n,a),a++}this._signal("afterRender"),this.$updateGutterWidth(t)},this.$updateGutterWidth=function(t){var e=this.session,s=e.gutterRenderer||this.$renderer,i=e.$firstLineNumber,n=this.$lines.last()?this.$lines.last().text:"",i=((this.$fixedWidth||e.$useWrapMode)&&(n=e.getLength()+i-1),s?s.getWidth(e,n,t):n.toString().length*t.characterWidth),s=this.$padding||this.$computePadding();(i+=s.left+s.right)===this.gutterWidth||isNaN(i)||(this.gutterWidth=i,this.element.parentNode.style.width=this.element.style.width=Math.ceil(this.gutterWidth)+"px",this._signal("changeGutterWidth",i))},this.$updateCursorRow=function(){var t;this.$highlightGutterLine&&(t=this.session.selection.getCursor(),this.$cursorRow!==t.row)&&(this.$cursorRow=t.row)},this.updateLineHighlight=function(){if(this.$highlightGutterLine){var t=this.session.selection.cursor.row;if(this.$cursorRow=t,!this.$cursorCell||this.$cursorCell.row!=t){this.$cursorCell&&(this.$cursorCell.element.className=this.$cursorCell.element.className.replace("ace_gutter-active-line ",""));var e=this.$lines.cells;this.$cursorCell=null;for(var s=0;s<e.length;s++){var i=e[s];if(i.row>=this.$cursorRow){if(i.row>this.$cursorRow){var n=this.session.getFoldLine(this.$cursorRow);if(!(0<s&&n&&n.start.row==e[s-1].row))break;i=e[s-1]}i.element.className="ace_gutter-active-line "+i.element.className,this.$cursorCell=i;break}}}}},this.scrollLines=function(t){var e=this.config;if(this.config=t,this.$updateCursorRow(),this.$lines.pageChanged(e,t))return this.update(t);this.$lines.moveContainer(t);var s=Math.min(t.lastRow+t.gutterOffset,this.session.getLength()-1),i=this.oldLastRow;if(this.oldLastRow=s,!e||i<t.firstRow)return this.update(t);if(s<e.firstRow)return this.update(t);if(e.firstRow<t.firstRow)for(var n=this.session.getFoldedRowCount(e.firstRow,t.firstRow-1);0<n;n--)this.$lines.shift();if(s<i)for(n=this.session.getFoldedRowCount(s+1,i);0<n;n--)this.$lines.pop();t.firstRow<e.firstRow&&this.$lines.unshift(this.$renderLines(t,t.firstRow,e.firstRow-1)),i<s&&this.$lines.push(this.$renderLines(t,i+1,s)),this.updateLineHighlight(),this._signal("afterRender"),this.$updateGutterWidth(t)},this.$renderLines=function(t,e,s){for(var i=[],n=e,r=this.session.getNextFoldLine(n),o=r?r.start.row:1/0;o<n&&(n=r.end.row+1,o=(r=this.session.getNextFoldLine(n,r))?r.start.row:1/0),!(s<n);){var h=this.$lines.createCell(n,t,this.session,onCreateCell);this.$renderCell(h,t,r,n),i.push(h),n++}return i},this.$renderCell=function(t,e,s,i){var n,r=t.element,o=this.session,h=r.childNodes[0],a=r.childNodes[1],l=o.$firstLineNumber,d=o.$breakpoints,u=o.$decorations,c=o.gutterRenderer||this.$renderer,g=this.$showFoldWidgets&&o.foldWidgets,$=s?s.start.row:Number.MAX_VALUE,f="ace_gutter-cell ",u=(this.$highlightGutterLine&&(i==this.$cursorRow||s&&i<this.$cursorRow&&$<=i&&this.$cursorRow<=s.end.row)&&(f+="ace_gutter-active-line ",this.$cursorCell!=t)&&(this.$cursorCell&&(this.$cursorCell.element.className=this.$cursorCell.element.className.replace("ace_gutter-active-line ","")),this.$cursorCell=t),d[i]&&(f+=d[i]),u[i]&&(f+=u[i]),this.$annotations[i]&&(f+=this.$annotations[i].className),r.className!=f&&(r.className=f),(n=g&&null==(n=g[i])?g[i]=o.getFoldWidget(i):n)?(f="ace_fold-widget ace_"+n,"start"==n&&i==$&&i<s.end.row?f+=" ace_closed":f+=" ace_open",a.className!=f&&(a.className=f),d=e.lineHeight+"px",dom.setStyle(a.style,"height",d),dom.setStyle(a.style,"display","inline-block")):a&&dom.setStyle(a.style,"display","none"),(c?c.getText(o,i):i+l).toString());return u!==h.data&&(h.data=u),dom.setStyle(t.element.style,"height",this.$lines.computeLineHeight(i,e,o)+"px"),dom.setStyle(t.element.style,"top",this.$lines.computeLineTop(i,e,o)+"px"),t.text=u,t},this.$fixedWidth=!1,this.$highlightGutterLine=!0,this.$renderer="",this.setHighlightGutterLine=function(t){this.$highlightGutterLine=t},this.$showLineNumbers=!0,this.$renderer="",this.setShowLineNumbers=function(t){this.$renderer=!t&&{getWidth:function(){return 0},getText:function(){return""}}},this.getShowLineNumbers=function(){return this.$showLineNumbers},this.$showFoldWidgets=!0,this.setShowFoldWidgets=function(t){t?dom.addCssClass(this.element,"ace_folding-enabled"):dom.removeCssClass(this.element,"ace_folding-enabled"),this.$showFoldWidgets=t,this.$padding=null},this.getShowFoldWidgets=function(){return this.$showFoldWidgets},this.$computePadding=function(){var t;return this.element.firstChild?(t=dom.computedStyle(this.element.firstChild),this.$padding={},this.$padding.left=(parseInt(t.borderLeftWidth)||0)+(parseInt(t.paddingLeft)||0)+1,this.$padding.right=(parseInt(t.borderRightWidth)||0)+(parseInt(t.paddingRight)||0),this.$padding):{left:0,right:0}},this.getRegion=function(t){var e=this.$padding||this.$computePadding(),s=this.element.getBoundingClientRect();return t.x<e.left+s.left?"markers":this.$showFoldWidgets&&t.x>s.right-e.right?"foldWidgets":void 0}}.call(Gutter.prototype),exports.Gutter=Gutter;