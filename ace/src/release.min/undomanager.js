"use strict";var UndoManager=function(){this.$maxRev=0,this.$fromUndo=!1,this.$undoDepth=1/0,this.reset()};function rearrangeUndoStack(t,s){for(var n=s;n--;){var e=t[n];if(e&&!e[0].ignore){for(;n<s-1;){var i=swapGroups(t[n],t[n+1]);t[n]=i[0],t[n+1]=i[1],n++}return!0}}}!function(){this.addSession=function(t){this.$session=t},this.add=function(t,s,n){this.$fromUndo||t!=this.$lastDelta&&(this.$keepRedoStack||(this.$redoStack.length=0),!1!==s&&this.lastDeltas||(this.lastDeltas=[],(s=this.$undoStack.length)>this.$undoDepth-1&&this.$undoStack.splice(0,s-this.$undoDepth+1),this.$undoStack.push(this.lastDeltas),t.id=this.$rev=++this.$maxRev),"remove"!=t.action&&"insert"!=t.action||(this.$lastDelta=t),this.lastDeltas.push(t))},this.addSelection=function(t,s){this.selections.push({value:t,rev:s||this.$rev})},this.startNewGroup=function(){return this.lastDeltas=null,this.$rev},this.markIgnored=function(t,s){null==s&&(s=this.$rev+1);for(var n=this.$undoStack,e=n.length;e--;){var i=n[e][0];if(i.id<=t)break;i.id<s&&(i.ignore=!0)}this.lastDeltas=null},this.getSelection=function(t,s){for(var n=this.selections,e=n.length;e--;){var i=n[e];if(i.rev<t)return i=s?n[e+1]:i}},this.getRevision=function(){return this.$rev},this.getDeltas=function(t,s){null==s&&(s=this.$rev+1);for(var n=this.$undoStack,e=null,i=0,r=n.length;r--;){var a=n[r][0];if(a.id<s&&!e&&(e=r+1),a.id<=t){i=r+1;break}}return n.slice(i,e)},this.getChangedRanges=function(t,s){null==s&&this.$rev},this.getChangedLines=function(t,s){null==s&&this.$rev},this.undo=function(t,s){this.lastDeltas=null;var n,e=this.$undoStack;if(rearrangeUndoStack(e,e.length))return t=t||this.$session,this.$redoStackBaseRev!==this.$rev&&this.$redoStack.length&&(this.$redoStack=[]),this.$fromUndo=!0,n=null,(e=e.pop())&&(n=t.undoChanges(e,s),this.$redoStack.push(e),this.$syncRev()),this.$fromUndo=!1,n},this.redo=function(t,s){this.lastDeltas=null,t=t||this.$session,this.$fromUndo=!0,this.$redoStackBaseRev!=this.$rev&&(n=this.getDeltas(this.$redoStackBaseRev,this.$rev+1),rebaseRedoStack(this.$redoStack,n),this.$redoStackBaseRev=this.$rev,this.$redoStack.forEach(function(t){t[0].id=++this.$maxRev},this));var n=this.$redoStack.pop(),e=null;return n&&(e=t.redoChanges(n,s),this.$undoStack.push(n),this.$syncRev()),this.$fromUndo=!1,e},this.$syncRev=function(){var t=this.$undoStack,t=t[t.length-1],t=t&&t[0].id||0;this.$redoStackBaseRev=t,this.$rev=t},this.reset=function(){this.lastDeltas=null,this.$lastDelta=null,this.$undoStack=[],this.$redoStack=[],this.$rev=0,this.mark=0,this.$redoStackBaseRev=this.$rev,this.selections=[]},this.canUndo=function(){return 0<this.$undoStack.length},this.canRedo=function(){return 0<this.$redoStack.length},this.bookmark=function(t){null==t&&(t=this.$rev),this.mark=t},this.isAtBookmark=function(){return this.$rev===this.mark},this.toJSON=function(){},this.fromJSON=function(){},this.hasUndo=this.canUndo,this.hasRedo=this.canRedo,this.isClean=this.isAtBookmark,this.markClean=this.bookmark,this.$prettyPrint=function(t){return t?stringifyDelta(t):stringifyDelta(this.$undoStack)+"\n---\n"+stringifyDelta(this.$redoStack)}}.call(UndoManager.prototype);var Range=require("./range").Range,cmp=Range.comparePoints,comparePoints=Range.comparePoints;function $updateMarkers(t){var s,n="insert"==t.action,e=t.start,i=t.end,r=(i.row-e.row)*(n?1:-1),a=(i.column-e.column)*(n?1:-1);for(s in n&&(i=e),this.marks){var o=this.marks[s],h=comparePoints(o,e);if(!(h<0)){if(0===h&&n){if(1!=o.bias){o.bias;continue}h=1}h=n?h:comparePoints(o,i);0<h?(o.row+=r,o.column+=o.row==i.row?a:0):!n&&h<=0&&(o.row=e.row,o.column=e.column,0===h)&&(o.bias=1)}}}function clonePos(t){return{row:t.row,column:t.column}}function cloneDelta(t){return{start:clonePos(t.start),end:clonePos(t.end),action:t.action,lines:t.lines.slice()}}function stringifyDelta(t){var s;return t=t||this,Array.isArray(t)?t.map(stringifyDelta).join("\n"):(s="",t.action?(s="insert"==t.action?"+":"-",s+="["+t.lines+"]"):t.value&&(s=Array.isArray(t.value)?t.value.map(stringifyRange).join("\n"):stringifyRange(t.value)),t.start&&(s+=stringifyRange(t)),(t.id||t.rev)&&(s+="\t("+(t.id||t.rev)+")"),s)}function stringifyRange(t){return t.start.row+":"+t.start.column+"=>"+t.end.row+":"+t.end.column}function swap(t,s){var n="insert"==t.action,e="insert"==s.action;if(n&&e)if(0<=cmp(s.start,t.end))shift(s,t,-1);else{if(!(cmp(s.start,t.start)<=0))return null;shift(t,s,1)}else if(n&&!e)if(0<=cmp(s.start,t.end))shift(s,t,-1);else{if(!(cmp(s.end,t.start)<=0))return null;shift(t,s,-1)}else if(!n&&e)if(0<=cmp(s.start,t.start))shift(s,t,1);else{if(!(cmp(s.start,t.start)<=0))return null;shift(t,s,1)}else if(!n&&!e)if(0<=cmp(s.start,t.start))shift(s,t,1);else{if(!(cmp(s.end,t.start)<=0))return null;shift(t,s,-1)}return[s,t]}function swapGroups(t,s){for(var n=t.length;n--;)for(var e=0;e<s.length;e++)if(!swap(t[n],s[e])){for(;n<t.length;){for(;e--;)swap(s[e],t[n]);e=s.length,n++}return[t,s]}return t.selectionBefore=s.selectionBefore=t.selectionAfter=s.selectionAfter=null,[s,t]}function xform(t,s){var n,e,i="insert"==t.action,r="insert"==s.action;if(i&&r)cmp(t.start,s.start)<0?shift(s,t,1):shift(t,s,1);else if(i&&!r)0<=cmp(t.start,s.end)?shift(t,s,-1):(cmp(t.start,s.start)<=0||shift(t,Range.fromPoints(s.start,t.start),-1),shift(s,t,1));else if(!i&&r)0<=cmp(s.start,t.end)?shift(s,t,-1):(cmp(s.start,t.start)<=0||shift(s,Range.fromPoints(t.start,s.start),-1),shift(t,s,1));else if(!i&&!r)if(0<=cmp(s.start,t.end))shift(s,t,-1);else{if(!(cmp(s.end,t.start)<=0))return cmp(t.start,s.start)<0&&(t=splitDelta(n=t,s.start)),0<cmp(t.end,s.end)&&(e=splitDelta(t,s.end)),shiftPos(s.end,t.start,t.end,-1),e&&!n&&(t.lines=e.lines,t.start=e.start,t.end=e.end,e=t),[s,n,e].filter(Boolean);shift(t,s,-1)}return[s,t]}function shift(t,s,n){shiftPos(t.start,s.start,s.end,n),shiftPos(t.end,s.start,s.end,n)}function shiftPos(t,s,n,e){t.row==(1==e?s:n).row&&(t.column+=e*(n.column-s.column)),t.row+=e*(n.row-s.row)}function splitDelta(t,s){var n=t.lines,e=t.end,i=(t.end=clonePos(s),t.end.row-t.start.row),r=n.splice(i,n.length),i=i?s.column:s.column-t.start.column;return n.push(r[0].substring(0,i)),r[0]=r[0].substr(i),{start:clonePos(s),end:e,lines:r,action:t.action}}function moveDeltasByOne(t,s){s=cloneDelta(s);for(var n=t.length;n--;){for(var e=t[n],i=0;i<e.length;i++){var r=xform(e[i],s);s=r[0],2!=r.length&&(r[2]?(e.splice(i+1,1,r[1],r[2]),i++):r[1]||(e.splice(i,1),i--))}e.length||t.splice(n,1)}return t}function rebaseRedoStack(t,s){for(var n=0;n<s.length;n++)for(var e=s[n],i=0;i<e.length;i++)moveDeltasByOne(t,e[i])}exports.UndoManager=UndoManager;