"use strict";var event=require("../lib/event"),useragent=require("../lib/useragent"),DefaultHandlers=require("./default_handlers").DefaultHandlers,DefaultGutterHandler=require("./default_gutter_handler").GutterHandler,MouseEvent=require("./mouse_event").MouseEvent,DragdropHandler=require("./dragdrop_handler").DragdropHandler,addTouchListeners=require("./touch_handler").addTouchListeners,config=require("../config"),MouseHandler=function(s){function e(e){document.hasFocus&&document.hasFocus()&&(s.isFocused()||document.activeElement!=(s.textInput&&s.textInput.getElement()))||window.focus(),s.focus(),setTimeout(function(){s.isFocused()||s.focus()})}var o=this,t=(this.editor=s,new DefaultHandlers(this),new DefaultGutterHandler(this),new DragdropHandler(this),s.renderer.getMouseEventTarget()),n=(event.addListener(t,"click",this.onMouseEvent.bind(this,"click"),s),event.addListener(t,"mousemove",this.onMouseMove.bind(this,"mousemove"),s),event.addMultiMouseDownListener([t,s.renderer.scrollBarV&&s.renderer.scrollBarV.inner,s.renderer.scrollBarH&&s.renderer.scrollBarH.inner,s.textInput&&s.textInput.getElement()].filter(Boolean),[400,300,250],this,"onMouseEvent",s),event.addMouseWheelListener(s.container,this.onMouseWheel.bind(this,"mousewheel"),s),addTouchListeners(s.container,s),s.renderer.$gutter);event.addListener(n,"mousedown",this.onMouseEvent.bind(this,"guttermousedown"),s),event.addListener(n,"click",this.onMouseEvent.bind(this,"gutterclick"),s),event.addListener(n,"dblclick",this.onMouseEvent.bind(this,"gutterdblclick"),s),event.addListener(n,"mousemove",this.onMouseEvent.bind(this,"guttermousemove"),s),event.addListener(t,"mousedown",e,s),event.addListener(n,"mousedown",e,s),useragent.isIE&&s.renderer.scrollBarV&&(event.addListener(s.renderer.scrollBarV.element,"mousedown",e,s),event.addListener(s.renderer.scrollBarH.element,"mousedown",e,s)),s.on("mousemove",function(e){var t,n;o.state||o.$dragDelay||!o.$dragEnabled||(e=s.renderer.screenToTextCoordinates(e.x,e.y),t=s.session.selection.getRange(),n=s.renderer,!t.isEmpty()&&t.insideStart(e.row,e.column)?n.setCursorStyle("default"):n.setCursorStyle(""))},s)};!function(){this.onMouseEvent=function(e,t){this.editor.session&&this.editor._emit(e,new MouseEvent(t,this.editor))},this.onMouseMove=function(e,t){var n=this.editor._eventRegistry&&this.editor._eventRegistry.mousemove;n&&n.length&&this.editor._emit(e,new MouseEvent(t,this.editor))},this.onMouseWheel=function(e,t){var n=new MouseEvent(t,this.editor);n.speed=2*this.$scrollSpeed,n.wheelX=t.wheelX,n.wheelY=t.wheelY,this.editor._emit(e,n)},this.setState=function(e){this.state=e},this.captureMouse=function(e,t){this.x=e.x,this.y=e.y,this.isMousePressed=!0;function n(e){if(e){if(useragent.isWebKit&&!e.which&&u.releaseMouse)return u.releaseMouse();u.x=e.clientX,u.y=e.clientY,t&&t(e),u.mouseEvent=new MouseEvent(e,u.editor),u.$mouseMoved=!0}}function s(e){r.off("beforeEndOperation",d),clearInterval(a),r.session&&o(),u[u.state+"End"]&&u[u.state+"End"](e),u.state="",u.isMousePressed=i.$isMousePressed=!1,i.$keepTextAreaAtCursor&&i.$moveTextAreaToCursor(),u.$onCaptureMouseMove=u.releaseMouse=null,e&&u.onMouseEvent("mouseup",e),r.endOperation()}function o(){u[u.state]&&u[u.state](),u.$mouseMoved=!1}var r=this.editor,i=this.editor.renderer,u=(i.$isMousePressed=!0,this);if(useragent.isOldIE&&"dblclick"==e.domEvent.type)return setTimeout(function(){s(e)});var d=function(e){u.releaseMouse&&r.curOp.command.name&&r.curOp.selectionChanged&&(u[u.state+"End"]&&u[u.state+"End"](),u.state="",u.releaseMouse())},a=(r.on("beforeEndOperation",d),r.startOperation({command:{name:"mouse"}}),u.$onCaptureMouseMove=n,u.releaseMouse=event.capture(this.editor.container,n,s),setInterval(o,20))},this.releaseMouse=null,this.cancelContextMenu=function(){var t=function(e){e&&e.domEvent&&"contextmenu"!=e.domEvent.type||(this.editor.off("nativecontextmenu",t),e&&e.domEvent&&event.stopEvent(e.domEvent))}.bind(this);setTimeout(t,10),this.editor.on("nativecontextmenu",t)},this.destroy=function(){this.releaseMouse&&this.releaseMouse()}}.call(MouseHandler.prototype),config.defineOptions(MouseHandler.prototype,"mouseHandler",{scrollSpeed:{initialValue:2},dragDelay:{initialValue:useragent.isMac?150:0},dragEnabled:{initialValue:!0},focusTimeout:{initialValue:0},tooltipFollowsMouse:{initialValue:!0}}),exports.MouseHandler=MouseHandler;