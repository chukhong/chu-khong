"use strict";var dom=require("../lib/dom"),event=require("../lib/event"),useragent=require("../lib/useragent"),AUTOSCROLL_DELAY=200,SCROLL_CURSOR_DELAY=200,SCROLL_CURSOR_HYSTERESIS=5;function DragdropHandler(t){var n,l,c,e,r,u,a,o,g,h,v,f=t.editor,i=dom.createElement("div"),s=(i.style.cssText="top:-100px;position:absolute;z-index:2147483647;opacity:0.5",i.textContent="Â ",["dragWait","dragWaitEnd","startDrag","dragReadyEnd","onMouseDrag"].forEach(function(e){t[e]=this[e]},this),f.on("mousedown",this.onMouseDown.bind(t)),f.container),d=0;function m(){var e,t,n,r,a,o,i,s,d=u;u=f.renderer.screenToTextCoordinates(l,c),t=u,e=d,r=Date.now(),n=!e||t.row!=e.row,e=!e||t.column!=e.column,!h||n||e?(f.moveCursorToPosition(t),h=r,v={x:l,y:c}):(n=calcDistance(v.x,v.y,l,c),SCROLL_CURSOR_HYSTERESIS<n?h=null:SCROLL_CURSOR_DELAY<=r-h&&(f.renderer.scrollCursorIntoView(),h=null)),e=u,t=d,n=Date.now(),r=f.renderer.layerConfig.lineHeight,d=f.renderer.layerConfig.characterWidth,a=f.renderer.scroller.getBoundingClientRect(),a={x:{left:l-a.left,right:a.right-l},y:{top:c-a.top,bottom:a.bottom-c}},o=Math.min(a.x.left,a.x.right),i=Math.min(a.y.top,a.y.bottom),s={row:e.row,column:e.column},o/d<=2&&(s.column+=a.x.left<a.x.right?-3:2),i/r<=1&&(s.row+=a.y.top<a.y.bottom?-1:1),o=e.row!=s.row,d=e.column!=s.column,i=!t||e.row!=t.row,o||d&&!i?g?AUTOSCROLL_DELAY<=n-g&&f.renderer.scrollCursorIntoView(s):g=n:g=null}function D(){r=f.selection.toOrientedRange(),n=f.session.addMarker(r,"ace_selection",f.getSelectionStyle()),f.clearSelection(),f.isFocused()&&f.renderer.$cursorLayer.setBlinking(!1),clearInterval(e),m(),e=setInterval(m,20),d=0,event.addListener(document,"mousemove",S)}function y(){clearInterval(e),f.session.removeMarker(n),n=null,f.selection.fromOrientedRange(r),f.isFocused()&&!o&&f.$resetCursorStyle(),d=0,h=g=u=r=null,event.removeListener(document,"mousemove",S)}this.onDragStart=function(e){var t;if(this.cancelDrag||!s.draggable)return t=this,setTimeout(function(){t.startSelect(),t.captureMouse(e)},0),e.preventDefault();r=f.getSelectionRange();var n=e.dataTransfer;n.effectAllowed=f.getReadOnly()?"copy":"copyMove",f.container.appendChild(i),n.setDragImage&&n.setDragImage(i,0,0),setTimeout(function(){f.container.removeChild(i)}),n.clearData(),n.setData("Text",f.session.getTextRange()),o=!0,this.setState("drag")},this.onDragEnd=function(e){s.draggable=!1,o=!1,this.setState(null),f.getReadOnly()||(e=e.dataTransfer.dropEffect,a||"move"!=e||f.session.remove(f.getSelectionRange()),f.$resetCursorStyle()),this.editor.unsetStyle("ace_dragging"),this.editor.renderer.setCursorStyle("")},this.onDragEnter=function(e){if(!f.getReadOnly()&&E(e.dataTransfer))return l=e.clientX,c=e.clientY,n||D(),d++,e.dataTransfer.dropEffect=a=w(e),event.preventDefault(e)},this.onDragOver=function(e){if(!f.getReadOnly()&&E(e.dataTransfer))return l=e.clientX,c=e.clientY,n||(D(),d++),null!==p&&(p=null),e.dataTransfer.dropEffect=a=w(e),event.preventDefault(e)},this.onDragLeave=function(e){if(--d<=0&&n)return y(),a=null,event.preventDefault(e)},this.onDrop=function(e){if(u){var t=e.dataTransfer;if(o)switch(a){case"move":r=r.contains(u.row,u.column)?{start:u,end:u}:f.moveText(r,u);break;case"copy":r=f.moveText(r,u,!0)}else{t=t.getData("Text");r={start:u,end:f.session.insert(u,t)},f.focus(),a=null}return y(),event.preventDefault(e)}},event.addListener(s,"dragstart",this.onDragStart.bind(t),f),event.addListener(s,"dragend",this.onDragEnd.bind(t),f),event.addListener(s,"dragenter",this.onDragEnter.bind(t),f),event.addListener(s,"dragover",this.onDragOver.bind(t),f),event.addListener(s,"dragleave",this.onDragLeave.bind(t),f),event.addListener(s,"drop",this.onDrop.bind(t),f);var p=null;function S(){null==p&&(p=setTimeout(function(){null!=p&&n&&y()},20))}function E(e){e=e.types;return!e||Array.prototype.some.call(e,function(e){return"text/plain"==e||"Text"==e})}function w(e){var t=["copy","copymove","all","uninitialized"],n=useragent.isMac?e.altKey:e.ctrlKey,r="uninitialized";try{r=e.dataTransfer.effectAllowed.toLowerCase()}catch(e){}var a="none";return n&&0<=t.indexOf(r)?a="copy":0<=["move","copymove","linkmove","all","uninitialized"].indexOf(r)?a="move":0<=t.indexOf(r)&&(a="copy"),a}}function calcDistance(e,t,n,r){return Math.sqrt(Math.pow(n-e,2)+Math.pow(r-t,2))}!function(){this.dragWait=function(){Date.now()-this.mousedownEvent.time>this.editor.getDragDelay()&&this.startDrag()},this.dragWaitEnd=function(){this.editor.container.draggable=!1,this.startSelect(this.mousedownEvent.getDocumentPosition()),this.selectEnd()},this.dragReadyEnd=function(e){this.editor.$resetCursorStyle(),this.editor.unsetStyle("ace_dragging"),this.editor.renderer.setCursorStyle(""),this.dragWaitEnd()},this.startDrag=function(){this.cancelDrag=!1;var e=this.editor,t=(e.container.draggable=!0,e.renderer.$cursorLayer.setBlinking(!1),e.setStyle("ace_dragging"),useragent.isWin?"default":"move");e.renderer.setCursorStyle(t),this.setState("dragReady")},this.onMouseDrag=function(e){var t=this.editor.container;useragent.isIE&&"dragReady"==this.state&&3<calcDistance(this.mousedownEvent.x,this.mousedownEvent.y,this.x,this.y)&&t.dragDrop(),"dragWait"===this.state&&0<calcDistance(this.mousedownEvent.x,this.mousedownEvent.y,this.x,this.y)&&(t.draggable=!1,this.startSelect(this.mousedownEvent.getDocumentPosition()))},this.onMouseDown=function(e){var t,n,r;this.$dragEnabled&&(this.mousedownEvent=e,t=this.editor,n=e.inSelection(),r=e.getButton(),1!==(e.domEvent.detail||1)||0!==r||!n||e.editor.inMultiSelectMode&&(e.getAccelKey()||e.getShiftKey())||(this.mousedownEvent.time=Date.now(),"unselectable"in(r=e.domEvent.target||e.domEvent.srcElement)&&(r.unselectable="on"),t.getDragDelay()?(useragent.isWebKit&&(this.cancelDrag=!0,t.container.draggable=!0),this.setState("dragWait")):this.startDrag(),this.captureMouse(e,this.onMouseDrag.bind(this)),e.defaultPrevented=!0))}}.call(DragdropHandler.prototype),exports.DragdropHandler=DragdropHandler;