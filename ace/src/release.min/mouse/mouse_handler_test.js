"undefined"!=typeof process&&(require("amd-loader"),require("../test/mockdom")),require("../multi_select"),require("../theme/textmate");var editor,Editor=require("../editor").Editor,Mode=require("../mode/java").Mode,VirtualRenderer=require("../virtual_renderer").VirtualRenderer,assert=require("../test/assertions"),MouseEvent=function(e,t){var o=document.createEvent("MouseEvents");return o.initMouseEvent(/click|wheel/.test(e)?e:"mouse"+e,!0,!0,window,t.detail,t.x,t.y,t.x,t.y,t.ctrl,t.alt,t.shift,t.meta,t.button||0,t.relatedTarget),o},WheelEvent=function(e){var t=new MouseEvent("wheel",e);return t.DOM_DELTA_PIXEL=0,t.DOM_DELTA_LINE=1,t.DOM_DELTA_PAGE=2,t.deltaMode=t["DOM_DELTA_"+e.mode.toUpperCase()],t.deltaX=e.x||0,t.deltaY=e.y||0,t};function sendTouchEvent(e,t,o){e=new window.Event("touch"+e,{bubbles:!0,cancelable:!0});Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)),o.container.dispatchEvent(e)}function touchPos(e,t){e=editor.renderer.textToScreenCoordinates(e,t),t=editor.renderer.lineHeight/2;return{clientX:e.pageX,clientY:e.pageY+t}}module.exports={setUp:function(e){this.editor=new Editor(new VirtualRenderer),this.editor.session.setValue("Juhu kinners!"),this.editor.container.style.position="absolute",this.editor.container.style.height="500px",this.editor.container.style.width="500px",this.editor.container.style.left="50px",this.editor.container.style.top="10px",document.body.appendChild(this.editor.container),editor=this.editor,e()},"test: double tap. issue #956":function(){this.editor.resize(!0);var e=this.editor.renderer.textToScreenCoordinates(0,1),t=this.editor.renderer.getMouseEventTarget();t.dispatchEvent(MouseEvent("down",{x:e.pageX,y:e.pageY})),t.dispatchEvent(MouseEvent("up",{x:e.pageX,y:e.pageY})),t.dispatchEvent(MouseEvent("down",{x:e.pageX,y:e.pageY,detail:2})),t.dispatchEvent(MouseEvent("up",{x:e.pageX,y:e.pageY,detail:2})),assert.equal(this.editor.getSelectedText(),"Juhu"),t.dispatchEvent(MouseEvent("down",{x:e.pageX,y:e.pageY})),t.dispatchEvent(MouseEvent("up",{x:e.pageX,y:e.pageY})),assert.equal(this.editor.getSelectedText(),"")},"test: multiselect":function(){var e=this.editor.renderer.getMouseEventTarget(),t=(this.editor.session.setValue("xyz\n\nabc efg"),this.editor.resize(!0),this.editor.renderer.textToScreenCoordinates(0,1)),o=(e.dispatchEvent(MouseEvent("down",{x:t.pageX,y:t.pageY})),e.dispatchEvent(MouseEvent("up",{x:t.pageX,y:t.pageY})),t=this.editor.renderer.textToScreenCoordinates(0,2),e.dispatchEvent(MouseEvent("down",{x:t.pageX,y:t.pageY,ctrl:!0})),e.dispatchEvent(MouseEvent("up",{x:t.pageX,y:t.pageY})),"Range: [0/2] -> [0/2],Range: [0/1] -> [0/1]"),t=(assert.equal(this.editor.selection.toJSON()+"",o),t=this.editor.renderer.textToScreenCoordinates(2,2),e.dispatchEvent(MouseEvent("down",{x:t.pageX,y:t.pageY,detail:2,ctrl:!0})),e.dispatchEvent(MouseEvent("up",{x:t.pageX,y:t.pageY,detail:2,ctrl:!0})),o="Range: [2/0] -> [2/3],"+o,assert.equal(this.editor.selection.toJSON()+"",o),this.editor.renderer.textToScreenCoordinates(0,1)),t=(e.dispatchEvent(MouseEvent("down",{x:t.pageX,y:t.pageY,ctrl:!0})),e.dispatchEvent(MouseEvent("up",{x:t.pageX,y:t.pageY,ctrl:!0})),o=o.split(",").slice(0,-1).join(","),assert.equal(this.editor.selection.toJSON()+"",o),this.editor.renderer.textToScreenCoordinates(0,2)),o=this.editor.renderer.textToScreenCoordinates(2,2);e.dispatchEvent(MouseEvent("down",{x:t.pageX,y:t.pageY,alt:!0})),e.dispatchEvent(MouseEvent("move",{x:o.pageX,y:o.pageY+1,alt:!0})),e.dispatchEvent(MouseEvent("up",{x:o.pageX,y:o.pageY+1,alt:!0})),assert.equal(this.editor.selection.toJSON()+"","Range: [2/2] -> [2/2],Range: [1/0] -> [1/0],Range: [0/2] -> [0/2]")},"test: gutter":function(){var e=this.editor,t=(t="x {"+"\n".repeat(50)+"}").repeat(50),t=(e.session.setMode(new Mode),e.setValue(t,-1),e.renderer.$loop._flush(),e.renderer.$gutterLayer.$lines),o=t.cells[0].element.lastChild,s=o.getBoundingClientRect(),s=(s.left||(s.left=100),o.dispatchEvent(MouseEvent("down",{x:s.left,y:s.top})),o.dispatchEvent(MouseEvent("up",{x:s.left,y:s.top})),o.dispatchEvent(MouseEvent("click",{x:s.left,y:s.top})),e.renderer.$loop._flush(),assert.ok(/ace_gutter-active-line/.test(t.cells[0].element.className)),assert.ok(/ace_closed/.test(o.className)),e.execCommand("golinedown"),e.renderer.$loop._flush(),assert.notOk(/ace_gutter-active-line/.test(t.cells[0].element.className)),assert.ok(/ace_gutter-active-line/.test(t.cells[1].element.className)),assert.equal(t.cells[1].element.textContent,"51"),WheelEvent({mode:"pixel",y:100}));o.dispatchEvent(s),e.renderer.$loop._flush(),assert.ok(1<parseInt(t.cells[0].element.textContent))},"test: wheel":function(){var e=this.editor,t=e.renderer.$gutterLayer.$lines,o=(e.setValue("\n".repeat(100),-1),e.renderer.$loop._flush(),assert.ok(1==parseInt(t.cells[0].element.textContent)),WheelEvent({mode:"line",y:2}));e.container.dispatchEvent(o),e.renderer.$loop._flush(),assert.ok(1<parseInt(t.cells[0].element.textContent)),o=WheelEvent({mode:"line",y:-2}),e.container.dispatchEvent(o),e.renderer.$loop._flush(),assert.ok(1==parseInt(t.cells[0].element.textContent)),o=WheelEvent({mode:"page",y:1}),e.container.dispatchEvent(o),e.renderer.$loop._flush(),assert.ok(10<parseInt(t.cells[0].element.textContent))},"test: touch":function(e){var t=this.editor,o=(o="x {"+"\n  abc".repeat(10)+"\n}").repeat(10),s=(t.setValue(o,-1),t.setOption("maxLines",10),t.renderer.$loop._flush(),window.editor=t,(window.sendTouchEvent=sendTouchEvent)("start",{touches:[touchPos(2,1)]},t),sendTouchEvent("end",{touches:[touchPos(2,1)]},t),t.renderer.$loop._flush(),assert.position(t.getCursorPosition(),2,1),sendTouchEvent("start",{touches:[touchPos(5,5),touchPos(6,6)]},t),sendTouchEvent("end",{touches:[touchPos(5,5)]},t),t.renderer.$loop._flush(),assert.position(t.getCursorPosition(),2,1),sendTouchEvent("start",{touches:[touchPos(2,1)]},t),sendTouchEvent("move",{touches:[touchPos(2,3)]},t),sendTouchEvent("move",{touches:[touchPos(2,4)]},t),sendTouchEvent("end",{touches:[touchPos(2,3)]},t),t.renderer.$loop._flush(),assert.equal(t.getSelectedText()," ab"),sendTouchEvent("start",{touches:[touchPos(3,3)]},t),sendTouchEvent("move",{touches:[touchPos(3,3)]},t),sendTouchEvent("end",{touches:[touchPos(3,3)]},t),sendTouchEvent("start",{touches:[touchPos(3,3)]},t),sendTouchEvent("move",{touches:[touchPos(3,3)]},t),sendTouchEvent("end",{touches:[touchPos(3,3)]},t),t.renderer.$loop._flush(),assert.equal(t.getSelectedText(),"abc"),t.container.querySelector(".ace_mobile-menu")),o=(sendTouchEvent("start",{touches:[touchPos(3,3)]},{container:s}),sendTouchEvent("end",{touches:[touchPos(3,3)]},{container:s}),t.container.querySelectorAll(".ace_mobile-button")[1]);sendTouchEvent("start",{touches:[touchPos(3,3)]},{container:o}),sendTouchEvent("end",{touches:[touchPos(3,3)]},{container:o}),assert.equal(t.getSelectedText(),""),sendTouchEvent("start",{touches:[touchPos(8,3)]},t),sendTouchEvent("move",{touches:[touchPos(8,3)]},t),setTimeout(function(){sendTouchEvent("move",{touches:[touchPos(1,3)]},t),sendTouchEvent("end",{touches:[touchPos(1,3)]},t),t.renderer.$loop._flush(),assert.equal(t.renderer.getFirstFullyVisibleRow(),7),setTimeout(function(){assert.notOk(s.clientHeight),assert.ok(7<t.renderer.getFirstFullyVisibleRow()),e()},50)},2)},"test: touch selection with scrollMargin":function(){editor.renderer.setScrollMargin(50,50,0,15),editor.setValue("Juhu Kinners!"),editor.renderer.$loop._flush();var e=editor.renderer.textToScreenCoordinates(0,0);assert.equal(e.pageY-editor.container.getBoundingClientRect().top,50),sendTouchEvent("start",{touches:[touchPos(0,0)]},editor),sendTouchEvent("move",{touches:[touchPos(0,5)]},editor),editor.renderer.$loop._flush(),sendTouchEvent("end",{touches:[touchPos(0,5)]},editor),editor.renderer.$loop._flush(),sendTouchEvent("start",{touches:[touchPos(0,12)]},editor),sendTouchEvent("move",{touches:[touchPos(0,8)]},editor),editor.renderer.$loop._flush(),sendTouchEvent("end",{touches:[touchPos(0,8)]},editor),assert.equal(editor.getSelectedText(),"Kin")},"test: destroy while mouse is pressed":function(){assert.ok(!this.editor.$mouseHandler.releaseMouse),this.editor.renderer.getMouseEventTarget().dispatchEvent(MouseEvent("down",{x:0,y:0})),assert.ok(this.editor.$mouseHandler.releaseMouse),this.editor.destroy(),assert.ok(!this.editor.$mouseHandler.releaseMouse)},tearDown:function(){this.editor.destroy(),document.body.removeChild(this.editor.container)}},"undefined"!=typeof module&&module===require.main&&require("asyncjs").test.testcase(module.exports).exec();