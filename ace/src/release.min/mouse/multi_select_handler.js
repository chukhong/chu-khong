var event=require("../lib/event"),useragent=require("../lib/useragent");function isSamePoint(e,n){return e.row==n.row&&e.column==n.column}function onMouseDown(e){var n=e.domEvent,o=n.altKey,t=n.shiftKey,r=n.ctrlKey,i=e.getAccelKey(),l=e.getButton();if(r&&useragent.isMac&&(l=n.button),e.editor.inMultiSelectMode&&2==l)e.editor.textInput.onContextMenu(e.domEvent);else if(r||o||i){if(0===l){var c,a,s,u,d,S,m,M,g=e.editor,f=g.selection,v=g.inMultiSelectMode,k=e.getDocumentPosition(),b=f.getCursor(),b=e.inSelection()||f.isEmpty()&&isSamePoint(k,b),p=e.x,P=e.y,$=g.session,R=g.renderer.pixelToScreenCoordinates(p,P),y=R;if(g.$mouseHandler.$enableJumpToDef)r&&o||i&&o?c=t?"block":"add":o&&g.$blockSelectEnabled&&(c="block");else if(i&&!o){if(c="add",!v&&t)return}else o&&g.$blockSelectEnabled&&(c="block");if(c&&useragent.isMac&&n.ctrlKey&&g.$mouseHandler.cancelContextMenu(),"add"==c)!v&&b||(v||(a=f.toOrientedRange(),g.addSelectionMarker(a)),s=f.rangeList.rangeAtPoint(k),g.inVirtualSelectionMode=!0,t&&(s=null,a=f.ranges[0]||a,g.removeSelectionMarker(a)),g.once("mouseup",function(){var e=f.toOrientedRange();s&&e.isEmpty()&&isSamePoint(s.cursor,e.cursor)?f.substractPoint(e.cursor):(t?f.substractPoint(a.cursor):a&&(g.removeSelectionMarker(a),f.addRange(a)),f.addRange(e)),g.inVirtualSelectionMode=!1}));else if("block"==c)return e.stop(),g.inVirtualSelectionMode=!0,d=[],S=function(){var e=g.renderer.pixelToScreenCoordinates(p,P),n=$.screenToDocumentPosition(e.row,e.column,e.offsetX);isSamePoint(y,e)&&isSamePoint(n,f.lead)||(y=e,g.selection.moveToPosition(n),g.renderer.scrollCursorIntoView(),g.removeSelectionMarkers(d),d=f.rectangularRangeBlock(y,R),g.$mouseHandler.$clickSelection&&1==d.length&&d[0].isEmpty()&&(d[0]=g.$mouseHandler.$clickSelection.clone()),d.forEach(g.addSelectionMarker,g),g.updateSelectionMarkers())},v&&!i?f.toSingleRange():!v&&i&&(u=f.toOrientedRange(),g.addSelectionMarker(u)),t?R=$.documentToScreenPosition(f.lead):f.moveToPosition(k),y={row:-1,column:-1},m=S,event.capture(g.container,function(e){p=e.clientX,P=e.clientY},function(e){S(),clearInterval(M),g.removeSelectionMarkers(d),d.length||(d=[f.toOrientedRange()]),u&&(g.removeSelectionMarker(u),f.toSingleRange(u));for(var n=0;n<d.length;n++)f.addRange(d[n]);g.inVirtualSelectionMode=!1,g.$mouseHandler.$clickSelection=null}),M=setInterval(function(){m()},20),e.preventDefault()}}else 0===l&&e.editor.inMultiSelectMode&&e.editor.exitMultiSelectMode()}exports.onMouseDown=onMouseDown;