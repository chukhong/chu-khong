"use strict";var MouseEvent=require("./mouse_event").MouseEvent,event=require("../lib/event"),dom=require("../lib/dom");exports.addTouchListeners=function(e,u){var d,p,m,f,g,t,v,h,l,b="scroll",y=0,C=0,w=0,T=0;function i(){function t(e){var t,n=e.target.getAttribute("action");"more"!=n&&i?("paste"==n?o.readText().then(function(e){u.execCommand(n,e)}):n&&("cut"!=n&&"copy"!=n||(o?o.writeText(u.getCopyText()):document.execCommand("copy")),u.execCommand(n)),l.firstChild.style.display="none",i=!1,"openCommandPallete"!=n&&u.focus()):(i=!i,e=u.getCopyText(),t=u.session.getUndoManager().hasUndo(),l.replaceChild(dom.buildDom(i?["span",!e&&["span",{class:"ace_mobile-button",action:"selectall"},"Select All"],e&&["span",{class:"ace_mobile-button",action:"copy"},"Copy"],e&&["span",{class:"ace_mobile-button",action:"cut"},"Cut"],o&&["span",{class:"ace_mobile-button",action:"paste"},"Paste"],t&&["span",{class:"ace_mobile-button",action:"undo"},"Undo"],["span",{class:"ace_mobile-button",action:"find"},"Find"],["span",{class:"ace_mobile-button",action:"openCommandPallete"},"Pallete"]]:["span"]),l.firstChild))}var o=window.navigator&&window.navigator.clipboard,i=!1;l=dom.buildDom(["div",{class:"ace_mobile-menu",ontouchstart:function(e){b="menu",e.stopPropagation(),e.preventDefault(),u.textInput.focus()},ontouchend:function(e){e.stopPropagation(),e.preventDefault(),t(e)},onclick:t},["span"],["span",{class:"ace_mobile-button",action:"more"},"..."]],u.container)}function n(){l||i();var e=u.selection.cursor,e=u.renderer.textToScreenCoordinates(e.row,e.column),t=u.renderer.textToScreenCoordinates(0,0).pageX,n=u.renderer.scrollLeft,o=u.container.getBoundingClientRect();l.style.top=e.pageY-o.top-3+"px",e.pageX-o.left<o.width-70?(l.style.left="",l.style.right="10px"):(l.style.right="",l.style.left=t+n-o.left+"px"),l.style.display="",l.firstChild.style.display="none",u.on("input",r)}function r(e){l&&(l.style.display="none"),u.off("input",r)}function x(){g=null,clearTimeout(g);var e=u.selection.getRange(),t=e.contains(v.row,v.column);!e.isEmpty()&&t||(u.selection.moveToPosition(v),u.selection.selectWord()),b="wait",n()}event.addListener(e,"contextmenu",function(e){h&&u.textInput.getElement().focus()},u),event.addListener(e,"touchstart",function(e){var t=e.touches;if(g||1<t.length)clearTimeout(g),g=null,m=-1,b="zoom";else{h=u.$mouseHandler.isMousePressed=!0;var n=u.renderer.layerConfig.lineHeight,o=u.renderer.layerConfig.lineHeight,i=e.timeStamp,l=(f=i,t[0]),r=l.clientX,l=l.clientY,r=(Math.abs(d-r)+Math.abs(p-l)>n&&(m=-1),d=e.clientX=r,p=e.clientY=l,w=T=0,new MouseEvent(e,u));if(v=r.getDocumentPosition(),i-m<500&&1==t.length&&!y)C++,e.preventDefault(),e.button=0,g=null,clearTimeout(g),u.selection.moveToPosition(v),(l=2<=C?u.selection.getLineRange(v.row):u.session.getBracketRange(v))&&!l.isEmpty()?u.selection.setRange(l):u.selection.selectWord(),b="wait";else{C=0;var r=u.selection.cursor,t=u.selection.isEmpty()?r:u.selection.anchor,l=u.renderer.$cursorLayer.getPixelPosition(r,!0),r=u.renderer.$cursorLayer.getPixelPosition(t,!0),t=u.renderer.scroller.getBoundingClientRect(),s=u.renderer.layerConfig.offset,a=u.renderer.scrollLeft,c=function(e,t){return(e/=o)*e+(t=t/n-.75)*t};if(e.clientX<t.left)return void(b="zoom");l=c(e.clientX-t.left-l.left+a,e.clientY-t.top-l.top+s),c=c(e.clientX-t.left-r.left+a,e.clientY-t.top-r.top+s);l<3.5&&c<3.5&&(b=c<l?"cursor":"anchor"),b=c<3.5?"anchor":l<3.5?"cursor":"scroll",g=setTimeout(x,450)}m=i}},u),event.addListener(e,"touchend",function(e){h=u.$mouseHandler.isMousePressed=!1,t&&clearInterval(t),"zoom"==b?(b="",y=0):(g?(u.selection.moveToPosition(v),y=0,n):"scroll"==b?(y+=60,t=setInterval(function(){y--<=0&&(clearInterval(t),t=null),Math.abs(w)<.01&&(w=0),Math.abs(T)<.01&&(T=0),y<20&&(w*=.9),y<20&&(T*=.9);var e=u.session.getScrollTop();u.renderer.scrollBy(10*w,10*T),e==u.session.getScrollTop()&&(y=0)},10),r):n)(),clearTimeout(g),g=null},u),event.addListener(e,"touchmove",function(e){g&&(clearTimeout(g),g=null);var t=e.touches;if(!(1<t.length||"zoom"==b)){var t=t[0],n=d-t.clientX,o=p-t.clientY;if("wait"==b){if(!(4<n*n+o*o))return e.preventDefault();b="cursor"}d=t.clientX,p=t.clientY,e.clientX=t.clientX,e.clientY=t.clientY;var t=e.timeStamp,i=t-f;f=t,"scroll"==b?((t=new MouseEvent(e,u)).speed=1,t.wheelX=n,t.wheelY=o,10*Math.abs(n)<Math.abs(o)&&(n=0),10*Math.abs(o)<Math.abs(n)&&(o=0),0!=i&&(w=n/i,T=o/i),u._emit("mousewheel",t),t.propagationStopped||(w=T=0)):(n=new MouseEvent(e,u).getDocumentPosition(),"cursor"==b?u.selection.moveCursorToPosition(n):"anchor"==b&&u.selection.setSelectionAnchor(n.row,n.column),u.renderer.scrollCursorIntoView(n),e.preventDefault())}},u)};