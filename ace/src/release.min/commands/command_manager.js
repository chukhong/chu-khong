"use strict";var oop=require("../lib/oop"),MultiHashHandler=require("../keyboard/hash_handler").MultiHashHandler,EventEmitter=require("../lib/event_emitter").EventEmitter,CommandManager=function(t,e){MultiHashHandler.call(this,e,t),this.byName=this.commands,this.setDefaultHandler("exec",function(t){return t.args?t.command.exec(t.editor,t.args,t.event,!1):t.command.exec(t.editor,{},t.event,!0)})};oop.inherits(CommandManager,MultiHashHandler),function(){oop.implement(this,EventEmitter),this.exec=function(t,e,i){if(Array.isArray(t)){for(var r=t.length;r--;)if(this.exec(t[r],e,i))return!0;return!1}var a;return!!(t="string"==typeof t?this.commands[t]:t)&&!(e&&e.$readOnly&&!t.readOnly||0!=this.$checkCommandState&&t.isAvailable&&!t.isAvailable(e)||((a={editor:e,command:t,args:i}).returnValue=this._emit("exec",a),this._signal("afterExec",a),!1===a.returnValue))},this.toggleRecording=function(t){if(!this.$inReplay)return t&&t._emit("changeStatus"),this.recording?(this.macro.pop(),this.off("exec",this.$addCommandToMacro),this.macro.length||(this.macro=this.oldMacro),this.recording=!1):(this.$addCommandToMacro||(this.$addCommandToMacro=function(t){this.macro.push([t.command,t.args])}.bind(this)),this.oldMacro=this.macro,this.macro=[],this.on("exec",this.$addCommandToMacro),this.recording=!0)},this.replay=function(e){if(!this.$inReplay&&this.macro){if(this.recording)return this.toggleRecording(e);try{this.$inReplay=!0,this.macro.forEach(function(t){"string"==typeof t?this.exec(t,e):this.exec(t[0],e,t[1])},this)}finally{this.$inReplay=!1}}},this.trimMacro=function(t){return t.map(function(t){return"string"!=typeof t[0]&&(t[0]=t[0].name),t=t[1]?t:t[0]})}}.call(CommandManager.prototype),exports.CommandManager=CommandManager;