"use strict";var dom=require("../lib/dom"),CHAR_HEIGHT=10,CHAR_WIDTH=6,WINDOW_HEIGHT=768,WINDOW_WIDTH=1024;function Style(){}function ClassList(t){this.el=t}function Attr(t,e){this.name=t,this.value=e}Style.prototype.getPropertyValue=function(){return""},Style.prototype.__defineGetter__("cssText",function(){var e="";return Object.keys(this).forEach(function(t){this[t]&&(e+=(e?" ":"")+t+": "+this[t]+";")},this),e}),Style.prototype.__defineSetter__("cssText",function(t){Object.keys(this).forEach(function(t){delete this[t]},this),t.split(";").forEach(function(t){t=t.split(":");2==t.length&&(this[t[0].trim()]=t[1].trim())},this)}),function(){this.add=function(t){dom.addCssClass(this.el,t)},this.remove=function(t){dom.removeCssClass(this.el,t)},this.toggle=function(t){dom.toggleCssClass(this.el,t)},this.contains=function(t){dom.hasCssClass(this.el,t)}}.call(ClassList.prototype),function(){this.__defineGetter__("nodeValue",function(){return this.value})}.call(Attr.prototype);var initializers={textarea:function(){this.selectionStart=this.selectionEnd=0,this.setSelectionRange=function(t,e){this.selectionStart=Math.min(t,this.value.length,e),this.selectionEnd=Math.min(e,this.value.length)};var e="";this.__defineGetter__("value",function(){return e}),this.__defineSetter__("value",function(t){(t="string"!=typeof t?t.toString():t)!=e&&(e=t,this.selectionStart=this.selectionEnd=e.length)}),this.select=function(){this.setSelectionRange(0,1/0)}},input:function(){initializers.textarea.call(this)},style:function(){this.sheet={insertRule:function(){},cssRules:[]}}};function getItem(t){return this[t]}function Node(t){this.localName=t,this.value="",this.children=this.childNodes=[],this.childNodes.item=getItem,this.ownerDocument=window.document||this,this.$attributes={},this.style=new Style,initializers.hasOwnProperty(t)&&initializers[t].call(this)}function parseSelector(t){for(var e=t.split(/((?:[^\s>"[]|"[^"]+"?|\[[^\]]*\]?)+)/),n=1;n<e.length;n+=2)e[n]=parseSimpleSelector(e[n]),/^ +$/.test(e[n+1])&&(e[n+1]=" ");return e}function parseSimpleSelector(s){var u=[];return s.replace(/([#.])?([\w-]+)|\[\s*([\w-]+)\s*(?:=\s*"?([\w-]+)"?\s*)?\]|\*|./g,function(t,e,n,i,r){if("#"==e)u.push(function(t){return t.id==n});else if("."==e){var o=new RegExp("(^|\\s)"+n+"($|\\s)");u.push(function(t){return o.test(t.className)})}else if(n)u.push(function(t){return t.localName==n});else if(i)u.push(function(t){return t.getAttribute(i)==r});else{if("*"!=t)throw new Error("Error parsing selector "+s+"|"+t);u.push(function(t){return!0})}}),u}function setInnerHTML(t,e,n){for(var i,o=e,r=/<(\/?[\w:\-]+|!)|&(?:(#?\w+);)|$/g,s="",u=0;i=r.exec(t);){s+=t.substring(u,i.index);var h=i[2];if(h)s+=parseCharacterEntity(h),u=r.lastIndex;else if("!"==i[1])s+=parseDocType(t,r,n),u=r.lastIndex;else{s&&(o.appendChild(document.createTextNode(s)),s="");var c,d,h=t.indexOf(">",r.lastIndex),a="/"===t[h-1]?1:0,l=t.slice(r.lastIndex,h-a).trim();if(r.lastIndex=u=h<0?t.length:h+1,!i[1]){if(n&&o!=e)throw new Error("Invalid XML message:");return}"/"!==i[1][0]&&(h=i[1],/:/.test(h)?(c=h.indexOf(":"),d=h.slice(0,c),h=h.slice(c+1),(o=o.appendChild(document.createElement(h))).prefix=d):o=o.appendChild(document.createElement(h)),l)&&l.replace(/([\w:-]+)\s*=\s*(?:"([^"]*)"|'([^"]*)'|(\w+))/g,function(t,e,n,i,r){o.setAttribute(e,n||i||r||e)}),"/"!==i[1][0]&&!a||o==e||(o=o.parentNode)}}if(n&&o!=e)throw new Error("Invalid XML message:")}function parseCharacterEntity(t){var e;return"#"==t[0]?"x"==(e=t.slice(1))[0]?String.fromCharCode(parseInt(e.slice(1),16)):String.fromCharCode(parseInt(e,10)):"gt"==t?">":"lt"==t?"<":"amp"==t?"&":"quot"==t?'"':(console.error("Skipping unsupported character entity",t),"")}function parseDocType(t,e,n){var i=e.lastIndex,r=-1,o="";return"-"==t[i]&&"-"==t[i+1]?-1!=(r=t.indexOf("--\x3e",i+2))&&(r+=3):n&&"[CDATA["==t.substr(i,7)?(r=t.indexOf("]]>",i),o=t.slice(i+7,r),r+=3):-1!=(r=t.indexOf(">",i))&&(r+=1),-1==r&&(r=t.length),e.lastIndex=r,o}function escapeHTML(t){return t.replace(/[<>&]/g,function(t){return"<"==t?"&lt;":">"==t?"&gt;":"&"==t?"&amp;":void 0})}function Event(t,e){this.type=t,Object.assign(this,e)}function walk(t,e){for(var n=t.children||[],i=0;i<n.length;i++){var r=e(n[i])||walk(n[i],e);if(r)return r}}function walkShallow(t,e){for(var n=t.children||[],i=0;i<n.length;i++){var r=e(n[i]);if(r)return r}}function TextNode(t){this.data=t||""}!function(){function c(t,e){var n=parseFloat(t)||0;return n=/%/.test(t)?e*n/100:n}function e(t){t.children.forEach(function(t){t.parentNode=null}),t.children.length=0,document.contains(document.activeElement)||(document.activeElement=document.body)}this.nodeType=1,this.ELEMENT_NODE=1,this.TEXT_NODE=1,this.cloneNode=function(t){var e,n=new Node(this.localName);for(e in this.$attributes)n.setAttribute(e,this.$attributes[e]);return t&&this.children.forEach(function(t){n.appendChild(t.cloneNode(!0))},this),n},this.appendChild=function(t){return this.insertBefore(t,null)},this.removeChild=function(t){var e=this.children.indexOf(t);if(-1==e)throw new Error("not a child");t.parentNode=t.nextSibling=t.previousSibling=null,this.children.splice(e,1),document.contains(document.activeElement)||(document.activeElement=document.body)},this.remove=function(){this.parentNode&&this.parentNode.removeChild(this)},this.replaceChild=function(t,e){return this.insertBefore(t,e),this.removeChild(e),e},this.insertBefore=function(t,e){t.parentNode&&t.parentNode.removeChild(t);var n=this.children.indexOf(e);if(-1==n&&(n=this.children.length+1),"#fragment"==t.localName)for(var i=t.children.slice(),r=0;r<i.length;r++)this.insertBefore(i[r],e);else this.children.splice(n,0,t),t.nextSibling=this.children[n],t.previousSibling=this.children[n-2],t.nextSibling&&(t.nextSibling.previousSibling=t),t.previousSibling&&(t.previousSibling.nextSibling=t),t.parentNode=this;return t},this.before=function(t){this.parentNode&&this.parentNode.insertBefore(t,this)},this.hasChildNodes=function(){return 0<this.childNodes.length},this.__defineGetter__("childElementCount",function(){return this.childNodes.length}),this.hasAttributes=function(){return 0<Object.keys(this.$attributes).length},this.querySelectorAll=function(t){var t=parseSelector(t),o=[];return function t(e,n){var i=n[0],r=n[1];(">"==i?walkShallow:walk)(e,function(e){r.every(function(t){return t(e)})&&(3<n.length?t(e,n.slice(2)):o.push(e))})}(this,t),o},this.querySelector=function(t){return this.querySelectorAll(t)[0]},this.getElementsByTagName=function(e){var n=[];return walk(this,function(t){t.localName==e&&n.push(t)}),n},this.getElementById=function(e){return walk(this,function(t){if(t.getAttribute&&t.getAttribute("id")==e)return t})},this.matches=function(t){for(var e,n,i=parseSelector(t),r=this;i.length&&r;){if(n||(e=i.pop(),n=">"!=i.pop()),!e)return!0;if(!e.every(function(t){return t(r)})&&!n)return!1;r=r.parentNode}},this.closest=function(t){var e=this;do{if(e.matches(t))return e}while(null!==(e=e.parentElement||e.parentNode)&&1===e.nodeType);return null},this.removeAttribute=function(t){delete this.$attributes[t]},this.setAttribute=function(t,e){this.$attributes[t]=e},this.getAttribute=function(t,e){return String(this.$attributes[t]||"")},this.__defineGetter__("nodeName",function(){return this.localName}),this.__defineGetter__("tagName",function(){return this.localName}),this.__defineGetter__("attributes",function(){var t=this.style.cssText,t=(t&&(this.$attributes.style=t),Object.keys(this.$attributes).map(function(t){return new Attr(t,this.$attributes[t])},this));return t.item=getItem,t}),this.__defineGetter__("classList",function(){return this.$classList||(this.$classList=new ClassList(this))}),this.__defineGetter__("className",function(){return this.$attributes.class||""}),this.__defineSetter__("className",function(t){this.$attributes.class=t}),this.__defineGetter__("textContent",function(){var e="";return walk(this,function(t){t instanceof TextNode&&(e+=t.data)}),e}),this.__defineSetter__("textContent",function(t){e(this),this.appendChild(new TextNode(t))}),this.__defineGetter__("innerText",function(){if(!this.documentElement)throw new Error("use textContent")}),this.__defineSetter__("innerText",function(t){throw new Error("use textContent")}),this.__defineGetter__("id",function(){return this.getAttribute("id")}),this.__defineSetter__("id",function(t){this.setAttribute("id",t)}),this.__defineGetter__("parentElement",function(){return this.parentNode==document?null:this.parentNode}),this.__defineGetter__("innerHTML",function(){return this.children.map(function(t){return"outerHTML"in t?t.outerHTML:escapeHTML(t.data)}).join("")}),this.__defineGetter__("outerHTML",function(){var t=this.attributes.map(function(t){return t.name+"="+JSON.stringify(t.value)},this).join(" ");return"<"+this.localName+(t?" "+t:"")+">"+this.innerHTML+"</"+this.localName+">"}),this.__format=function(e){e=e||"";var t=this.attributes.map(function(t){return t.name+"="+JSON.stringify(t.value)},this).join(" ");return e+"<"+this.localName+(t?" "+t:"")+">"+this.children.map(function(t){return"__format"in t?"\n"+t.__format(e+"    "):escapeHTML(t.data)}).join("")+"\n"+e+"</"+this.localName+">"},this.__defineSetter__("innerHTML",function(t){e(this),setInnerHTML(t,this)}),this.insertAdjacentHTML=function(t,e){var n=document.createDocumentFragment();setInnerHTML(e,n),this.insertAdjacentElement(t,n)},this.insertAdjacentElement=function(t,e){"beforeend"===(t=t.toLowerCase())&&this.appendChild(e),"afterend"===t&&this.parentElement.insertBefore(e,this.nextSibling),"afterbegin"===t&&this.insertBefore(e,this.firstChild),"beforebegin"===t&&this.parentElement.insertBefore(e,this)},this.getBoundingClientRect=function(t){var e,n,i,r=0,o=0,s=0,u=0;if(this==document.documentElement)r=WINDOW_WIDTH,o=WINDOW_HEIGHT;else if(document.contains(this)&&"none"!=this.style.display)if("auto"==this.style.width||"span"==this.localName){for(var r=this.textContent.length*CHAR_WIDTH,h=this;h;){if(h.style.fontSize){o=parseInt(h.style.fontSize);break}h=h.parentNode}o=o||CHAR_HEIGHT}else this.parentNode&&(e=this.parentNode.getBoundingClientRect(),u=c(this.style.left||"0",e.width),s=c(this.style.top||"0",e.height),n=c(this.style.right||"0",e.width),i=c(this.style.bottom||"0",e.width),r=this.style.width?c(this.style.width||"100%",e.width):e.width-n-u,o=this.style.width?c(this.style.height||"100%",e.height):e.height-s-i,s+=e.top,i+=e.bottom);else r=o=0;return{top:s,left:u,width:r,height:o,right:u+r,bottom:s+o}},this.__defineGetter__("clientHeight",function(){return this.getBoundingClientRect().height}),this.__defineGetter__("clientWidth",function(){return this.getBoundingClientRect().width}),this.__defineGetter__("offsetHeight",function(){return this.getBoundingClientRect().height}),this.__defineGetter__("offsetWidth",function(){return this.getBoundingClientRect().width}),this.__defineGetter__("lastChild",function(){return this.childNodes[this.childNodes.length-1]}),this.__defineGetter__("firstChild",function(){return this.childNodes[0]}),this.scrollHeight=1,this.addEventListener=function(t,e,n){if(!e)throw console.trace(),new Error("attempting to add empty listener");this._events||(this._events={}),this._events[t]||(this._events[t]=[]),-1==this._events[t].indexOf(e)&&this._events[t][n?"unshift":"push"](e)},this.removeEventListener=function(t,e){this._events&&this._events[t]&&-1!==(e=this._events[t].indexOf(e))&&this._events[t].splice(e,1)},this.createEvent=function(t){return new Event},this.dispatchEvent=function(e){e.target||(e.target=this),e.timeStamp||(e.timeStamp=Date.now());var t=(e.currentTarget=this)._events&&this._events[e.type];t&&t.forEach(function(t){t.call(this,e)},this),this["on"+e.type]&&this["on"+e.type](e),e.bubbles&&!e.stopped&&(this.parentNode?this.parentNode.dispatchEvent(e):this!=window&&window.dispatchEvent(e))},this.contains=function(t){for(;t;){if(t==this)return!0;t=t.parentNode}},this.focus=function(){document.activeElement!=this&&(document.activeElement&&document.activeElement.dispatchEvent({type:"blur"}),(document.activeElement=this).dispatchEvent({type:"focus"}))},this.blur=function(){document.activeElement==this&&document.body.focus()}}.call(Node.prototype),function(){this.initMouseEvent=function(t,e,n,i,r,o,s,u,h,c,d,a,l,f,m){this.bubbles=!0,this.type=t,this.detail=r||0,this.clientX=o,this.clientY=s,this.button=f,this.relatedTarget=m,this.ctrlKey=c,this.altKey=d,this.shiftKey=a,this.metaKey=l},this.preventDefault=function(){this.defaultPrevented=!0},this.stopPropagation=function(){this.stopped=!0}}.call(Event.prototype),function(){this.nodeType=3,this.ELEMENT_NODE=1,this.TEXT_NODE=1,this.cloneNode=function(){return new TextNode(this.data)},this.__defineGetter__("nodeValue",function(){return this.data})}.call(TextNode.prototype);var window={get innerHeight(){return WINDOW_HEIGHT},get innerWidth(){return WINDOW_WIDTH},navigator:{userAgent:"node",platform:"win",appName:""}},document=(window.HTMLDocument=window.XMLDocument=window.Document=function(){var t=this;return window.document||(window.document=t),Node.call(this,"#document"),t.navigator=window.navigator,t.styleSheets=[],t.createElementNS=function(t,e){return new Node(e)},t.createElement=function(t){return new Node(t)},t.createComment=t.createTextNode=function(t){return new TextNode(t)},t.createDocumentFragment=function(){return new Node("#fragment")},t.hasFocus=function(){return!0},t.execCommand=function(){},t.documentElement=t.appendChild(new Node("html")),t.body=new Node("body"),t.activeElement=t.body,t.head=new Node("head"),t.documentElement.appendChild(t.head),t.documentElement.appendChild(t.body),t},window.Document.prototype=Node.prototype,window.DOMParser=function(){this.parseFromString=function(t,e){var n=new window.Document({});return"text/xml"==e||"application/xml"==e?(e=t.replace(/<\?([^?]|\?[^>])+\?>/g,"").trim(),n.innerHTML="",setInnerHTML(e,n,!0),n.documentElement=n.firstChild):n.body.innerHTML=t,n}},new window.Document),addedProperties=(window.__defineGetter__("document",function(){return document}),(window.document.defaultView=window).setTimeout=setTimeout,window.clearTimeout=clearTimeout,window.getComputedStyle=function(t){return t.style},window.addEventListener=document.addEventListener.bind(window),window.removeEventListener=document.removeEventListener.bind(window),window.dispatchEvent=document.dispatchEvent.bind(window),window.name="nodejs",window.focus=function(){},window.Node=window.Element=Node,window.Text=window.TextNode=TextNode,window.Attr=Attr,(window.window=window).CustomEvent=window.Event=window.KeyboardEvent=Event,window.requestAnimationFrame=function(t){return setTimeout(function(){t()})},"undefined"!=typeof Buffer&&(window.btoa=function(t){return Buffer.from(t.toString(),"binary").toString("base64")},window.atob=function(t){return Buffer.from(t,"base64").toString("binary")}),[]);exports.load=function(){"undefined"!=typeof global&&(window.window=global,Object.keys(window).forEach(function(t){global[t]||(addedProperties.push(t),global.__defineGetter__(t,function(){return window[t]}),global.__defineSetter__(t,function(){}))}))},exports.loadInBrowser=function(e){for(var t in delete e.ResizeObserver,e.__origRoot__=e.document.documentElement,e.__origBody__=e.document.body,Object.keys(window).forEach(function(t){"document"!=t&&"window"!=t&&(delete e[t],e[t]=window[t])}),window.document){var n=window.document[t];"function"==typeof n?("createElement"==t&&(e.document.createElementOrig=e.document.createElement,n=function(t){return"script"==t?e.document.createElementOrig(t):window.document.createElement(t)}),n=n.bind(window.document),Object.defineProperty(e.document,t,{value:n,enumerable:!0,configurable:!0})):Object.defineProperty(e.document,t,{get:function(t){return window.document[t]}.bind(null,t),enumerable:!0,configurable:!0})}},exports.unload=function(){"undefined"!=typeof global&&(delete require("module")._cache[__filename],addedProperties.forEach(function(t){delete global[t]}))},exports.load();