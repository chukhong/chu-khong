"use strict";var app,editor,CLIENT_ID="563587575029-89224il8qt9bc2i5d3f15fucn6nutv0t.apps.googleusercontent.com",API_KEY="AIzaSyAriPgPyfamY9SudpCiBJ86RSiO-MYyi98",DISCOVERY_DOCS=["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],SCOPES="https://www.googleapis.com/auth/drive",signinButton=document.getElementsByClassName("signin")[0],signoutButton=document.getElementsByClassName("signout")[0];let tokenClient,gapiInited=!1,gisInited=!1,gdToken;function gapiLoaded(){if(navigator.onLine)try{gapi.load("client",initializeGapiClient)}catch(e){console.log("Error",e.message)}}function maybeEnableButtons(){gapiInited&&gisInited&&(signinButton.style.display="block")}async function initializeGapiClient(){await gapi.client.init({apiKey:API_KEY,discoveryDocs:DISCOVERY_DOCS}),gapiInited=!0,maybeEnableButtons()}function gisLoaded(){if(navigator.onLine)try{tokenClient=google.accounts.oauth2.initTokenClient({client_id:CLIENT_ID,scope:SCOPES,callback:""}),gisInited=!0,maybeEnableButtons(),(gdToken=localStorage.getItem("gdToken"))&&(signinButton.querySelector("a").innerText="Refresh",signinButton.style.visibility="visible",signoutButton.style.visibility="visible")}catch(e){}}function handleAuthClick(){tokenClient.callback=async e=>{if(void 0!==e.error)throw e;gdToken=gapi.client.getToken(),localStorage.setItem("gdToken",gdToken),signinButton.style.display="none",signoutButton.style.display="block",checkFolder()},null===gdToken?tokenClient.requestAccessToken({prompt:"consent"}):tokenClient.requestAccessToken({prompt:""})}function handleSignoutClick(){var e=gapi.client.getToken();null!==e&&(google.accounts.oauth2.revoke(e.access_token),gapi.client.setToken(""),signinButton.style.display="block",signoutButton.style.display="none"),localStorage.removeItem("gdToken")}function checkFolder(){gapi.client.drive.files.list({q:'name = "Chu-Khong"'}).then(function(e){var t=e.result.files;if(t&&0<t.length)for(var n=0;n<t.length;n++){var a=t[n];localStorage.setItem("parent_folder",a.id),console.log("Folder Available"),app.toast.message("Google Device","Folder Available"),showList()}else createFolder()}).catch(e=>{console.log("[Error] Google Device",e.message),app.toast.message("[Error] Google Device",e.message)})}function gdUpload(){try{var e,t,n,a,i={value:editor.getValue()};""!=i.value&&(e=new Blob([i.value],{type:"plain/text"}),t=localStorage.getItem("parent_folder"),i.value.split(" ")[0],i.value.split(" ")[1],n={name:fileName.innerHTML.trim()+".txt",mimeType:"plain/text;charset=utf-8",parents:[t]},(a=new FormData).append("metadata",new Blob([JSON.stringify(n)],{type:"application/json"})),a.append("file",e),fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:new Headers({Authorization:"Bearer "+gapi.auth.getToken().access_token}),body:a}).then(function(e){return e.json()}).then(function(e){editor.id=e.id,d.q("[data-cmd-as=save]").setAttribute("onClick","gdUpdate()"),e&&e.error?app.toast.message("Error From Google Driver",e.error.message).show():(app.toast.message("Google Driver","Upload new file successfully").show(),showList())}))}catch(e){app.toast.message("Error Google Driver",e.message).show()}}function createFolder(){var e=gapi.auth.getToken().access_token;gapi.client.request({path:"drive/v2/files",method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e},body:{title:"Chu-Khong",mimeType:"application/vnd.google-apps.folder"}}).execute(function(e){localStorage.setItem("parent_folder",e.id)})}exports.gapiLoaded=gapiLoaded,exports.gisLoaded=gisLoaded,exports.handleAuthClick=handleAuthClick,window.gdUpload=gdUpload;var expandContainer=document.querySelector(".expand-container"),expandContainerUl=document.querySelector(".expand-container ul"),listcontainer=document.querySelector(".list ul");function gdExpand(e){var t=e.getBoundingClientRect();"block"==expandContainer.style.display?(expandContainer.style.display="none",expandContainerUl.setAttribute("data-id",""),expandContainerUl.setAttribute("data-name","")):(expandContainer.style.display="block",expandContainer.style.left=t.left+window.scrollX-120+"px",expandContainer.style.top=t.top+window.scrollY+25+"px",expandContainerUl.setAttribute("data-id",e.parentElement.getAttribute("data-id")),expandContainerUl.setAttribute("data-name",e.parentElement.getAttribute("data-name")))}function showList(){var a={edit:()=>{readEditDownload(this,"edit")}};gapi.client.drive.files.list({q:`parents in "${localStorage.getItem("parent_folder")}"`}).then(function(e){var t=cacheFiles=e.result.files;if(t&&0<t.length){listcontainer.innerHTML="";for(var n=0;n<t.length;n++)listcontainer.innerHTML+=`
                
                <li data-id="${t[n].id}" data-name="${t[n].name}" class="list-group-item list-group-item-action list-group-item-dark">
                <span onclick="readEditDownload(this, 'edit')">${t[n].name}</span>
                <svg onclick="gdExpand(this)" xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M24 24H0V0h24v24z" fill="none" opacity=".87"/><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6-1.41-1.41z"/></svg>
                </li>
                
                `}else listcontainer.innerHTML='<div style="text-align: center;">No Files</div>';$(document).on("click","[data-cmd-gd]",function(e){var t=$(this).data("cmdGd");a[t]?a[t](e):console.log(`
                    // ${t} not defined
                    ${t}:()=>{}
	            `)})})}function updateFileNameToToolBar(t){var e;cacheFiles&&(e=cacheFiles.find(e=>e.id==t),fileName.innerHTML=e.name)}function readEditDownload(e,l){var s=e.parentElement.getAttribute("data-id"),r=e.parentElement.getAttribute("data-name");gapi.client.drive.files.get({fileId:s,alt:"media"}).then(function(e){updateFileNameToToolBar(s),expandContainer.style.display="none",expandContainerUl.setAttribute("data-id",""),expandContainerUl.setAttribute("data-name","");for(var t=e.body,n=t.length,a=new Uint8Array(n),i=0;i<n;i++)a[i]=t.charCodeAt(i);var o,e=(new TextDecoder).decode(a);"read"==l?(editor.setValue(e),document.documentElement.scrollTop=0,(o=d.q("[data-cmd-as=save]")).setAttribute("onClick","gdUpload()"),o.setAttribute("disabled",!0)):"edit"==l?(editor.setValue(e),document.documentElement.scrollTop=0,(o=d.q("[data-cmd-as=save]")).setAttribute("onClick","gdUpdate()"),editor.id=s,app.toast.message("Google Driver","File ready for update").show()):(o=new Blob([e],{type:"plain/text;charset=utf-8"}),(e=document.createElement("a")).href=window.URL.createObjectURL(o),e.download=r,e.click()),$("#leftSidebar").offcanvas("hide")})}function gdUpdate(){try{var e=editor.id;fetch("https://www.googleapis.com/upload/drive/v3/files/"+e+"?uploadType=media",{method:"PATCH",headers:new Headers({Authorization:"Bearer "+gapi.auth.getToken().access_token,"Content-type":"plain/text; charset=utf-8"}),body:editor.getValue()}).then(e=>{console.log("File updated successfully"),app.toast.message("Google Driver","File updated successfully").show();d.q("[data-cmd-as=save]")}).catch(e=>{console.error(e),app.toast.message("Error Google Driver",e.message).show()})}catch(e){app.toast.message("Error Google Driver",e.message).show()}}function gdDeleteFile(t){var e=t.parentElement.getAttribute("data-id");t.innerHTML="...",gapi.client.drive.files.delete({fileId:e}).execute(function(e){console.log("File Deleted"),t.innerHTML="Delete",expandContainer.style.display="none",expandContainerUl.setAttribute("data-id",""),expandContainerUl.setAttribute("data-name",""),showList()})}window.gdExpand=gdExpand,window.cacheFiles="",window.readEditDownload=readEditDownload,window.gdRenameFile=function(){try{var e,t;""!=editor.id&&(e=editor.id,t={name:fileName.innerText.trim()},gapi.client.drive.files.update({fileId:e,resource:t}).execute(function(e){editor.id=e.id,d.q("[data-cmd-as=save]").setAttribute("onClick","gdUpdate()"),showList(),app.toast.message("Google Driver","Rename successfully").show()}))}catch(e){app.toast.message("Error Google Driver",e.message).show()}},window.gdUpdate=gdUpdate,window.gdDeleteFile=gdDeleteFile,exports.gDriveScript=function(e,t,n){editor=e,app=n,signinButton=document.getElementsByClassName("signin")[0],signoutButton=document.getElementsByClassName("signout")[0],expandContainer=document.querySelector(".expand-container"),expandContainerUl=document.querySelector(".expand-container ul"),listcontainer=document.querySelector(".list ul"),signinButton.onclick=()=>handleAuthClick(),signoutButton.onclick=()=>handleSignoutClick(),gapiLoaded(),gisLoaded()};