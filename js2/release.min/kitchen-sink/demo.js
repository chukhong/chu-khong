"use strict";require("ace/ext/rtl"),require("ace/multi_select"),require("./inline_editor");var devUtil=require("./dev_util"),config=(require("./file_drop"),require("ace/config")),env=(config.setLoader(function(e,n){require([e],function(e){n(null,e)})}),{}),dom=require("ace/lib/dom"),net=require("ace/lib/net"),lang=require("ace/lib/lang"),event=require("ace/lib/event"),theme=require("ace/theme/textmate"),EditSession=require("ace/edit_session").EditSession,UndoManager=require("ace/undomanager").UndoManager,HashHandler=require("ace/keyboard/hash_handler").HashHandler,Renderer=require("ace/virtual_renderer").VirtualRenderer,Editor=require("ace/editor").Editor,whitespace=require("ace/ext/whitespace"),doclist=require("./doclist"),layout=require("./layout"),util=require("./util"),saveOption=util.saveOption,ElasticTabstopsLite=require("ace/ext/elastic_tabstops_lite").ElasticTabstopsLite,IncrementalSearch=require("ace/incremental_search").IncrementalSearch,TokenTooltip=require("./token_tooltip").TokenTooltip,workerModule=(require("ace/config").defineOptions(Editor.prototype,"editor",{showTokenInfo:{set:function(e){e?this.tokenTooltip=this.tokenTooltip||new TokenTooltip(this):this.tokenTooltip&&(this.tokenTooltip.destroy(),delete this.tokenTooltip)},get:function(){return!!this.tokenTooltip},handlesSet:!0}}),require("ace/worker/worker_client")),container=(-1!==location.href.indexOf("noworker")&&(workerModule.WorkerClient=workerModule.UIWorkerClient),document.getElementById("editor-container")),Split=require("ace/split").Split,split=new Split(container,theme,1),consoleEl=(env.editor=split.getEditor(0),split.on("focus",function(e){env.editor=e,updateUIEditorOptions()}),env.split=split,window.env=env,dom.createElement("div")),cmdLine=(container.parentNode.appendChild(consoleEl),consoleEl.style.cssText="position:fixed; bottom:1px; right:0;border:1px solid #baf; z-index:100",new layout.singleLineEditor(consoleEl)),commands=(cmdLine.setOption("placeholder","Enter a command..."),cmdLine.editor=env.editor,env.editor.cmdLine=cmdLine,env.editor.showCommandLine=function(e){this.cmdLine.focus(),"string"==typeof e&&this.cmdLine.setValue(e,1)},env.editor.commands.addCommands([{name:"snippet",bindKey:{win:"Alt-C",mac:"Command-Alt-C"},exec:function(e,n){"object"==typeof n?(e.cmdLine.setValue("snippet ",1),e.cmdLine.focus()):(n=snippetManager.getSnippetByName(n,e))&&snippetManager.insertSnippet(e,n.content)},readOnly:!0},{name:"focusCommandLine",bindKey:"shift-esc|ctrl-`",exec:function(e,n){e.cmdLine.focus()},readOnly:!0},{name:"nextFile",bindKey:"Ctrl-tab",exec:function(e){doclist.cycleOpen(e,1)},readOnly:!0},{name:"previousFile",bindKey:"Ctrl-shift-tab",exec:function(e){doclist.cycleOpen(e,-1)},readOnly:!0},{name:"execute",bindKey:"ctrl+enter",exec:function(e){try{var n=window.eval(e.getCopyText()||e.getValue())}catch(e){n=e}e.cmdLine.setValue(n+"")},readOnly:!0},{name:"showKeyboardShortcuts",bindKey:{win:"Ctrl-Alt-h",mac:"Command-Alt-h"},exec:function(n){config.loadModule("ace/ext/keybinding_menu",function(e){e.init(n),n.showKeyboardShortcuts()})}},{name:"increaseFontSize",bindKey:"Ctrl-=|Ctrl-+",exec:function(e){var n=parseInt(e.getFontSize(),10)||12;e.setFontSize(n+1)}},{name:"decreaseFontSize",bindKey:"Ctrl+-|Ctrl-_",exec:function(e){var n=parseInt(e.getFontSize(),10)||12;e.setFontSize(Math.max(n-1||1))}},{name:"resetFontSize",bindKey:"Ctrl+0|Ctrl-Numpad0",exec:function(e){e.setFontSize(12)}}]),env.editor.commands.addCommands(whitespace.commands),cmdLine.commands.bindKeys({"Shift-Return|Ctrl-Return|Alt-Return":function(e){e.insert("\n")},"Esc|Shift-Esc":function(e){e.editor.focus()},Return:function(e){var n=e.getValue().split(/\s+/),e=e.editor;e.commands.exec(n[0],e,n[1]),e.focus()}}),cmdLine.commands.removeCommands(["find","gotoline","findall","replace","replaceall"]),env.editor.commands);function handleToggleActivate(e){dom.hasCssClass(sidePanelContainer,"closed")?onResize(null,!1):dom.hasCssClass(e,"toggleButton")&&onResize(null,!0)}commands.addCommand({name:"save",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(e){var n=env.editor.session,t=n.name.match(/[^\/]+$/);localStorage.setItem("saved_file:"+t,n.getValue()),env.editor.cmdLine.setValue("saved "+t)}}),commands.addCommand({name:"load",bindKey:{win:"Ctrl-O",mac:"Command-O"},exec:function(e){var n=env.editor.session,t=n.name.match(/[^\/]+$/),i=localStorage.getItem("saved_file:"+t);"string"==typeof i?(n.setValue(i),env.editor.cmdLine.setValue("loaded "+t)):env.editor.cmdLine.setValue("no previuos value saved for "+t)}});var sidePanelContainer=document.getElementById("sidePanel"),optionToggle=(sidePanelContainer.onclick=function(e){handleToggleActivate(e.target)},document.getElementById("optionToggle")),consoleHeight=(optionToggle.onkeydown=function(e){"Space"!==e.code&&"Enter"!==e.code||handleToggleActivate(e.target)},20);function onResize(e,n){var t=280,i=document.documentElement.clientWidth,o=document.documentElement.clientHeight;(n=null==n?i<2*t:n)?(t=20,document.getElementById("optionToggle").setAttribute("aria-label","Show Options")):document.getElementById("optionToggle").setAttribute("aria-label","Hide Options"),container.style.width=(i-=t)+"px",container.style.height=o-consoleHeight+"px",container.style.left=t+"px",env.split.resize(),consoleEl.style.width=i+"px",consoleEl.style.left=t+"px",cmdLine.resize(),sidePanel.style.width=t+"px",sidePanel.style.height=o+"px",dom.setCssClass(sidePanelContainer,"closed",n)}(window.onresize=onResize)(),doclist.history=doclist.docs.map(function(e){return e.name}),doclist.history.index=0,doclist.cycleOpen=function(e,n){var t=this.history,n=(t.index+=n,t.index>=t.length?t.index=0:t.index<=0&&(t.index=t.length-1),t[t.index]);doclist.pickDocument(n)},doclist.addToHistory=function(e){var n=this.history,t=n.indexOf(e);t!=n.index&&(-1!=t&&n.splice(t,1),n.index=n.push(e))},doclist.pickDocument=function(e){doclist.loadDoc(e,function(e){e&&(doclist.addToHistory(e.name),e=env.split.setSession(e),whitespace.detectIndentation(e),optionsPanel.render(),env.editor.focus())})};var i,OptionPanel=require("ace/ext/options").OptionPanel,optionsPanel=new OptionPanel(env.editor),optionsPanelContainer=(optionsPanel.add({Main:{Document:{type:"select",path:"doc",items:doclist.all,position:-101,onchange:doclist.pickDocument,getValue:function(){return env.editor.session.name||"javascript"}},Split:{type:"buttonBar",path:"split",values:["None","Below","Beside"],position:-100,onchange:function(e){var n,t=env.split;"Below"==e||"Beside"==e?(n=1==t.getSplits(),t.setOrientation("Below"==e?t.BELOW:t.BESIDE),t.setSplits(2),n&&(e=t.getEditor(0).session,t.setSession(e,1).name=e.name)):t.setSplits(1)},getValue:function(){var e=env.split;return 1==e.getSplits()?"None":e.getOrientation()==e.BELOW?"Below":"Beside"}}},More:{RTL:{path:"rtl",position:900},"Line based RTL switching":{path:"rtlText",position:900},"Show token info":{path:"showTokenInfo",position:2e3},"Show Textarea Position":devUtil.textPositionDebugger,"Text Input Debugger":devUtil.textInputDebugger}}),document.getElementById("optionsPanel"));function updateUIEditorOptions(){optionsPanel.editor=env.editor,optionsPanel.render()}for(i in optionsPanel.render(),optionsPanelContainer.insertBefore(optionsPanel.container,optionsPanelContainer.firstChild),optionsPanel.on("setOption",function(e){util.saveOption(e.name,e.value)}),optionsPanel.setOption("doc",util.getOption("doc")||"JavaScript"),optionsPanel.options){var value=util.getOption(i);null!=value&&("mode"!=i&&"theme"!=i||/[/]/.test(value)||(value="ace/"+i+"/"+value),optionsPanel.setOption(i,value))}function synchroniseScrolling(){var n=env.split.$editors[0].session,t=env.split.$editors[1].session;n.on("changeScrollTop",function(e){t.setScrollTop(e)}),t.on("changeScrollTop",function(e){n.setScrollTop(e)}),n.on("changeScrollLeft",function(e){t.setScrollLeft(e)}),t.on("changeScrollLeft",function(e){n.setScrollLeft(e)})}var StatusBar=require("ace/ext/statusbar").StatusBar,Emmet=(new StatusBar(env.editor,cmdLine.container),require("ace/ext/emmet")),snippetManager=(net.loadScript("https://cloud9ide.github.io/emmet-core/emmet.js",function(){Emmet.setCore(window.emmet),env.editor.setOption("enableEmmet",!0)}),require("ace/placeholder").PlaceHolder,require("ace/snippets").snippetManager),beautify=(env.editSnippets=function(){var e,n,t,i,o=env.split;2==o.getSplits()?o.setSplits(1):(o.setSplits(1),o.setSplits(2),o.setOrientation(o.BESIDE),e=o.$editors[1],n=o.$editors[0].session.$mode.$id||"",t=snippetManager.files[n],doclist["snippets/"+n]||(i=t.snippetText,(i=doclist.initDoc(i,"",{})).setMode("ace/mode/snippets"),doclist["snippets/"+n]=i),e.on("blur",function(){t.snippetText=e.getValue(),snippetManager.unregister(t.snippets),t.snippets=snippetManager.parseSnippetFile(t.snippetText,t.scope),snippetManager.register(t.snippets)}),o.$editors[0].once("changeMode",function(){o.setSplits(1)}),e.setSession(doclist["snippets/"+n],1),e.focus())},optionsPanelContainer.insertBefore(dom.buildDom(["div",{style:"text-align:right;margin-right: 60px"},["div",{},["button",{onclick:env.editSnippets},"Edit Snippets"]],["div",{},["button",{onclick:function(){var e=navigator.platform+"\n"+navigator.userAgent;if(env.editor.getValue()==e)return env.editor.undo();env.editor.setValue(e,-1),env.editor.setOption("wrap",80)}},"Show Browser Info"]],devUtil.getUI()]),optionsPanelContainer.children[1]),require("ace/ext/language_tools"),env.editor.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0}),require("ace/ext/beautify")),KeyBinding=(env.editor.commands.addCommands(beautify.commands),require("ace/keyboard/keybinding").KeyBinding),CommandManager=require("ace/commands/command_manager").CommandManager,commandManager=new CommandManager,kb=new KeyBinding({commands:commandManager,fake:!0});function moveFocus(){(document.activeElement==env.editor.textInput.getElement()?env.editor.cmdLine:env.editor).focus()}event.addCommandKeyListener(document.documentElement,kb.onCommandKey.bind(kb)),event.addListener(document.documentElement,"keyup",function(e){18===e.keyCode&&e.preventDefault()}),commandManager.addCommands([{name:"window-left",bindKey:{win:"cmd-alt-left",mac:"ctrl-cmd-left"},exec:function(){moveFocus()}},{name:"window-right",bindKey:{win:"cmd-alt-right",mac:"ctrl-cmd-right"},exec:function(){moveFocus()}},{name:"window-up",bindKey:{win:"cmd-alt-up",mac:"ctrl-cmd-up"},exec:function(){moveFocus()}},{name:"window-down",bindKey:{win:"cmd-alt-down",mac:"ctrl-cmd-down"},exec:function(){moveFocus()}}]);