var editor,logEditor,logSession,ace=require("ace/ace"),dom=require("ace/lib/dom"),event=require("ace/lib/event"),Range=require("ace/range").Range,EditSession=require("ace/edit_session").EditSession,UndoManager=require("ace/undomanager").UndoManager;function def(t,o,e){try{Object.defineProperty(t,o,{configurable:!0,get:e,set:function(e){delete t[o],t[o]=e}})}catch(e){console.error(e)}}function getSelection(e){e=e.multiSelect.toJSON();return 1<(e=(e=e.length?e:[e]).map(function(e){var t,o;return e.isBackwards?(t=e.end,o=e.start):(o=e.end,t=e.start),Range.comparePoints(t,o)?[t.row,t.column,o.row,o.column]:[t.row,t.column]})).length?e:e[0]}function setSelection(e,t){"number"==typeof t[0]&&(t=[t]),e.selection.fromJSON(t.map(function(e){var t={row:e[0],column:e[1]},e=2==e.length?t:{row:e[2],column:e[3]};return 0<Range.comparePoints(t,e)?{start:e,end:t,isBackwards:!0}:{start:t,end:e,isBackwards:!0}}))}function testSelection(e,t){assert.equal(getSelection(e)+"",t+"")}function setValue(e,t){e.setValue(t,1)}function testValue(e,t){assert.equal(e.getValue(),t)}def(window,"ace",function(){return ace}),def(window,"editor",function(){return window.env.editor==logEditor?editor:window.env.editor}),def(window,"session",function(){return window.editor.session}),def(window,"split",function(){return window.env.split}),def(window,"devUtil",function(){return exports}),exports.addGlobals=function(){window.oop=require("ace/lib/oop"),window.dom=require("ace/lib/dom"),window.user=require("ace/test/user"),window.Range=require("ace/range").Range,window.Editor=require("ace/editor").Editor,window.assert=require("ace/test/asyncjs/assert"),window.asyncjs=require("ace/test/asyncjs/async"),window.UndoManager=require("ace/undomanager").UndoManager,window.EditSession=require("ace/edit_session").EditSession,window.MockRenderer=require("ace/test/mockrenderer").MockRenderer,window.EventEmitter=require("ace/lib/event_emitter").EventEmitter,window.getSelection=getSelection,window.setSelection=setSelection,window.testSelection=testSelection,window.setValue=setValue,window.testValue=testValue,window.logToAce=exports.log},exports.openLogView=function(){exports.addGlobals();var e=window.env.split;e.setSplits(1),e.setSplits(2),e.setOrientation(e.BESIDE),editor=e.$editors[0],logEditor=e.$editors[1],logSession||(logSession=new EditSession(localStorage.lastTestCase||"","ace/mode/javascript")).setUndoManager(new UndoManager),logEditor.setSession(logSession),logEditor.session.foldAll(),logEditor.on("input",save)},exports.record=function(){exports.addGlobals(),exports.openLogView(),logEditor.setValue('var Range = require("ace/range").Range;\n'+getSelection+"\n"+testSelection+"\n"+setSelection+"\n"+testValue+"\n"+setValue+"\n\n//-------------------------------------\n",1),logEditor.session.foldAll(),addAction({type:"setValue",data:editor.getValue()}),addAction({type:"setSelection",data:getSelection(editor)}),editor.commands.on("afterExec",onAfterExec),editor.on("mouseup",onMouseUp),editor.selection.on("beforeEndOperation",onBeforeEndOperation),editor.session.on("change",reportChange),editor.selection.on("changeCursor",reportCursorChange),editor.selection.on("changeSelection",reportSelectionChange)},exports.stop=function(){save(),editor.commands.off("afterExec",onAfterExec),editor.off("mouseup",onMouseUp),editor.off("beforeEndOperation",onBeforeEndOperation),editor.session.off("change",reportChange),editor.selection.off("changeCursor",reportCursorChange),editor.selection.off("changeSelection",reportSelectionChange),logEditor.off("input",save)},exports.closeLogView=function(){exports.stop(),window.env.split.setSplits(1)},exports.play=function(){exports.openLogView(),exports.stop();var e=logEditor?logEditor.getValue():localStorage.lastTestCase;new Function("editor","debugger;\n"+e)(editor)};var reportChange=reportEvent.bind(null,"change"),reportCursorChange=reportEvent.bind(null,"CursorChange"),reportSelectionChange=reportEvent.bind(null,"SelectionChange");function save(){localStorage.lastTestCase=logEditor.getValue()}function reportEvent(e){addAction({type:"event",source:e})}function onSelection(){addAction({type:"event",data:"change",source:"operationEnd"})}function onBeforeEndOperation(){addAction({type:"setSelection",data:getSelection(editor),source:"operationEnd"})}function onMouseUp(){addAction({type:"setSelection",data:getSelection(editor),source:"mouseup"})}function onAfterExec(e){addAction({type:"exec",data:e}),addAction({type:"value",data:editor.getValue()}),addAction({type:"selection",data:getSelection(editor)})}function addAction(e){e=toString(e);e&&(logEditor.insert(e+"\n"),logEditor.renderer.scrollCursorIntoView())}var lastValue="";function toString(e){var t="",o=e.data;switch(e.type){case"exec":t='editor.execCommand("'+o.command.name+(o.args?'", '+JSON.stringify(o.args):'"')+")";break;case"setSelection":t="setSelection(editor, "+JSON.stringify(o)+")";break;case"setValue":if(lastValue==o)return;lastValue=o,t="editor.setValue("+JSON.stringify(o)+", -1)";break;case"selection":t="testSelection(editor, "+JSON.stringify(o)+")";break;case"value":if(lastValue==o)return;lastValue=o,t="testValue(editor, "+JSON.stringify(o)+")"}return t+(e.source?" // "+e.source:"")}var ignoreEvents=!(exports.getUI=function(e){return["div",{role:"group","aria-label":"Test"}," Test ",["button",{"aria-label":"Open Log View",onclick:exports.openLogView},"O"],["button",{onclick:exports.record},"Record"],["button",{onclick:exports.stop},"Stop"],["button",{onclick:exports.play},"Play"],["button",{"aria-label":"Close Log View",onclick:exports.closeLogView},"X"]]});exports.textInputDebugger={position:2e3,path:"textInputDebugger",onchange:function(e){var t=env.split;2==t.getSplits()&&t.setSplits(1),env.textarea&&(env.textarea.detach&&env.textarea.detach(),env.textarea.oldParent.appendChild(env.textarea),env.textarea.className=env.textarea.oldClassName,env.textarea=null),e&&this.showConsole()},showConsole:function(){function t(e){ignoreEvents||(e={_:e.type,data:e.data,inputType:e.inputType,range:[n.selectionStart,n.selectionEnd],value:n.value,key:e.key&&{code:e.code,key:e.key,keyCode:e.keyCode},modifier:event.getModifierString(e)||void 0},e=JSON.stringify(e).replace(/"(\w+)":/g," $1: "),exports.log(e))}var o=env.split.$editors[0],n=o.textInput.getElement(),e=(n.oldParent=n.parentNode,n.oldClassName=n.className,n.className="text-input-debug",document.body.appendChild(n),env.textarea=n,["select","input","keypress","keydown","keyup","compositionstart","compositionupdate","compositionend","cut","copy","paste"]);function r(e){e.domEvent.target==n&&(e.$pos=o.getCursorPosition())}e.forEach(function(e){n.addEventListener(e,t,!0)}),n.detach=function(){delete n.value,delete n.setSelectionRange,e.forEach(function(e){n.removeEventListener(e,t,!0)}),o.off("mousedown",r)},o.on("mousedown",r),n.__defineSetter__("value",function(e){this.__proto__.__lookupSetter__("value").call(this,e),console.log(e)}),n.__defineGetter__("value",function(e){return this.__proto__.__lookupGetter__("value").call(this)}),n.setSelectionRange=function(e,t){ignoreEvents=!0,this.__proto__.setSelectionRange.call(this,e,t),ignoreEvents=!1},exports.openConsole(),o.focus()},getValue:function(){return!!env.textarea}},exports.textPositionDebugger={position:2e3,path:"textPositionDebugger",onchange:function(e){document.body.classList[e?"add":"remove"]("show-text-input")},getValue:function(){return document.body.classList.contains("show-text-input")}},exports.openConsole=function(){var e=env.split,t=e.$editors[1];return t||(e.setSplits(2),e.setOrientation(e.BELOW),t=e.$editors[1]),exports.session||(exports.session=new EditSession("")),t.setSession(exports.session),t},exports.log=function(e){var t=exports.openConsole();t.navigateFileEnd(),t.insert(e+",\n"),t.renderer.scrollCursorIntoView()},exports.addGlobals();