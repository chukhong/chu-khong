var sms={log:function(e){postMessage(e)},error:function(e){postMessage("Error: "+e)}},catcheFile=(importScripts("jszip.min.js"),importScripts("dictzip_sync.js"),importScripts("dictzip.js"),importScripts("inflate.js"),importScripts("pako_inflate.js"),importScripts("stardict_sync.js"),{}),readUTF8String=function(){var t=new TextDecoder("utf-8");return function(e){return t.decode(e)}}(),countLoad=1,countPartLoad=1;function processPartPercent(e,t){e=100*countPartLoad/e/(100*countLoad/t),t=100*(countLoad-1)/t;sms.log({fn:"percentLoad",data:t+e+"%"}),countPartLoad++}function processPercent(e){e=100*countLoad/e;sms.log({fn:"percentLoad",data:e+"%"}),countLoad++}function handleFile(i,o){var c=i.name.replace(/\W/g,""),s={fileName:i.name,fileContent:[]},d=new Date;JSZip.loadAsync(i).then(async function(e){e.forEach(function(e,t){s.fileContent.push(t.name)}),sms.log({fn:"showStatus",data:"Unzip "+i.name});e.files;var t,n=[];for(t in countPartLoad=1,await e.files){var r=await e.file(t).async("Blob");r.name=t,processPartPercent(s.fileContent.length,o),sms.log({fn:"showStatus",data:"Unzip "+t}),n.push(r)}doStardict(n,c),processPercent(o);var a=new Date;s.timeLoad=" (loaded in "+(a-d)+"ms)",sms.log({fn:"builtDataFromJszip",data:s})},function(e){console.error(e),sms.error("Error reading "+i.name+": "+e.message)})}function doStardict(e,t){var n,r=e.find(e=>{if(-1!=e.name.toLocaleLowerCase().indexOf("dict.dz"))return e});r||(n=readFileDictAsText(n=e.find(e=>{if(-1!=e.name.toLocaleLowerCase().indexOf(".dict"))return e}))),catcheFile[t]||(catcheFile[t]={}),catcheFile[t]=e;try{var a=new StarDict(e),i=[],o=[],c=a.synonyms({include_offset:!0,include_wid:!0,include_term:!0}),s=(sms.log({fn:"showStatus",data:"Processing synonym offsets..."}),c.forEach(function(e){i.push(e.offset)}),delete c,a.index({include_offset:!0,include_dictpos:!0,include_term:!0})),d=(sms.log({fn:"showStatus",data:"Processing index offsets..."}),s.forEach(function(e){o.push(e.offset)}),catcheFile[t]={raw_index:s,dictDZ:r,dictFile:n,target:t},catcheFile[t]),l={raw_index:d.raw_index,target:d.target};sms.log({fn:"preLoadWords",data:l})}catch(e){console.error(e),console.error("StarDict error: "+e.message)}}function dzreaderLoad(e,t,n=!1){var r=new DictZipFile(e,jszlib_inflate_buffer);r.load().then(function(){return r.read(t[0],t[1])},function(e){console.error(e),console.error("DictZipFile load error: "+e.message)}).then(function(e){e=new Uint8Array(e),e=readUTF8String(e).replace(/\r\n|\r|\n/g,"<br>");sms.log({fn:"getMeaning",data:{data:e,append:n}})},function(e){console.error("DictZipFile read error: "+e.message)})}async function readFileDictAsText(r){this.load=function(){return new Promise(function(t,n){var e=new FileReader;e.onload=function(e){try{return t(e.target.result)}catch(e){n(e)}},e.readAsArrayBuffer(r)})};var e=new File([r],"tmp.dict");return this.load(e)}function doFileDict(e,t,n=!1,r){e.then(e=>{e=e.slice(t[0],t[0]+t[1]),e=readUTF8String(e);sms.log({fn:"getMeaning",data:{data:e,append:n,dictName:r}})})}var eventReceiver={loadList:function(e){try{console.log(e);for(var t=0;t<e.length;t++)handleFile(e[t],e.length)}catch(e){console.error(e),sms.error("jszip error: "+e.message)}},loadWordList:function(e){var e=e.name.replace(/\W/g,""),e=catcheFile[e];e&&0!=e.length&&(e={raw_index:e.raw_index,target:e.target},sms.log({fn:"preLoadWords",data:e}))},findMeaning:function(e,t=!1){var{dictpos:e,target:n}=e,r=catcheFile[n].dictDZ,a=catcheFile[n].dictFile;r&&dzreaderLoad(r,e,t),a&&doFileDict(a,e,t,n)},findWord:function(e){var r=[];for(target in this.selectTypeDZorDictFile=function(e){return e.dictDZ||e.dictFile},this.search=function(e,t,n){e=e.raw_index.find(e=>{if(e.term==t)return e});e&&(e.target=n,r=r.concat(e))},catcheFile)this.search(catcheFile[target],e,target);0!==r.length&&r.map(e=>{eventReceiver.findMeaning(e,!0)}),sms.log({fn:"getFindWord",data:r})}};onmessage=function(e){e=e.data;try{eventReceiver[e.fn](e.data)}catch(e){console.error(e)}};